<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Emergency Alert System</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Rubik', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f6fa;
        color: #2c3e50;
      }
    
      .container {
        display: flex;
        gap: 20px;
        padding: 20px;
        min-height: calc(100vh - 40px);
      }
    
      /* Log container - thick light blue border */
#log-container {
  width: 35%;
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border: 2px solid #5DADE2;      /* Light blue border */
  max-height: calc(100vh - 40px);
  display: flex;
  flex-direction: column;
}

      #log-list {
        flex: 1;
        overflow-y: auto;
        scroll-behavior: smooth;
        padding-right: 8px;
      }

      /* Custom scrollbar for log list */
      #log-list::-webkit-scrollbar {
        width: 6px;
      }

      #log-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }

      #log-list::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }

      #log-list::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    
      /* Steps container - thick light blue border */
#steps-container {
  width: 65%;
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border: 2px solid #5DADE2;      /* Light blue border */
}

      /* Individual step containers - lighter blue border */
      .step {
        margin-bottom: 24px;
        border: 1px solid #5DADE2;      /* Lighter blue shade */
        padding: 16px;
        border-radius: 10px;
        background-color: #f9fbfd;
      }
    
      .step h3 {
        margin-top: 0;
        font-size: 18px;
        font-weight: 600;
      }
    
      /* Dropdowns - light blue background + dashed border */
      select {
        display: block;
        margin-top: 10px;
        margin-bottom: 8px;
        width: 100%;
        padding: 8px;
        font-size: 14px;
        font-family: 'Rubik', sans-serif;
        background-color: #f8fafc;
        border: 2px dashed #6b7280;
        border-radius: 6px;
        min-height: 60px;
        box-sizing: border-box;
      }
    
      /* Textareas - white background + solid border */
      textarea {
        display: block;
        margin-top: 10px;
        margin-bottom: 8px;
        width: 100%;
        padding: 8px;
        font-size: 14px;
        font-family: 'Rubik', sans-serif;
        background-color: #ffffff;
        border: 2px solid #9ca3af;
        border-radius: 6px;
        resize: vertical;
        min-height: 60px;
        box-sizing: border-box;
      }
    
      .completed-step {
        border-color: #28a745;
        background-color: #e8f5e9;
      }
    
      .log-entry {
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
      }
    
      .log-timestamp {
        display: inline;
        font-size: 12px;
        color: #999;
        margin-right: 8px;
      }
    
      .log-content {
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
    
      .log-operator {
        margin-left: auto;
        font-size: 12px;
        color: #666;
      }
    
      .step-badge {
        background-color: #007bff;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 12px;
        white-space: nowrap;
      }
    
      .step-status {
        background-color: #ffc107;
        color: #000;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        float: right;
      }
    
      .completed-step .step-status {
        background-color: #28a745;
        color: white;
      }
    
      .timer-box {
        background-color: #fff3cd;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
    
      .timer-box.timer-expired {
        background-color: #f8d7da;
      }
    
      .timer-box span {
        font-weight: bold;
      }
    
      .highlighted {
        border: 2px dashed #ffc107;
      }
    
      button:disabled {
        background-color: #ccc !important;
        cursor: not-allowed;
      }
    
      select:disabled,
      textarea:disabled {
        background-color: #f0f0f0;
      }
    
      #resolution-section {
        margin-top: 20px;
      }
    
      .section-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
      }
    
      .user-info-tile {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 8px 12px;
        margin: 8px 0;
        display: flex;
        gap: 16px;
        font-size: 14px;
        color: #495057;
      }
    
      .user-name,
      .user-phone {
        display: flex;
        align-items: center;
        gap: 4px;
      }
    
      .user-info-tile .user-phone {
        font-family: monospace;
      }
    
      .ec-info-tile {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 8px 12px;
        margin: 8px 0;
        display: flex;
        gap: 16px;
        font-size: 14px;
        color: #856404;
      }
    
      .ec-name,
      .ec-phone,
      .ec-role {
        display: flex;
        align-items: center;
        gap: 4px;
      }
    
      .ec-info-tile .ec-phone {
        font-family: monospace;
      }
    
      .ec-role {
        font-style: italic;
        opacity: 0.8;
      }
    
      /* Step 4 subsection borders */
      .step-subsection {
        background: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 12px;
      }
    
      /* Info box font fix */
      .step div[style*="background: #e3f2fd"] {
        font-family: 'Rubik', sans-serif !important;
        font-size: 14px !important;
      }
    
      /* Log placeholder same size as textareas */
      #log-placeholder {
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        margin: 8px 0;
        color: #adb5bd;
        font-style: normal;
        text-align: center;
        padding: 20px;
        font-size: 14px;
        font-family: 'Rubik', sans-serif;
      }
    
      /* Bigger buttons - step/post buttons */
      .step-button,
      .post-note-button {
        background-color: #0075c9;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 10px 20px;
        cursor: pointer;
        font-weight: 500;
        font-size: 15px;
        font-family: 'Rubik', "Segoe UI", Roboto, Arial, sans-serif;
        height: 40px;
        width: auto;
        display: inline-block;
        margin-top: 6px;
        margin-bottom: 6px;
        transition: all 0.2s ease;
      }
    
      .post-note-button {
        background-color: #28a745;
      }
    
      .step-button:hover,
      .post-note-button:hover {
        opacity: 0.9;
      }

      /* Disabled button state */
      .step-button:disabled,
      .post-note-button:disabled {
        background-color: #6c757d !important;
        opacity: 0.6;
        cursor: not-allowed;
      }
    
      /* Bigger buttons - resolution and log buttons */
      .resolve-button,
      .cancel-resolution-button,
      .add-note-button {
        border: none;
        border-radius: 20px;
        padding: 10px 20px;
        cursor: pointer;
        font-weight: 500;
        font-size: 15px;
        font-family: 'Rubik', "Segoe UI", Roboto, Arial, sans-serif;
        height: 40px;
        width: auto;
        display: inline-block;
        margin-top: 6px;
        margin-bottom: 6px;
        transition: background-color 0.2s ease;
      }
    
      .resolve-button {
        background-color: #d32f2f;
        color: white;
      }
    
      .cancel-resolution-button {
        background-color: #5c636a;
        color: white;
      }
    
      .add-note-button {
        background-color: #28a745;
        color: white;
      }
    
      .resolve-button:hover,
      .cancel-resolution-button:hover,
      .add-note-button:hover {
        opacity: 0.9;
      }

      /* ✅ ALERT RESOLVED STATE - GREY OUT EVERYTHING */
      body.alert-resolved .step:not(#resolution-section) {
        opacity: 0.5;
        pointer-events: none;
        background: #f8f9fa !important;
        border-color: #dee2e6 !important;
      }

      /* Keep manual note button active when resolved */
      body.alert-resolved .add-note-button {
        opacity: 1;
        pointer-events: auto;
      }

      /* Keep cancel resolution button active */
      body.alert-resolved .cancel-resolution-button {
        opacity: 1;
        pointer-events: auto;
      }
</style>
  </head>
  
  <body>
    <div class="container">
      <!-- Log Column -->
      <div id="log-container">
        <h2>Protocol Log</h2>
        <div id="log-list">
          <div id="log-placeholder" style="color: #adb5bd; font-style: normal; text-align: center; padding: 20px; font-size: 14px; font-family: 'Rubik', sans-serif;">
            No log entries yet. Actions will appear here as you progress through the steps.
          </div>
        </div>
        
    
        <!-- Manual Log Section -->
        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 16px;">
          <button class="add-note-button" onclick="addManualNote()" data-cy="add-manual-note-btn">
            ➕ Add Manual Note
          </button>
          
          
          <div id="manual-log-section" style="display: none; margin-top: 10px;">
            <textarea id="manual-log-textarea" rows="3" placeholder="Enter manual note..." style="width: 100%; resize: vertical; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
            <div style="margin-top: 8px;">
              <button onclick="submitManualNote()" style="background-color: #28a745; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">✅ Submit Note</button>
              <button onclick="cancelManualNote()" style="margin-left: 8px; background-color: #6c757d; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">❌ Cancel</button>
            </div>
          </div>
        </div>
      </div>
    
      <!-- Steps Column -->
      <div id="steps-container">
        <!-- Step 1 -->
        <div id="step-1" class="step" data-cy="step-1">
          <div class="step-title">
            <span class="completion-checkmark" data-cy="step-1-checkmark">✅</span>
            <strong>STEP 1: Call the G7c device and validate the need for assistance.</strong>
            <span class="step-status" data-cy="step-1-status">Pending</span>
          </div>
    
          <button
            class="step-button"
            data-cy="step-1-action"
            onclick="prefillDeviceCallNote()"
          >
            📞 Call G7c Device
          </button>
    
          <select
  id="outcome-1"
  data-cy="outcome-1"
  onchange="insertStep1Outcome()"
  style="margin-top: 8px"
>
  <option value="">Select outcome</option>
  <option value="No answer. ">No answer.</option>
  <option value="Unable to connect. Device offline. ">Unable to connect. Device offline.</option>
  <option value="DYNAMIC_USER_OK_RESOLVE">Spoke with {User Name}. Confirmed they are OK. Resolving alert.</option>
</select>
    
          <textarea
            id="step-1-note"
            data-cy="step-1-note"
            placeholder="Document the result..."
            style="margin-top: 8px"
          ></textarea>
    
          <button
            class="post-note-button"
            data-cy="step-1-post"
            onclick="postNote(1)"
            style="margin-top: 8px"
          >
            ✅ Post Note
          </button>
        </div>
    
        <!-- Step 2 -->
        <div id="step-2" class="step" data-cy="step-2">
          <div class="step-title">
            <span class="completion-checkmark" data-cy="step-2-checkmark">✅</span>
            <strong>STEP 2: Send a message to the G7c device: "Do you need help?", wait 2 minutes</strong>
            <span class="step-status" data-cy="step-2-status">Pending</span>
          </div>
    
          <button
            class="step-button"
            data-cy="step-2-action"
            onclick="handleStep2()"
          >
            💬 Send Message
          </button>
    
          <textarea
            id="step-2-note"
            data-cy="step-2-note"
            placeholder="Document the result..."
            style="margin-top: 8px"
          ></textarea>
    
          <button
            class="post-note-button"
            data-cy="step-2-post"
            onclick="postNote(2)"
            style="margin-top: 8px"
          >
            ✅ Post Note
          </button>
    
          <!-- Step 2 Timer -->
          <div
            id="step-2-timer-container"
            class="timer-box"
            data-cy="step-2-timer-box"
            style="display: none; margin-top: 16px"
          >
            <span>⏱️ Message timer:
              <span id="step-2-countdown" data-cy="step-2-countdown">02:00</span>
            </span>
            <button id="step-2-cancel-timer" onclick="cancelStep2Timer()">Cancel Timer</button>
          </div>
    
          <!-- Step 2 Alert Sound -->
          <audio id="step-2-alert-sound" preload="auto">
            <source src="data:audio/wav;base64,UklGRlYEAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YTIEAADCwcJXws/BF8TJwUnIzcVZysrFWc7AxCTQqsKN0oW/W9VxuzvYbrf/2nO19d1MswffRrFh4lqvjeRetJfjDrKf5XevOedcrSromqqQ6f+nnOuIpNPsw6E/7lWg7e3hniPwAZ7y8ECdLPIOnGrzPpsS9HOaAfVFmQT25ZcM9yOXHPc3lgD3KpUK9+mULfawlHT2UJTb9dCUYfU8lej0p5Vm9CmWn/Ozltf0jJb19I6Wk/Qxl1z0vpd69FaY5vMemdzzDpov8wCbL/MEm9fy8pvT8fqcd/Gjnh3wWqA273qi8+2cpGHsNacy6xSqO+nDrMHmVrCA5MS4F+MLvHnhJL6B30vArt062GTC4dXBxNHSG8j6zxPKBM1HzODJTc7Nxl7QPsQP0j3CddPywGDV6L/G1gS/c9hgvnPZ5b2U2nG+ENv7vdTay70Q3Om80Nx5vJTdKbxh3oq76N4Tu1ffNrse4Gi6veF6uQPiGblz4nm4teI7uNnjx7f655i3TecQt4vln7ZM6EW2Nui8tRfot7Ue6UK17uhrtdHoQbU06dq0Y+k5tJLpg7PL6Z+y/unJsRbqFbMt6km0KOpcteHosLYP6/i3XOuwuGnrQrr766m7J+vatbTr7ba167K4Lut9ukrrO7wT6/O9/+qfvwHrNcEQ6+DCKOuGxFrrBsZ564bHD+vwyR7q+8xK6IbQkOX61EHiLNp73Y7f3tgj46rU5ebw0G3rQM7j74/M2PT/yhH6c8ri/s/Jfv8ayOT8e8Y0+ufEi/b5wpj0EsKI9HXBs/Qzwer0+MA19YLBgfV0wiL2bMPJ9k7E0fel8QP1lPkF9UH7WfY2/aL4Of2f+jf8J/yN+j/8mfxg+Gj+0/yC9V8AQfuy8p4BmfSf8GkEvvdyubUFL/12mFIF5/nIzSQJWfnF0kMH5fq2xf7+kfoOvM348gq/yfMKNLT1FTmjE2T1EhS9KsEu+wjkJOb3xMBz+g7AAPM1sHOH/3ZcJ/yq/lWo5fu/6z70cO7B8hHlHPFf2EzvguRh+A7xSP+V7bPlL/QG9gPuMPsb9bn2GPu49xv5K/vA+Zj8e/6h+2cACQR3/egF3AaP/ZoIdAoJ/z0K1As2/WIP3g4n+r0S2RON9h4X+BfF8skaGxsd8IUeIR6f7K0iKiEo6R8nHyTM9ysSHG0v5TITGZUzsddGGyU3Hs4RQHQ+gLmOaKyv1hShNbSb0TGZPrCVzpuUMQ==" type="audio/wav">
          </audio>
        </div>
    
        <!-- Step 3 -->
        <div id="step-3" class="step" data-cy="step-3">
          <div class="step-title">
            <span class="completion-checkmark" data-cy="step-3-checkmark">✅</span>
            <strong>STEP 3: Call the phone number assigned to the user (if available).</strong>
            <span class="step-status" data-cy="step-3-status">Pending</span>
          </div>
    
          <!-- User Info Tile -->
          <div class="user-info-tile" data-cy="step-3-user-info">
            <span class="user-name">👤 Loading...</span>
            <span class="user-phone">📞 Loading...</span>
          </div>
    
          <button
            class="step-button"
            data-cy="step-3-action"
            onclick="prefillUserCallNote()"
          >
            📞 Call User
          </button>
    
          <select
  id="outcome-3"
  data-cy="outcome-3"
  onchange="insertStep3Outcome()"
  style="margin-top: 8px"
>
  <option value="">Select outcome</option>
  <option value="No answer, left voicemail. ">No answer, left voicemail</option>
  <option value="No answer, voicemail already left. ">No answer, voicemail already left</option>
  <option value="No answer, unable to leave voicemail. ">No answer, unable to leave voicemail</option>
  <option value="No answer, voicemail box full. ">No answer, voicemail box full</option>
  <option value="No answer, voicemail not set up. ">No answer, voicemail not set up</option>
  <option value="Wrong number. ">Wrong number</option>
  <option value="Unable to connect. ">Unable to connect</option>
  <option value="Number invalid, changed, or out of service. ">Number invalid, changed, or out of service</option>
  <option value="DYNAMIC_USER_OK">Spoke with {User Name}, confirmed they are OK</option>
</select>
    
          <textarea
            id="step-3-note"
            data-cy="step-3-note"
            placeholder="Document the result..."
            style="margin-top: 8px"
          ></textarea>
    
          <button
            class="post-note-button"
            data-cy="step-3-post"
            onclick="postNote(3)"
            style="margin-top: 8px"
          >
            ✅ Post Note
          </button>
        </div>
    
        <!-- Step 4 -->
        <div id="step-4" class="step" data-cy="step-4">
          <div class="step-title">
            <span class="completion-checkmark" data-cy="step-4-checkmark">✅</span>
            <strong>STEP 4: Contact emergency contacts in order of priority.</strong>
            <span class="step-status" data-cy="step-4-status">Pending</span>
          </div>
    
          <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid #2196f3;">
            • If there is no answer, but dispatch conditions are met, proceed to <strong>STEP 5</strong>.<br>
            • If dispatch conditions are not met, repeat <strong>STEPS 1, 2, 3 & 4</strong> until someone is reached.
          </div>
    
          <!-- Step 4-1 -->
          <div id="step-4-1" class="step-subsection" data-cy="step-4-1">
            <div class="step-title">
              <span class="completion-checkmark" data-cy="step-4-1-checkmark">✅</span>
              <span class="ec-title-text">Call Loading... at Loading...</span>
              <span class="step-status" data-cy="step-4-1-status">Pending</span>
            </div>
    
            <!-- Emergency Contact 1 Info Tile -->
            <div class="ec-info-tile" data-cy="step-4-1-ec-info">
              <span class="ec-name">👤 Loading...</span>
              <span class="ec-phone">📞 Loading...</span>
              <span class="ec-role">🏢 Site Supervisor</span>
            </div>
    
            <button
              class="step-button"
              data-cy="step-4-1-action"
              onclick="prefillECNote('4-1')"
            >
              📞 Call Emergency Contact
            </button>
    
            <select
              id="outcome-4-1"
              data-cy="outcome-4-1"
              onchange="insertStep4TimerNote('4-1')"
              style="margin-top: 8px"
            >
              <option value="">Select outcome</option>
              <option value="Spoke with EC, who will check on user and call back. Waiting 30 minutes. ">Spoke with EC, who will check on user and call back. Waiting 30 minutes</option>
              <option value="Confirmed user is okay and advised to resolve alert. ">Confirmed user is okay and advised to resolve alert</option>
              <option value="No answer, left voicemail. ">No answer, left voicemail</option>
              <option value="No answer, voicemail already left. ">No answer, voicemail already left</option>
              <option value="No answer, unable to leave voicemail. ">No answer, unable to leave voicemail</option>
              <option value="No answer, voicemail box full. ">No answer, voicemail box full</option>
              <option value="No answer, voicemail not set up. ">No answer, voicemail not set up</option>
              <option value="Wrong number. ">Wrong number</option>
              <option value="Unable to connect. ">Unable to connect</option>
              <option value="Number invalid, changed, or out of service. ">Number invalid, changed, or out of service</option>
            </select>
    
            <textarea
              id="step-4-1-note"
              data-cy="step-4-1-note"
              placeholder="Document the result..."
            ></textarea>
    
            <button
              class="post-note-button"
              data-cy="step-4-1-post"
              onclick="postNote('4-1')"
              style="margin-top: 8px"
            >
              ✅ Post Note
            </button>

                      <!-- Step 4-1 Timer -->
<div
id="step-4-1-timer-container"
class="timer-box"
data-cy="step-4-1-timer-box"
style="display: none; margin-top: 16px"
>
<span>⏱️ Waiting for EC1 callback:
  <span id="step-4-1-countdown" data-cy="step-4-1-countdown">30:00</span>
</span>
<button onclick="cancelStep4Timer('4-1')">Cancel Timer</button>
</div>
          </div>
    
          <!-- Step 4-2 -->
          <div
            id="step-4-2"
            class="step-subsection"
            data-cy="step-4-2"
            style="margin-top: 16px"
          >
            <div class="step-title">
              <span class="completion-checkmark" data-cy="step-4-2-checkmark">✅</span>
              <span class="ec-title-text">Call Loading... at Loading...</span>
              <span class="step-status" data-cy="step-4-2-status">Pending</span>
            </div>
    
            <!-- Emergency Contact 2 Info Tile -->
            <div class="ec-info-tile" data-cy="step-4-2-ec-info">
              <span class="ec-name">👤 Loading...</span>
              <span class="ec-phone">📞 Loading...</span>
              <span class="ec-role">🏢 Control Room Operator</span>
            </div>
    
            <button
              class="step-button"
              data-cy="step-4-2-action"
              onclick="prefillECNote('4-2')"
            >
              📞 Call Emergency Contact
            </button>
    
            <select
              id="outcome-4-2"
              data-cy="outcome-4-2"
              onchange="insertStep4TimerNote('4-2')"
              style="margin-top: 8px"
            >
              <option value="">Select outcome</option>
              <option value="Spoke with EC, who will check on user and call back. Waiting 30 minutes. ">Spoke with EC, who will check on user and call back. Waiting 30 minutes</option>
              <option value="Confirmed user is okay and advised to resolve alert. ">Confirmed user is okay and advised to resolve alert</option>
              <option value="No answer, left voicemail. ">No answer, left voicemail</option>
              <option value="No answer, voicemail already left. ">No answer, voicemail already left</option>
              <option value="No answer, unable to leave voicemail. ">No answer, unable to leave voicemail</option>
              <option value="No answer, voicemail box full. ">No answer, voicemail box full</option>
              <option value="No answer, voicemail not set up. ">No answer, voicemail not set up</option>
              <option value="Wrong number. ">Wrong number</option>
              <option value="Unable to connect. ">Unable to connect</option>
              <option value="Number invalid, changed, or out of service. ">Number invalid, changed, or out of service</option>
            </select>
    
            <textarea
              id="step-4-2-note"
              data-cy="step-4-2-note"
              placeholder="Document the result..."
            ></textarea>
    
            <button
              class="post-note-button"
              data-cy="step-4-2-post"
              onclick="postNote('4-2')"
              style="margin-top: 8px"
            >
              ✅ Post Note
            </button>
          </div>

<!-- Step 4-2 Timer -->
<div
  id="step-4-2-timer-container"
  class="timer-box"
  data-cy="step-4-2-timer-box"
  style="display: none; margin-top: 16px"
>
  <span>⏱️ Waiting for EC2 callback:
    <span id="step-4-2-countdown" data-cy="step-4-2-countdown">30:00</span>
  </span>
  <button onclick="cancelStep4Timer('4-2')">Cancel Timer</button>
</div>
        </div>
    
        <!-- Step 5 -->
        <div id="step-5" class="step" data-cy="step-5">
          <div class="step-title">
            <span class="completion-checkmark" data-cy="step-5-checkmark">✅</span>
            <strong>STEP 5: If a valid and up to date location is available, dispatch emergency services (EMS).</strong>
            <span class="step-status" data-cy="step-5-status">Pending</span>
          </div>
    
          <label for="dispatch-decision">Dispatch conditions met?</label>
          <select
            id="dispatch-decision"
            data-cy="step-5-decision"
            onchange="handleDispatchDecision()"
            style="margin-bottom: 10px"
          >
            <option value="">-- Select --</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
    
          <!-- Skip dispatch reason -->
          <div id="skip-reason-container" style="display: none">
            <label for="skip-reason">Reason for skipping dispatch:</label>
            <select
              id="skip-reason"
              data-cy="skip-reason"
              onchange="prefillSkipDispatchNote()"
            >
              <option value="">-- Select reason --</option>
              <option value="location-invalid">Location invalid or outdated</option>
              <option value="gas-alert-old">Alert older than 24 hours</option>
              <option value="device-moving">Device is moving faster than 5 km/h</option>
              <option value="device-offline">Device is offline</option>
            </select>
          </div>
    
          <!-- Dispatch service type -->
          <div id="dispatch-service-container" style="display: none">
            <label for="dispatch-service">Dispatch Service Type</label>
            <select
              id="dispatch-service"
              data-cy="dispatch-service"
              onchange="prefillDispatchNote()"
              style="margin-bottom: 10px"
            >
              <option value="">-- Select Service --</option>
              <option value="EMS">EMS</option>
              <option value="Police">Police</option>
              <option value="Fire">Fire</option>
              <option value="EMS and Police">EMS and Police</option>
              <option value="Fire and Police">Fire and Police</option>
              <option value="EMS, Fire and Police">EMS, Fire and Police</option>
            </select>
          </div>
    
          <button
            class="step-button"
            data-cy="step-5-action"
            onclick="scrollToNote('step-5-note')"
            style="display: none"
          >
            🚨 Proceed with Dispatch
          </button>
    
          <textarea
            id="step-5-note"
            data-cy="step-5-note"
            placeholder="Document the dispatch..."
            style="margin-top: 8px"
          ></textarea>
    
          <button
            class="post-note-button"
            data-cy="step-5-post"
            onclick="postNote(5)"
            style="margin-top: 8px"
          >
            ✅ Post Note
          </button>
    
          <!-- Step 5 Timer -->
          <div
            id="step-5-timer-container"
            data-cy="step-5-timer-box"
            style="display: none; margin-top: 10px"
          >
            <span>⏱️ 30-min Follow-up:
              <span id="step-5-countdown">30:00</span>
            </span>
            <button onclick="cancelStep5Timer()">Cancel Timer</button>
          </div>
        </div>
    
        <!-- Resolution Section - Moved here after Step 5 -->
        <div id="resolution-section" class="step" style="border-color: #dc3545;" data-cy="resolution-section">
          <div class="step-title">
            <span class="completion-checkmark" data-cy="resolution-checkmark">✅</span>
            <strong>🎯 RESOLUTION</strong>
            <span class="step-status" data-cy="resolution-status">Pending</span>
          </div>
    
          <label for="resolution-reason" style="display: block; margin-bottom: 8px; font-weight: bold;">
            Reason for resolving alert:
          </label>
          <select id="resolution-reason" data-cy="resolution-reason" style="width: 100%; margin-bottom: 8px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <option value="">-- Select reason --</option>
            <option value="false-alert-without-dispatch">False alert without dispatch</option>
            <option value="false-alert-with-dispatch">False alert with dispatch</option>
            <option value="incident-without-dispatch">Incident without dispatch</option>
            <option value="incident-with-dispatch">Incident with dispatch</option>
            <option value="pre-alert">Pre-Alert</option>
            <option value="demo-training">Demo/Training</option>
            <option value="system-test">System Test</option>
            <option value="multiple-alerts">Multiple Alerts</option>
            <option value="system-maintenance">System Maintenance</option>
          </select>
    
          <div style="margin-top: 12px;">
            <button class="resolve-button" onclick="resolveAlert()" data-cy="resolve-alert-btn">
              ✅ Resolve Alert
            </button>
            
            <button class="cancel-resolution-button" onclick="cancelResolution()" data-cy="cancel-resolution-btn">
              ❌ Cancel Resolution
            </button>
            
            </button>
          </div>
        </div>
      </div>
    </div>

<script>
  console.log("Complete Emergency Alert System loading...");
  
  // Global timer variables
  let step2TimerInterval;
  let step2TimeRemaining = 120;
  let step4TimerInterval;
  let step4TimeRemaining = 1800; // 30 minutes
  let step5TimerInterval;
  let step5TimeRemaining = 1800; // 30 minutes
  
  // Global variable to store alert data
  let currentAlertData = null;
  
  function getCurrentTimezone() {
    try {
      const now = new Date();
      const january = new Date(now.getFullYear(), 0, 1);
      const july = new Date(now.getFullYear(), 6, 1);
      const standardTimezoneOffset = Math.max(
        january.getTimezoneOffset(),
        july.getTimezoneOffset()
      );
      const currentTimezoneOffset = now.getTimezoneOffset();
      return currentTimezoneOffset < standardTimezoneOffset ? "MDT" : "MST";
    } catch (error) {
      return "MST";
    }
  }
  
  function getOperatorId() {
    return "Op 417";
  }
  
  function createLogEntry(content, stepNumber) {
  try {
    const logList = document.getElementById("log-list");
    if (!logList) return null;

    // ✅ Remove placeholder if present
    const placeholder = document.getElementById("log-placeholder");
    if (placeholder) {
      placeholder.remove();
    }

    const logEntry = document.createElement("div");
    logEntry.className = "log-entry";

    const timestamp = new Date().toLocaleTimeString("en-CA", {
      timeZone: "America/Edmonton",
      hour12: false,
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });

    const timezone = getCurrentTimezone();
    const operatorId = getOperatorId();

    // 🔧 FIXED: Always apply step badge formatting regardless of stepNumber parameter
    let processedContent = content.replace(/Step (\d+(-\d+)?):/g, function(match, stepNum) {
      return '<span class="step-badge">Step ' + stepNum + '</span>';
    });

    logEntry.innerHTML =
      '<div class="log-content">' +
      '<span class="log-timestamp">[' + timestamp + " " + timezone + ']</span>' +
      processedContent +
      '<span class="log-operator">' + operatorId + '</span>' +
      '</div>';

    logList.appendChild(logEntry);

    // Auto-scroll to bottom to show latest entries
    setTimeout(() => {
      logList.scrollTop = logList.scrollHeight;
    }, 100);

    return logEntry;
  } catch (error) {
    console.error("Error in createLogEntry:", error);
    return null;
  }
}

  
function markStepComplete(step) {
  try {
    const stepElement = document.getElementById("step-" + step);
    if (!stepElement) return;

    stepElement.classList.add("completed-step");
    stepElement.setAttribute("aria-checked", "true");

    const statusElement = stepElement.querySelector(".step-status");
    if (statusElement) {
      statusElement.textContent = "Completed";
    }

    // Disable interactive elements
    const buttons = stepElement.querySelectorAll('button');
    const textareas = stepElement.querySelectorAll('textarea');
    const selects = stepElement.querySelectorAll('select');
    
    buttons.forEach(function(btn) {
      // EXCEPTION: Keep Step 2 cancel timer button active
      if (step == 2 && btn.id === 'step-2-cancel-timer') {
        return; // Skip disabling this button
      }
      // EXCEPTION: Keep Step 4 timer cancel button active
      if ((step === "4-1" || step === "4-2") && btn.onclick && btn.onclick.toString().includes('cancelStep4Timer')) {
        return; // Skip disabling Step 4 timer cancel button
      }
      // EXCEPTION: Keep Step 5 timer cancel button active
      if (step == 5 && btn.onclick && btn.onclick.toString().includes('cancelStep5Timer')) {
        return; // Skip disabling Step 5 timer cancel button
      }
      btn.disabled = true;
      btn.style.pointerEvents = 'none';
    });
    
    textareas.forEach(function(textarea) {
      textarea.disabled = true;
      textarea.style.pointerEvents = 'none';
    });
    
    selects.forEach(function(select) {
      select.disabled = true;
      select.style.pointerEvents = 'none';
    });

    // Special handling for Step 4 substeps
    if (step === "4-1" || step === "4-2") {
      checkStep4Completion();
      
      // Keep Step 4 timer active
      const step4Timer = document.getElementById("step-4-timer-container");
      const step4CancelButton = step4Timer ? step4Timer.querySelector('button') : null;
      if (step4CancelButton) {
        step4CancelButton.disabled = false;
        step4CancelButton.style.pointerEvents = 'auto';
      }
    }

    console.log("Step " + step + " marked as complete");
  } catch (error) {
    console.error("Error in markStepComplete:", error);
  }
}
  
  function insertStep3Outcome() {
    try {
        const select = document.getElementById("outcome-3");
        const selectedValue = select.value;

        if (selectedValue) {
            const textarea = document.getElementById("step-3-note");
            if (textarea) {
                let outcomeText = selectedValue;
                
                // Handle dynamic user name replacement
                if (selectedValue === "DYNAMIC_USER_OK" && currentAlertData) {
                    outcomeText = `Spoke with ${currentAlertData.user}, confirmed they are OK. `;
                }
                
                textarea.value += outcomeText;
            }
        }
    } catch (error) {
        console.error("Error in insertStep3Outcome:", error);
    }
}
  function checkStep4Completion() {
    try {
      const step41 = document.getElementById("step-4-1");
      const step42 = document.getElementById("step-4-2");
      const step4Main = document.getElementById("step-4");
  
      if (step41 && step42 && step4Main) {
        const both41And42Complete =
          step41.classList.contains("completed-step") &&
          step42.classList.contains("completed-step");
        const oneCompleteWithValidOutcome =
          (step41.classList.contains("completed-step") &&
            document
              .getElementById("outcome-4-1")
              .value.includes("confirmed")) ||
          (step42.classList.contains("completed-step") &&
            document
              .getElementById("outcome-4-2")
              .value.includes("confirmed"));
  
        if (both41And42Complete || oneCompleteWithValidOutcome) {
          markStepComplete("4");
        }
      }
    } catch (error) {
      console.error("Error in checkStep4Completion:", error);
    }
  }
  
  function postNote(step) {
  try {
    const noteTextarea = document.getElementById('step-' + step + '-note');
    if (!noteTextarea) return;
    
    // Clear any previous warnings
    const existingWarning = document.getElementById('note-warning-' + step);
    if (existingWarning) existingWarning.remove();
    
    if (noteTextarea.value.trim()) {
      const content = noteTextarea.value.trim();
      createLogEntry('Step ' + step + ': ' + content, step);
      
      // Check if this is Step 5
      if (step === 5 || step === '5') {
        const dispatchDecision = document.getElementById('dispatch-decision').value;
        const skipReason = document.getElementById('skip-reason').value;
        
        if (dispatchDecision === 'no' && skipReason) {
          // Dispatch SKIPPED - reset and scroll to Step 1
          setTimeout(function() {
            handleDispatchSkipped();
            suggestResolutionReason();
            // Auto-scroll to Step 1 after reset is complete
            setTimeout(function() {
              const step1Element = document.getElementById('step-1');
              if (step1Element) {
                step1Element.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }, 800);
          }, 1200);
          noteTextarea.value = '';
          return;

        } else if (dispatchDecision === 'yes') {
          // Dispatch PROCEEDING - complete step but DON'T scroll, DON'T reset
          markStepComplete(step);
          noteTextarea.value = '';
          suggestResolutionReason();
          
          // ADD THIS: Start 30-minute dispatch follow-up timer
          startStep5Timer();
          
          console.log('Posted note for step ' + step + ' - dispatch proceeding');
          return;
        }
      }
            
        // For all other steps (1-4)
        markStepComplete(step);
        noteTextarea.value = '';
        console.log('Posted note for step ' + step);
      } else {
        // Show inline warning instead of popup
        const warningDiv = document.createElement('div');
        warningDiv.id = 'note-warning-' + step;
        warningDiv.style.cssText = 'color: #dc3545; font-size: 14px; margin-top: 4px; padding: 4px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px;';
        warningDiv.textContent = '⚠️ Please enter a note before posting';
        
        noteTextarea.parentNode.insertBefore(warningDiv, noteTextarea.nextSibling);
        noteTextarea.focus();
        
        // Remove warning after 5 seconds
        setTimeout(() => {
          if (warningDiv) warningDiv.remove();
        }, 5000);
      }
    } catch (error) {
      console.error('Error in postNote:', error);
    }
  }
  
  // PREFILL FUNCTIONS
  function prefillDeviceCallNote() {
  try {
    const button = document.querySelector('[data-cy="step-1-action"]');
    const noteField = document.getElementById("step-1-note");
    
    if (noteField && !button.disabled) {
      noteField.value = "Called the device. ";
      createLogEntry("📞 Initiated call to G7c device");
      
      // Disable button after first click
      button.disabled = true;
      button.style.opacity = '0.6';
      button.textContent = '📞 Called';
    }
  } catch (error) {
    console.error("Error in prefillDeviceCallNote:", error);
  }
}
  
  function insertStep1Outcome() {
    try {
      const select = document.getElementById("outcome-1");
      const selectedValue = select.value;
  
      if (selectedValue) {
        const textarea = document.getElementById("step-1-note");
        if (textarea) {
          let outcomeText = selectedValue;
          
          // Handle dynamic user name replacement
          if (selectedValue === "DYNAMIC_USER_OK_RESOLVE" && currentAlertData) {
            outcomeText = `Spoke with ${currentAlertData.user}. Confirmed they are OK. Resolving alert. `;
          }
          
          textarea.value += outcomeText;
        }
      }
    } catch (error) {
      console.error("Error in insertStep1Outcome:", error);
    }
  }
  
  function prefillUserCallNote() {
  try {
    const button = document.querySelector('[data-cy="step-3-action"]');
    const noteField = document.getElementById("step-3-note");
    
    if (noteField && currentAlertData && !button.disabled) {
      noteField.value = `Called ${currentAlertData.user} at ${currentAlertData.mobile}. `;
      createLogEntry(`📞 Initiated call to user ${currentAlertData.user}`);
      
      // Disable button after first click
      button.disabled = true;
      button.style.opacity = '0.6';
      button.textContent = '📞 Called';
    }
  } catch (error) {
    console.error("Error in prefillUserCallNote:", error);
  }
}
  
  function insertStep3Outcome() {
    try {
      const select = document.getElementById("outcome-3");
      const selectedValue = select.value;
  
      if (selectedValue) {
        const textarea = document.getElementById("step-3-note");
        if (textarea) {
          let outcomeText = selectedValue;
          
          // Handle dynamic user name replacement
          if (selectedValue === "DYNAMIC_USER_OK" && currentAlertData) {
            outcomeText = `Spoke with ${currentAlertData.user}, confirmed they are OK. `;
          }
          
          textarea.value += outcomeText;
        }
      }
    } catch (error) {
      console.error("Error in insertStep3Outcome:", error);
    }
  }
  
  function prefillECNote(stepId) {
  try {
    const button = document.querySelector(`[data-cy="step-${stepId}-action"]`);
    const ecData = {
      "4-1": currentAlertData ? currentAlertData.ec1 : { name: "Daniel Reyes", number: "+1-587-333-9271" },
      "4-2": currentAlertData ? currentAlertData.ec2 : { name: "Vanessa Liu", number: "+1-780-452-1189" }
    };

    const ec = ecData[stepId];
    if (ec && !button.disabled) {
      const noteField = document.getElementById("step-" + stepId + "-note");
      if (noteField) {
        noteField.value = "Called " + ec.name + " at " + ec.number + ". ";
        createLogEntry("📞 Initiated call to emergency contact " + ec.name);
        
        // Disable button after first click
        button.disabled = true;
        button.style.opacity = '0.6';
        button.textContent = '📞 Called';
      }
    }
  } catch (error) {
    console.error("Error in prefillECNote:", error);
  }
}
  
  // STEP 2 TIMER FUNCTIONALITY
  function handleStep2() {
  try {
    const button = document.querySelector('[data-cy="step-2-action"]');
    const noteField = document.getElementById("step-2-note");
    
    if (noteField && !button.disabled) {
      noteField.value = 'Sent message "Do you need help?" to G7c device. Waiting 2 minutes.';
      startStep2Timer();
      
      // Disable button after first click
      button.disabled = true;
      button.style.opacity = '0.6';
      button.textContent = '💬 Message Sent';
    }
  } catch (error) {
    console.error("Error in handleStep2:", error);
  }
}
  
  function startStep2Timer() {
    try {
      const timerContainer = document.getElementById("step-2-timer-container");
      const countdown = document.getElementById("step-2-countdown");
      const cancelButton = document.getElementById("step-2-cancel-timer");
  
      if (!timerContainer || !countdown) return;
  
      timerContainer.style.display = "block";
      timerContainer.classList.remove("timer-expired");
      step2TimeRemaining = 120; // 2 minutes
  
      if (cancelButton) {
        cancelButton.disabled = false;
        cancelButton.style.pointerEvents = "auto";
      }
  
      step2TimerInterval = setInterval(function () {
        step2TimeRemaining--;
  
        const mins = Math.floor(step2TimeRemaining / 60);
        const secs = step2TimeRemaining % 60;
        countdown.textContent =
          mins.toString().padStart(2, "0") +
          ":" +
          secs.toString().padStart(2, "0");
  
        if (step2TimeRemaining <= 0) {
          clearInterval(step2TimerInterval);
  
          // Play alert sound
          const alertSound = document.getElementById("step-2-alert-sound");
          if (alertSound) {
            alertSound.play().catch(function (e) {
              console.log("Audio play failed:", e);
            });
          }
  
          timerContainer.classList.add("timer-expired");
          countdown.textContent = "00:00";
  
          createLogEntry("Step 2: 2-minute wait completed. Proceed to Step 3.");
        }
      }, 1000);
  
      createLogEntry("⏱️ 2-minute message timer started");
    } catch (error) {
      console.error("Error in startStep2Timer:", error);
    }
  }
  
  function cancelStep2Timer() {
    try {
      const timerContainer = document.getElementById("step-2-timer-container");
      const cancelButton = document.getElementById("step-2-cancel-timer");
  
      if (timerContainer) {
        timerContainer.style.display = "none";
        timerContainer.classList.remove("timer-expired");
      }
  
      if (step2TimerInterval) {
        clearInterval(step2TimerInterval);
      }
  
      if (cancelButton) {
        cancelButton.disabled = false;
        cancelButton.style.pointerEvents = "auto";
      }
  
      createLogEntry("Timer cancelled by specialist.");
    } catch (error) {
      console.error("Error in cancelStep2Timer:", error);
    }
  }
  
  // STEP 4 TIMER FUNCTIONALITY
  function insertStep4TimerNote(stepId) {
  try {
    const select = document.getElementById("outcome-" + stepId);
    const selectedValue = select.value;

    if (selectedValue) {
      const textarea = document.getElementById("step-" + stepId + "-note");
      if (textarea) {
        textarea.value += selectedValue;

        // Check for the callback option that triggers timer (with or without period)
        if (selectedValue.includes("Waiting 30 minutes")) {
          startStep4Timer(stepId);
        }
      }
    }
  } catch (error) {
    console.error("Error in insertStep4TimerNote:", error);
  }
}
  
function startStep4Timer(stepId) {
  try {
    const timerContainer = document.getElementById(`step-${stepId}-timer-container`);
    const countdown = document.getElementById(`step-${stepId}-countdown`);
    
    if (!timerContainer || !countdown) return;

    timerContainer.style.display = "block";
    step4TimeRemaining = 1800; // 30 minutes

    step4TimerInterval = setInterval(function() {
      step4TimeRemaining--;

      const mins = Math.floor(step4TimeRemaining / 60);
      const secs = step4TimeRemaining % 60;
      countdown.textContent = 
        mins.toString().padStart(2, "0") + ":" + 
        secs.toString().padStart(2, "0");

      if (step4TimeRemaining <= 0) {
        clearInterval(step4TimerInterval);

        const ecData = {
          "4-1": { 
            name: currentAlertData ? currentAlertData.ec1.name : "Daniel Reyes", 
            phone: currentAlertData ? currentAlertData.ec1.number : "+1-587-333-9271",
            label: "EC1"
          },
          "4-2": { 
            name: currentAlertData ? currentAlertData.ec2.name : "Vanessa Liu", 
            phone: currentAlertData ? currentAlertData.ec2.number : "+1-780-452-1189",
            label: "EC2"
          }
        };

        const ec = ecData[stepId];
        if (ec) {
          createLogEntry(`Step 4: 30-minute wait completed. Call back ${ec.label} ${ec.name} at ${ec.phone}.`);
        }
      }
    }, 1000);

    createLogEntry("⏱️ 30-minute callback timer started");
  } catch (error) {
    console.error("Error in startStep4Timer:", error);
  }
}

function cancelStep4Timer(stepId) {
  try {
    const timerContainer = document.getElementById(`step-${stepId}-timer-container`);
    if (timerContainer) {
      timerContainer.style.display = "none";
    }
    if (step4TimerInterval) {
      clearInterval(step4TimerInterval);
    }
    createLogEntry("Step 4 timer cancelled by specialist.");
  } catch (error) {
    console.error("Error in cancelStep4Timer:", error);
  }
}
  
  // STEP 5 DISPATCH FUNCTIONALITY
  function handleDispatchDecision() {
    try {
      const decision = document.getElementById("dispatch-decision").value;
      const skipContainer = document.getElementById("skip-reason-container");
      const dispatchContainer = document.getElementById("dispatch-service-container");
      const proceedButton = document.querySelector('[data-cy="step-5-action"]');
  
      if (decision === "yes") {
        if (skipContainer) skipContainer.style.display = "none";
        if (dispatchContainer) dispatchContainer.style.display = "block";
        if (proceedButton) proceedButton.style.display = "inline-block";
        createLogEntry("🚨 Dispatch conditions confirmed - proceeding with dispatch");
      } else if (decision === "no") {
        if (skipContainer) skipContainer.style.display = "block";
        if (dispatchContainer) dispatchContainer.style.display = "none";
        if (proceedButton) proceedButton.style.display = "none";
        createLogEntry("⚠️ Dispatch conditions not met - dispatch will be skipped");
      } else {
        if (skipContainer) skipContainer.style.display = "none";
        if (dispatchContainer) dispatchContainer.style.display = "none";
        if (proceedButton) proceedButton.style.display = "none";
      }
  
      setTimeout(suggestResolutionReason, 500);
    } catch (error) {
      console.error("Error in handleDispatchDecision:", error);
    }
  }
  
  function prefillSkipDispatchNote() {
    try {
      const reason = document.getElementById("skip-reason").value;
      if (reason) {
        const reasonSelect = document.getElementById("skip-reason");
        const reasonText = reasonSelect.options[reasonSelect.selectedIndex].text;
        const noteField = document.getElementById("step-5-note");
        if (noteField) {
          noteField.value = "Unable to dispatch. Reason: " + reasonText + ". Repeating Steps 1–4 until someone is reached.";
          createLogEntry("⚠️ Dispatch skipped: " + reasonText);
        }
      }
    } catch (error) {
      console.error("Error in prefillSkipDispatchNote:", error);
    }
  }
  
  function prefillDispatchNote() {
    try {
      const service = document.getElementById("dispatch-service").value;
      if (service) {
        const location = currentAlertData ? currentAlertData.last_location : "144252 434 Ave E, Aldersyde, AB T0L 0A0, Canada";
        const noteField = document.getElementById("step-5-note");
        if (noteField) {
          noteField.value = "Emergency Services requested " + service + " to the following location: " + location;
          createLogEntry("🚨 Dispatching " + service);
        }
      }
    } catch (error) {
      console.error("Error in prefillDispatchNote:", error);
    }
  }
  
  function handleDispatchSkipped() {
    try {
      console.log("🔍 handleDispatchSkipped() called - this should ONLY happen after clicking Post Note");
      resetStepsForRetry();
    } catch (error) {
      console.error("Error in handleDispatchSkipped:", error);
    }
  }

  // STEP 5 TIMER FUNCTIONALITY - ADD THIS
function startStep5Timer() {
  try {
    const timerContainer = document.getElementById("step-5-timer-container");
    const countdown = document.getElementById("step-5-countdown");
    
    if (!timerContainer || !countdown) return;

    timerContainer.style.display = "block";
    step5TimeRemaining = 1800; // 30 minutes

    step5TimerInterval = setInterval(function() {
      step5TimeRemaining--;

      const mins = Math.floor(step5TimeRemaining / 60);
      const secs = step5TimeRemaining % 60;
      countdown.textContent = 
        mins.toString().padStart(2, "0") + ":" + 
        secs.toString().padStart(2, "0");

      if (step5TimeRemaining <= 0) {
        clearInterval(step5TimerInterval);
        createLogEntry("Step 5: 30-minute follow-up timer completed. Contact dispatch for status update.");
      }
    }, 1000);

    createLogEntry("⏱️ 30-minute dispatch follow-up timer started");
  } catch (error) {
    console.error("Error in startStep5Timer:", error);
  }
}

function cancelStep5Timer() {
  try {
    const timerContainer = document.getElementById("step-5-timer-container");
    if (timerContainer) {
      timerContainer.style.display = "none";
    }
    if (step5TimerInterval) {
      clearInterval(step5TimerInterval);
    }
    createLogEntry("Step 5 timer cancelled by specialist.");
  } catch (error) {
    console.error("Error in cancelStep5Timer:", error);
  }
}
  
  // CYCLE RESET FUNCTIONALITY
  function resetStepsForRetry() {
    try {
      console.log("🚨 RESET CALLED! Stack trace:");
      console.trace();
      const stepsToReset = [1, 2, 3, 4, "4-1", "4-2"];
  
      stepsToReset.forEach(function (stepId) {
        const stepElement = document.getElementById("step-" + stepId);
        if (stepElement) {
          stepElement.classList.remove("completed-step");
          stepElement.removeAttribute("aria-checked");
  
          const statusElement = stepElement.querySelector(".step-status");
          if (statusElement) {
            statusElement.textContent = "Pending";
          }
  
          const buttons = stepElement.querySelectorAll("button");
          const textareas = stepElement.querySelectorAll("textarea");
          const selects = stepElement.querySelectorAll("select");
  
          buttons.forEach(function (btn) {
            btn.disabled = false;
            btn.style.pointerEvents = "auto";
          });
  
          textareas.forEach(function (textarea) {
            textarea.disabled = false;
            textarea.style.pointerEvents = "auto";
            textarea.value = "";
            textarea.style.borderColor = "#e9ecef";
            textarea.placeholder = "Document the result...";
          });
  
          selects.forEach(function (select) {
            select.disabled = false;
            select.style.pointerEvents = "auto";
            select.selectedIndex = 0;
          });
        }
      });
  
    } catch (error) {
      console.error("Error in resetStepsForRetry:", error);
    }
  }
  
  // USER INFO FUNCTIONALITY
  function populateUserInfo(alertData) {
    try {
      const userNameElement = document.querySelector('.user-info-tile .user-name');
      const userPhoneElement = document.querySelector('.user-info-tile .user-phone');
      
      if (userNameElement && alertData.user) {
        userNameElement.textContent = `👤 ${alertData.user}`;
      }
      
      if (userPhoneElement && alertData.mobile) {
        userPhoneElement.textContent = `📞 ${alertData.mobile}`;
      }
      
      console.log('User info populated:', alertData.user, alertData.mobile);
    } catch (error) {
      console.error('Error populating user info:', error);
    }
  }
  
  function populateEmergencyContacts(alertData) {
    try {
      // Update Step 4-1 (EC1)
      const ec1NameElement = document.querySelector('#step-4-1 .ec-name');
      const ec1PhoneElement = document.querySelector('#step-4-1 .ec-phone');
      const ec1TitleElement = document.querySelector('#step-4-1 .ec-title-text');
      
      if (ec1NameElement && alertData.ec1) {
        ec1NameElement.textContent = `👤 ${alertData.ec1.name}`;
      }
      if (ec1PhoneElement && alertData.ec1) {
        ec1PhoneElement.textContent = `📞 ${alertData.ec1.number}`;
      }
      if (ec1TitleElement && alertData.ec1) {
        ec1TitleElement.textContent = `Call ${alertData.ec1.name} at ${alertData.ec1.number}`;
      }
      
      // Update Step 4-2 (EC2)
      const ec2NameElement = document.querySelector('#step-4-2 .ec-name');
      const ec2PhoneElement = document.querySelector('#step-4-2 .ec-phone');
      const ec2TitleElement = document.querySelector('#step-4-2 .ec-title-text');
      
      if (ec2NameElement && alertData.ec2) {
        ec2NameElement.textContent = `👤 ${alertData.ec2.name}`;
      }
      if (ec2PhoneElement && alertData.ec2) {
        ec2PhoneElement.textContent = `📞 ${alertData.ec2.number}`;
      }
      if (ec2TitleElement && alertData.ec2) {
        ec2TitleElement.textContent = `Call ${alertData.ec2.name} at ${alertData.ec2.number}`;
      }
      
      console.log('Emergency contacts populated:', alertData.ec1?.name, alertData.ec2?.name);
    } catch (error) {
      console.error('Error populating emergency contacts:', error);
    }
  }
  
  function updatePrefillFunctions() {
    // Override existing prefill functions with dynamic data
    window.prefillUserCallNote = function() {
      try {
        const noteField = document.getElementById("step-3-note");
        if (noteField && currentAlertData) {
          noteField.value = `Called ${currentAlertData.user} at ${currentAlertData.mobile}. `;
          createLogEntry(`📞 Initiated call to user ${currentAlertData.user}`);
        }
      } catch (error) {
        console.error("Error in prefillUserCallNote:", error);
      }
    };
    
    updateECPrefillFunctions();
  }
  
  function updateECPrefillFunctions() {
    window.prefillECNote = function(stepId) {
      try {
        if (!currentAlertData) return;
        
        const ecData = {
          "4-1": currentAlertData.ec1,
          "4-2": currentAlertData.ec2
        };
  
        const ec = ecData[stepId];
        if (ec) {
          const noteField = document.getElementById("step-" + stepId + "-note");
          if (noteField) {
            noteField.value = "Called " + ec.name + " at " + ec.number + ". ";
            createLogEntry("📞 Initiated call to emergency contact " + ec.name);
          }
        }
      } catch (error) {
        console.error("Error in prefillECNote:", error);
      }
    };
  }
  
  // Function to load and populate user info from fixture
  async function loadUserInfo() {
    try {
      const response = await fetch('./cypress/fixtures/non_gas_alerts.json');
      const alerts = await response.json();
      
      if (alerts && alerts.length > 0) {
        currentAlertData = alerts[0];
        populateUserInfo(currentAlertData);
        populateEmergencyContacts(currentAlertData);
        updatePrefillFunctions();
        console.log('✅ Data loaded from JSON file successfully');
      }
    } catch (error) {
      console.error('Error loading user info from fixture:', error);
      console.log('🔄 Using fallback data...');
      
      currentAlertData = {
        user: 'Emily Garcia',
        mobile: '+1-313-635-3171',
        ec1: { name: 'Daniel Reyes', number: '+1-587-333-9271' },
        ec2: { name: 'Vanessa Liu', number: '+1-780-452-1189' },
        last_location: '144252 434 Ave E, Aldersyde, AB T0L 0A0, Canada'
      };
      
      populateUserInfo(currentAlertData);
      populateEmergencyContacts(currentAlertData);
      updatePrefillFunctions();
      console.log('✅ Fallback data loaded successfully');
    }
  }
  
  // RESOLUTION LOGIC FUNCTIONS
  function suggestResolutionReason() {
    try {
      if (!currentAlertData) return;
      
      const alertType = currentAlertData.type || 'SOS';
      const alertDate = new Date(currentAlertData.alert_date);
      const now = new Date();
      const hoursDiff = (now - alertDate) / (1000 * 60 * 60);
      
      // Check for Demo/Training
      const alertText = JSON.stringify(currentAlertData).toLowerCase();
      if (alertText.includes('demo')) {
        setSuggestedResolution('demo-training', 'Demo/Training');
        return;
      }
      
      // Check for Pre-Alert (over 24 hours)
      if (hoursDiff > 24) {
        setSuggestedResolution('pre-alert', 'Pre-Alert');
        return;
      }
      
      // Check dispatch status
      const dispatchDecision = document.getElementById('dispatch-decision')?.value;
      const hasDispatch = dispatchDecision === 'yes';
      
      // Determine resolution based on alert type and dispatch
      if (alertType.toLowerCase().includes('gas')) {
        // Gas alert = Incident
        if (hasDispatch) {
          setSuggestedResolution('incident-with-dispatch', 'Incident with dispatch');
        } else {
          setSuggestedResolution('incident-without-dispatch', 'Incident without dispatch');
        }
      } else {
        // Non-gas alert (SOS) = False alert
        if (hasDispatch) {
          setSuggestedResolution('false-alert-with-dispatch', 'False alert with dispatch');
        } else {
          setSuggestedResolution('false-alert-without-dispatch', 'False alert without dispatch');
        }
      }
      
    } catch (error) {
      console.error('Error in suggestResolutionReason:', error);
    }
  }
  
  function setSuggestedResolution(value, text) {
    const dropdown = document.getElementById('resolution-reason');
    
    if (dropdown) {
      dropdown.value = value;
    }
  }
  
  // RESOLUTION FUNCTIONS
  function resolveAlert() {
  try {
    const reasonSelect = document.getElementById("resolution-reason");
    const selectedReason = reasonSelect.value;

    if (selectedReason) {
      const reasonText = reasonSelect.options[reasonSelect.selectedIndex].text;
      createLogEntry("🎯 Alert resolved: " + reasonText);

      const resolutionSection = document.getElementById("resolution-section");
      if (resolutionSection) {
        resolutionSection.classList.add("completed-step");
        resolutionSection.setAttribute("aria-checked", "true");

        const statusElement = resolutionSection.querySelector(".step-status");
        if (statusElement) {
          statusElement.textContent = "Completed";
        }

        reasonSelect.disabled = true;
        
        const resolveButton = resolutionSection.querySelector('button[onclick="resolveAlert()"]');
        if (resolveButton) {
          resolveButton.disabled = true;
        }

        document.body.classList.add("alert-resolved");
      }
    } else {
      // Show inline warning instead of popup
      const warningDiv = document.createElement('div');
      warningDiv.id = 'resolution-warning';
      warningDiv.style.cssText = 'color: #dc3545; font-size: 14px; margin-top: 4px; padding: 4px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px;';
      warningDiv.textContent = '⚠️ Please select a reason for resolving the alert';
      
      const existingWarning = document.getElementById('resolution-warning');
      if (existingWarning) existingWarning.remove();
      
      reasonSelect.parentNode.insertBefore(warningDiv, reasonSelect.nextSibling);
      reasonSelect.focus();
      
      // Remove warning after 5 seconds
      setTimeout(() => {
        if (warningDiv) warningDiv.remove();
      }, 5000);
    }
  } catch (error) {
    console.error("Error in resolveAlert:", error);
  }
}

function cancelResolution() {
 try {
   const resolutionSection = document.getElementById("resolution-section");
   if (resolutionSection) {
     resolutionSection.classList.remove("completed-step");
     resolutionSection.removeAttribute("aria-checked");

     const statusElement = resolutionSection.querySelector(".step-status");
     if (statusElement) {
       statusElement.textContent = "Pending";
     }

     const reasonSelect = document.getElementById("resolution-reason");
     if (reasonSelect) {
       reasonSelect.disabled = false;
       reasonSelect.value = "";
     }

     const resolveButton = resolutionSection.querySelector('[data-cy="resolve-alert-btn"]');
     if (resolveButton) {
       resolveButton.disabled = false;
     }

     // UNLOCK ALL COMPLETED STEPS
     const completedSteps = document.querySelectorAll('.completed-step');
     completedSteps.forEach(step => {
       step.classList.remove('completed-step');
       step.removeAttribute('aria-checked');
       
       const status = step.querySelector('.step-status');
       if (status) status.textContent = 'Pending';
       
       // Re-enable all interactive elements
       const buttons = step.querySelectorAll('button');
       const textareas = step.querySelectorAll('textarea');
       const selects = step.querySelectorAll('select');
       
       buttons.forEach(btn => {
  btn.disabled = false;
  btn.style.pointerEvents = 'auto';
  btn.style.opacity = '1';  // ADD THIS LINE TO RESTORE OPACITY
});
       textareas.forEach(textarea => {
         textarea.disabled = false;
         textarea.style.pointerEvents = 'auto';
       });
       selects.forEach(select => {
         select.disabled = false;
         select.style.pointerEvents = 'auto';
       });
     });

     document.body.classList.remove("alert-resolved");
     createLogEntry("❌ Resolution cancelled - all steps unlocked");
   }
 } catch (error) {
   console.error("Error in cancelResolution:", error);
 }
}

function scrollToNote(noteId) {
 try {
   const element = document.getElementById(noteId);
   if (element) {
     element.scrollIntoView({ behavior: "smooth" });
   }
 } catch (error) {
   console.error("Error in scrollToNote:", error);
 }
}

function cancelStep5Timer() {
  try {
    const timerContainer = document.getElementById("step-5-timer-container");
    if (timerContainer) {
      timerContainer.style.display = "none";
    }
    // ADD THIS LINE:
    if (step5TimerInterval) {
      clearInterval(step5TimerInterval);
    }
    createLogEntry("Step 5 timer cancelled by specialist.");
  } catch (error) {
    console.error("Error in cancelStep5Timer:", error);
  }
}

// MANUAL LOG ENTRY
function activateManualNote() {
  try {
    const addButton = document.getElementById("add-manual-note-btn");
    const logSection = document.getElementById("manual-log-section");
    const textarea = document.getElementById("manual-log-textarea");

    if (addButton) addButton.style.display = "none";
    if (logSection) logSection.style.display = "block";
    if (textarea) textarea.focus();
  } catch (error) {
    console.error("Error in activateManualNote:", error);
  }
}

function submitManualNote() {
  try {
    const textarea = document.getElementById("manual-log-textarea");
    const content = textarea.value.trim();

    if (content) {
      createLogEntry("📝 Manual Note: " + content);
      cancelManualNote();
    } else {
      const warningDiv = document.createElement('div');
      warningDiv.style.cssText = 'color: #dc3545; font-size: 14px; margin-top: 4px; padding: 4px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px;';
      warningDiv.textContent = '⚠️ Please enter a note';
      
      textarea.parentNode.insertBefore(warningDiv, textarea.nextSibling);
      
      setTimeout(() => {
        if (warningDiv) warningDiv.remove();
      }, 3000);
    }
  } catch (error) {
    console.error("Error in submitManualNote:", error);
  }
}

function cancelManualNote() {
  try {
    const addButton = document.getElementById("add-manual-note-btn");
    const logSection = document.getElementById("manual-log-section");
    const textarea = document.getElementById("manual-log-textarea");

    if (logSection) logSection.style.display = "none";
    if (addButton) addButton.style.display = "block";
    if (textarea) {
      textarea.value = "";
    }
  } catch (error) {
    console.error("Error in cancelManualNote:", error);
  }
}

// And add this wrapper function:
function addManualNote() {
  activateManualNote();
}

// Call this when the page loads
document.addEventListener('DOMContentLoaded', function() {
 loadUserInfo();
});

// Force load the data immediately
loadUserInfo();

console.log("Complete Emergency Alert System JavaScript loaded successfully");
console.log("All functionality implemented: Steps 1-5, timers, manual logs, resolution, cycle reset");
</script>

</body>
</html>


