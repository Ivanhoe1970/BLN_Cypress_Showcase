<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Blackline Live - Alert Management</title>
    <style>
        body {
          margin: 0;
          padding: 0;
          background: #f8f9fa;
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
            sans-serif;
        }
  
        .header {
          background: linear-gradient(135deg, #e3f2fd, #bbdefb);
          color: #1565c0;
          padding: 20px;
          margin-bottom: 20px;
          border-radius: 8px;
          border: 1px solid #90caf9;
          display: none;
        }
  
        .header.active {
          display: block;
        }
  
        .alert-title {
          margin: 0;
          font-size: 1.5em;
          font-weight: bold;
          margin-bottom: 15px;
        }
  
        .alert-details {
          background: white;
          border: 1px solid #90caf9;
          border-radius: 6px;
          padding: 15px;
          color: #333;
        }
  
        .alert-info {
          display: block;
          font-size: 0.9em;
        }
        .info-item {
          padding: 3px 0;
        }
        .info-item strong {
          color: #1565c0;
          font-weight: 600;
        }
  
        .container {
          display: grid;
          grid-template-columns: 1fr 200px 1fr 300px;
          gap: 15px;
          max-width: 1600px;
          margin: 0 auto;
          padding: 20px;
        }
  
        .right-column {
          display: flex;
          flex-direction: column;
          gap: 15px;
          grid-column: 4;
        }
  
        .protocol-log {
          background: white;
          border: 2px solid #007bff;
          border-radius: 8px;
          padding: 20px;
        }
  
        .protocol-log h3 {
          margin-top: 0;
          color: #333;
          font-size: 1.1em;
        }
  
        .log-container {
          height: calc(100vh - 350px);
          min-height: 400px;
          overflow-y: auto;
          background: #f8f9fa;
          padding: 15px;
          border-radius: 5px;
          border: 1px solid #e9ecef;
          margin-bottom: 20px;
        }
  
        .log-entry {
          margin: 8px 0;
          padding: 8px 12px;
          background: white;
          border-left: 4px solid #28a745;
          border-radius: 4px;
          font-size: 0.9em;
          line-height: 1.3;
        }
  
        .log-entry.step {
          border-left-color: #007bff;
        }
        .log-entry.timer {
          border-left-color: #ffc107;
        }
        .log-entry.resolution {
          border-left-color: #dc3545;
        }
        .log-entry.gas {
          border-left-color: #fd7e14;
        }
        .log-entry.system {
          border-left-color: #6c757d;
        }
  
        .log-placeholder {
          color: #6c757d;
          text-align: center;
          margin-top: 120px;
          font-style: normal;
          font-size: 0.9em;
          font-family: inherit;
        }
  
        .global-timer {
          background: linear-gradient(135deg, #007bff, #0056b3);
          color: white;
          border-radius: 8px;
          padding: 15px;
          text-align: center;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
          position: sticky;
          top: 20px;
          height: fit-content;
          font-size: 0.9em;
        }
  
        .timer-controls {
    margin-top: 12px;
    display: flex;
    justify-content: center;
    padding: 0 10px;        /* Breathing room from timer edges */
}
  
        .timer-meta {
          margin-top: 8px;
          font-size: 0.7em;
          opacity: 0.8;
          line-height: 1.2;
          display: flex;
          justify-content: space-between;
        }
  
        .cancel-btn {
  background: #dc3545;
  color: white !important;
  border: none;
  padding: 8px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  font-size: 0.75em;
  transition: background 0.2s;
  width: calc(100% - 20px);
  margin: 0 10px;
  display: block;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  opacity: 1 !important;
}

.cancel-btn:hover:not(:disabled) {
  background: #c82333;
}

.cancel-btn:disabled,
#cancelTimerBtn.cancel-btn:disabled {
  opacity: 1 !important;
  cursor: not-allowed;
  color: white !important;
  background: #dc3545 !important;
}


  
        .steps-section {
          background: white;
          border: 2px solid #007bff;
          border-radius: 8px;
          padding: 20px;
        }
  
        .steps-section h3 {
          margin-top: 0;
          color: #333;
          font-size: 1.1em;
        }
  
        .gas-readings-card {
          background: white;
          border: 2px solid #28a745;
          border-radius: 8px;
          padding: 20px;
          position: sticky;
          top: 20px;
          height: fit-content;
        }
  
        .gas-readings-card h3 {
          margin-top: 0;
          color: #333;
          font-size: 1.1em;
          display: flex;
          align-items: center;
          gap: 8px;
        }
  
        .gas-reading {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 0;
          border-bottom: 1px solid #e9ecef;
          font-size: 0.9em;
        }
  
        .gas-reading:last-child {
          border-bottom: none;
        }
        .gas-value {
          font-weight: bold;
        }
  
        .gas-status {
          padding: 2px 6px;
          border-radius: 3px;
          font-size: 0.8em;
          font-weight: bold;
        }
  
        .gas-status.high {
          background: #f8d7da;
          color: #721c24;
        }
  
        .gas-status.normal {
          background: #d4edda;
          color: #155724;
        }
  
        .triggered-by {
          background: #fff3cd;
          border: 1px solid #ffeaa7;
          border-radius: 4px;
          padding: 8px;
          margin-bottom: 15px;
          font-size: 0.85em;
          font-weight: bold;
          color: #856404;
        }
  
        .last-updated {
          font-size: 0.8em;
          color: #6c757d;
          text-align: center;
          margin-top: 10px;
          font-style: italic;
        }
  
        .connectivity-panel {
          background: white;
          border: 2px solid #6c757d;
          border-radius: 8px;
          padding: 20px;
          height: fit-content;
        }
  
        .connectivity-panel h3 {
          margin-top: 0;
          color: #333;
          font-size: 1em;
          margin-bottom: 15px;
        }
  
        .device-status,
        .last-comm {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 0;
          font-size: 0.9em;
        }
  
        .status-pill {
          padding: 4px 10px;
          border-radius: 20px;
          font-weight: bold;
          font-size: 0.85em;
        }
  
        .status-pill.online {
          background: #d4edda;
          color: #155724;
        }
  
        .status-pill.offline {
          background: #f8d7da;
          color: #721c24;
        }
  
        .status-pill.loading {
          background: #fff3cd;
          color: #856404;
        }
  
        .step {
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 8px;
          padding: 15px;
          margin: 15px 0;
          position: relative;
        }
  
        .step.completed {
          background: #d4edda;
          border-color: #c3e6cb;
        }
  
        .step.active {
          background: #fff3cd;
          border-color: #ffeaa7;
        }
  
        .step-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
        }
  
        .step-title {
          font-weight: bold;
          color: #333;
          margin: 0;
          font-size: 0.95em;
        }
  
        .status-badge {
          background: #ffc107;
          color: #000;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 0.75em;
          font-weight: bold;
        }
  
        .status-badge.completed {
          background: #28a745;
          color: white;
        }
  
        .contact-info {
          background: #fff3cd;
          border: 1px solid #ffeaa7;
          border-radius: 4px;
          padding: 8px;
          margin: 8px 0;
          font-size: 0.85em;
        }
  
        .btn {
          border: none;
          padding: 8px 16px;
          border-radius: 4px;
          cursor: pointer;
          font-weight: 500;
          font-size: 0.85em;
          transition: all 0.2s;
        }
  
        .btn-primary {
          background: #007bff;
          color: white;
        }
  
        .btn-primary:hover:not(:disabled) {
          background: #0056b3;
        }
  
        .btn-success {
          background: #28a745;
          color: white;
        }
  
        .btn-success:hover:not(:disabled) {
          background: #1e7e34;
        }
  
        .btn-secondary {
          background: #6c757d;
          color: white;
        }
  
        .btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }
  
        .timer-inactive {
          opacity: 0.6;
          background: linear-gradient(135deg, #6c757d, #495057);
        }
  
        .manual-notes {
          width: 100%;
          height: 100px;
          border-radius: 5px;
          border: 1px solid #ddd;
          padding: 10px;
          box-sizing: border-box;
          resize: vertical;
          font-family: inherit;
          font-size: 0.9em;
        }
  
        .step-outcome {
          margin: 10px 0;
        }
  
        .step-outcome select {
          width: 100%;
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 0.9em;
        }

        .step.skipped {
    background-color: #f8f9fa !important;
    opacity: 0.6;
    pointer-events: none;
}

.step.skipped .status-badge {
    background-color: #6c757d !important;
    color: white !important;
}

.step.skipped button {
    background-color: #6c757d !important;
    color: #dee2e6 !important;
    border-color: #6c757d !important;
}
  
        .step-outcome textarea {
          width: 100%;
          height: 80px;
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 0.9em;
          margin-top: 8px;
          box-sizing: border-box;
          resize: vertical;
        }
  
        .resolution-section {
          background: #fff;
          border: 2px solid #dc3545;
          border-radius: 8px;
          padding: 20px;
          margin: 20px 0;
        }
  
        .resolution-section h3 {
          margin-top: 0;
          color: #dc3545;
        }
  
        .resolution-section select {
          width: 100%;
          padding: 10px;
          margin: 10px 0;
          border: 1px solid #ddd;
          border-radius: 4px;
        }
  
        .resolution-buttons {
          display: flex;
          gap: 10px;
          margin-top: 15px;
        }
  
        .btn-danger {
          background: #dc3545;
          color: white;
        }
  
        .btn-danger:hover:not(:disabled) {
          background: #c82333;
        }
  
        /* Production View Toggle */
        .production-toggle {
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(0, 0, 0, 0.7);
          color: white;
          border: none;
          padding: 8px 12px;
          border-radius: 4px;
          font-size: 0.8em;
          cursor: pointer;
          z-index: 2000;
          transition: all 0.3s;
        }
  
        .production-toggle:hover {
          background: rgba(0, 0, 0, 0.9);
        }
  
        .production-mode .demo-gear,
        .production-mode .demo-panel {
          display: none !important;
        }
  
        .production-mode .header {
          margin-top: 10px;
        }
  
        /* Demo Controls */
        .demo-gear {
          position: fixed;
          bottom: 20px;
          right: 20px;
          width: 40px;
          height: 40px;
          background: #6c757d;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          z-index: 1000;
          transition: all 0.3s;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
  
        .demo-gear:hover {
          background: #5a6268;
          transform: rotate(90deg);
        }
  
        .demo-gear::before {
          content: "⚙️";
          font-size: 20px;
        }
  
        .demo-panel {
    position: fixed;
    bottom: 70px;
    right: 20px;
    background: rgba(255, 255, 255, 0.98);
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border: 1px solid #e9ecef;
    z-index: 999;
    max-width: 280px;
    max-height: 70vh;
    overflow-y: auto;
    display: none;
}

.demo-panel.show {
    display: block;
    animation: slideUp 0.3s ease-out;
}
  
        @keyframes slideUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
  
        .demo-panel h4 {
    margin: 8px 0 6px 0;
    color: #333;
    font-size: 0.85em;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 4px;
    font-weight: 600;
}

.demo-panel h4:first-child {
    margin-top: 0;
}

.demo-button-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4px;
    margin-bottom: 8px;
}

.demo-button-single {
    display: grid;
    grid-template-columns: 1fr;
    gap: 4px;
    margin-bottom: 8px;
}

.demo-panel button {
    font-size: 0.7em;
    padding: 6px 8px;
    margin: 0;
    border-radius: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
    height: auto;
    min-height: 28px;
}

.demo-panel .btn-secondary {
    grid-column: 1 / -1;
    margin-top: 8px;
    font-weight: 600;
}

.demo-section {
    margin-bottom: 10px;
}

.demo-section:last-child {
    margin-bottom: 0;
}

/* Collapsible sections */
.demo-section-header {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    user-select: none;
}

.demo-section-header::after {
    content: '▼';
    font-size: 0.7em;
    color: #666;
    transition: transform 0.2s;
}

.demo-section.collapsed .demo-section-header::after {
    transform: rotate(-90deg);
}

.demo-section.collapsed .demo-section-content {
    display: none;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
  
        .empty-state {
          text-align: center;
          color: #6c757d;
          padding: 100px 20px;
          font-size: 1.1em;
        }
  
        .empty-state h2 {
          color: #1565c0;
          margin-bottom: 15px;
        }
  
        .protocol-placeholder {
          display: flex;
          justify-content: center;
          align-items: center;
          min-height: 300px;
          padding: 20px;
        }
  
        .protocol-frame {
          border: 2px solid #e9ecef;
          border-radius: 8px;
          padding: 40px 30px;
          text-align: center;
          background: #f8f9fa;
          width: 100%;
          max-width: 400px;
        }
  
        .placeholder-text {
          font-size: 1.1em;
          font-weight: 600;
          color: #6c757d;
          margin-bottom: 10px;
        }
  
        .placeholder-subtitle {
          font-size: 0.9em;
          color: #8d9499;
          line-height: 1.4;
        }
  
        .timer-active {
          opacity: 1;
          background: linear-gradient(135deg, #007bff, #0056b3);
        }
  
        .timer-alert {
          animation: flashRed 1s infinite;
        }
  
        @keyframes flashRed {
          0%,
          50% {
            background: linear-gradient(135deg, #dc3545, #c82333);
          }
          51%,
          100% {
            background: linear-gradient(135deg, #007bff, #0056b3);
          }
        }
  
        .container {
          display: grid;
          grid-template-columns: 1fr 200px 1fr 300px;
          gap: 15px;
          align-items: start; /* Ensures top alignment */
        }
  
        .panel-box {
          background: white;
          border: 2px solid #007bff;
          border-radius: 8px;
          padding: 20px;
        }
  
        .messaging-section textarea.message-input {
    width: 100%;
    resize: none;
    padding: 8px;
    font-size: 14px;
    font-family: 'Rubik', sans-serif;
    line-height: 1.4;
    border-radius: 6px;
    border: 1px solid #90caf9;
    background-color: #fff;
    box-sizing: border-box;
    height: 48px; /* 2 lines of text */
    outline: none;
  }
  
  .messaging-section textarea.message-input:focus {
    border-color: #1565c0;
    box-shadow: 0 0 0 2px rgba(21, 101, 192, 0.2);
  }
  
  .char-counter {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
    margin-bottom: 8px;
    font-family: 'Rubik', sans-serif;
  }
  
  .message-history {
    margin-top: 20px;
  }
  
  .message-history h4 {
    font-size: 16px;
    color: #1565c0;
    margin-bottom: 10px;
    font-family: 'Rubik', sans-serif;
  }
  
  .message-list {
    list-style: none;
    padding-left: 0;
    max-height: 160px;
    overflow-y: auto;
    border: 1px solid #90caf9;
    border-radius: 6px;
    padding: 8px;
    background: #f9f9f9;
  }
  
  .message-list li {
    font-size: 14px;
    margin-bottom: 8px;
    line-height: 1.3;
    white-space: pre-line;
    font-family: 'Rubik', sans-serif;
  }
  
  .message-list li.unread {
    font-weight: bold;
  }
  
  /* 🔒 Style for fully disabled protocol steps after resolution */
  .disabled-step {
    opacity: 0.5;
    pointer-events: none;
    background-color: #f1f1f1;
  }
  
  .disabled-step button,
  .disabled-step textarea,
  .disabled-step select {
    cursor: not-allowed;
  }

  #globalTimer {
  opacity: 1 !important;
  background: linear-gradient(135deg, #007bff, #0056b3) !important;
  color: white; /* Ensures text inside shows up */
}

#timerDisplay {
  color: white;
  font-size: 2em;
  display: block;
  visibility: visible;
  font-family: "Courier New", monospace;
  font-weight: bold;
  margin: 8px 0;
}

#timerInfo {
  color: white;
  font-size: 0.8em;
  line-height: 1.3;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
  padding: 8px;
  margin: 8px 0;
  display: block;
  visibility: visible;
}

.middle-column-container {
  display: flex;
  flex-direction: column;
  gap: 15px;
  height: calc(100vh - 120px);
  overflow-y: auto;
  padding: 10px 0;
}

.global-timer {
  position: static !important;
  flex-shrink: 0;
}

.messaging-section {
  flex: 1;
  min-height: 200px;
}
      </style>
  </head>
  <body>
    <!-- Production View Toggle -->
    <button
      class="production-toggle"
      id="production-toggle"
      onclick="toggleProductionView()"
    >
      👁️ Production View
    </button>

    <!-- Demo Controls -->
<div class="demo-gear" id="demo-gear" onclick="toggleDemoPanel()"></div>
<div class="demo-panel" id="demo-panel">
    
    <div class="demo-section" id="gas-section">
        <h4 class="demo-section-header" onclick="toggleDemoSection('gas-section')">Gas Alert Tests</h4>
        <div class="demo-section-content">
            <div class="demo-button-grid">
                <button class="btn btn-primary" onclick="loadAlert('h2s-spontaneous')" title="H₂S High - Spontaneous Message">H₂S Spontaneous</button>
                <button class="btn btn-primary" onclick="loadAlert('h2s-response')" title="H₂S High - Response Test">H₂S Response</button>
                <button class="btn btn-primary" onclick="loadAlert('h2s-no-response')" title="H₂S High - No Response">H₂S No Reply</button>
                <button class="btn btn-primary" onclick="loadAlert('h2s-stays-high')" title="H₂S Stays HIGH + User OK">H₂S Stays High</button>
                <button class="btn btn-primary" onclick="loadAlert('h2s-normalizes')" title="H₂S Normalizes + User OK">H₂S Normalizes</button>
                <button class="btn btn-primary" onclick="loadAlert('co-spontaneous')" title="CO High - Spontaneous Message">CO Alert</button>
                <button class="btn btn-primary" onclick="loadAlert('o2-low')" title="O₂ Low - Test">O₂ Low</button>
            </div>
        </div>
    </div>

    <div class="demo-section" id="nongas-section">
        <h4 class="demo-section-header" onclick="toggleDemoSection('nongas-section')">Non-Gas Tests</h4>
        <div class="demo-section-content">
            <div class="demo-button-grid">
                <button class="btn btn-primary" onclick="loadAlert('fall-spontaneous')" title="Fall Detection - Spontaneous">Fall Spontaneous</button>
                <button class="btn btn-primary" onclick="loadAlert('fall-response')" title="Fall Detection - Response Test">Fall Response</button>
                <button class="btn btn-primary" onclick="loadAlert('fall-no-response')" title="Fall Detection - No Response">Fall No Reply</button>
                <button class="btn btn-primary" onclick="loadAlert('no-motion-spontaneous')" title="No Motion - Spontaneous">Motion Spontaneous</button>
                <button class="btn btn-primary" onclick="loadAlert('no-motion-no-response')" title="No Motion - No Response">Motion No Reply</button>
                <button class="btn btn-primary" onclick="loadAlert('sos-immediate')" title="SOS Alert - Immediate Help">SOS Alert</button>
            </div>
        </div>
    </div>

    <div class="demo-button-single">
        <button class="btn btn-secondary" onclick="clearAlert()">Clear Alert</button>
    </div>
</div>

    <!-- Alert Information Header -->
    <div class="header" id="alert-header">
      <h1 class="alert-title" id="alert-title">🚨 Alert Management</h1>

      <div class="alert-details">
        <div class="alert-info">
          <div class="info-item">
            <strong>Alert ID:</strong> <span id="alert-id">--</span>
          </div>
          <div class="info-item">
            <strong>Employee:</strong> <span id="employee-details">--</span>
          </div>
          <div class="info-item">
            <strong>Device:</strong> <span id="device-details">--</span>
          </div>
          <div class="info-item">
            <strong>Mobile:</strong> <span id="mobile-number">--</span>
          </div>
          <div class="info-item">
            <strong>Alert Time:</strong> <span id="alert-time">--</span>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- Column 1: Protocol Log + Add Note -->
      <div
        class="left-column"
        style="grid-column: 1; display: flex; flex-direction: column; gap: 15px"
      >
        <!-- Protocol Log -->
        <div class="protocol-log panel-box">
          <h3>📋 Protocol Log</h3>
          <div class="log-container" id="protocolLog">
            <div class="log-placeholder">
              No alert loaded. Use demo controls to load an alert type and begin
              protocol.
            </div>
          </div>
        </div>

        <!-- Add Note -->
        <div class="panel-box">
          <h3>📝 Add Note</h3>
          <textarea
            id="manual-notes"
            class="manual-notes"
            placeholder="Add notes here..."
          ></textarea>
          <button
            class="btn btn-success"
            style="margin-top: 10px"
            onclick="addManualNote()"
          >
            Post Note
          </button>
        </div>
      </div>

      <!-- Column 2: Global Timer + Messaging (Fixed) -->
<div class="middle-column-container" style="grid-column: 2;">
    <!-- Global Timer -->
    <div class="global-timer timer-inactive panel-box" id="globalTimer">
      <h3>⏰ Timer</h3>
      <div class="timer-display" id="timerDisplay">--:--</div>
      <div class="timer-info" id="timerInfo">
        <strong>No active timer</strong>
      </div>
      <div class="timer-controls">
        <button
          class="cancel-btn"
          id="cancelTimerBtn"
          disabled
          onclick="cancelGlobalTimer()"
        >
          🛑 Cancel Timer
        </button>
      </div>
      <div class="timer-meta" id="timerMeta">
        <span id="timerStart">--:--</span>
        <span id="timerEnd">--:--</span>
      </div>
    </div>
  
    <!-- Messaging UI -->
    <div class="messaging-section panel-box">
      <h3>📨 This device supports messaging</h3>
  
      <textarea
        id="manual-message-input"
        class="message-input"
        rows="2"
        maxlength="32"
        placeholder="Enter custom message..."
      ></textarea>
      <div class="char-counter" id="charCounter">32 characters remaining</div>
  
      <button
        class="btn btn-primary"
        id="sendMessageBtn"
        onclick="sendManualMessage()"
        disabled
      >
        📤 Send
      </button>
  
      <div class="message-history" id="messageHistory">
        <h4>📬 Messages from Device</h4>
        <ul class="message-list" id="receivedMessages"></ul>
      </div>
    </div>
  </div>


      <!-- Column 3: Emergency Steps -->
      <div class="steps-section panel-box" style="grid-column: 3">
        <h3>🚨 Emergency Response Protocol</h3>
        <div id="protocol-content">
          <div class="protocol-placeholder">
            <div class="protocol-frame">
              <div class="placeholder-text">No protocol loaded</div>
              <div class="placeholder-subtitle">
                Alert type will load the relevant emergency response protocol
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Column 4: Gas Readings + Connectivity -->
<div
class="right-column"
style="
  grid-column: 4;
  display: flex;
  flex-direction: column;
  gap: 15px;
"
>
<!-- Gas Readings -->
<div class="panel-box" id="gasReadingsCard">
  <h3>🔎 Gas Readings (Live)</h3>
  <div class="triggered-by" id="triggeredBy" style="display: none">
    Alert Type: <span id="alert-trigger">--</span>
  </div>
  <div class="gas-reading" id="h2s-reading">
    <span>🟢 H₂S: <span class="gas-value" id="h2s-value">1.20 ppm</span></span>
    <span class="gas-status normal" id="h2s-status">NORMAL</span>
  </div>
  <div class="gas-reading" id="co-reading">
    <span>🟢 CO: <span class="gas-value" id="co-value">2.50 ppm</span></span>
    <span class="gas-status normal" id="co-status">NORMAL</span>
  </div>
  <div class="gas-reading" id="o2-reading">
    <span>🟢 O₂: <span class="gas-value" id="o2-value">20.90 %vol</span></span>
    <span class="gas-status normal" id="o2-status">NORMAL</span>
  </div>
  <div class="gas-reading" id="lel-reading">
    <span>🟢 LEL: <span class="gas-value" id="lel-value">0.50 %LEL</span></span>
    <span class="gas-status normal" id="lel-status">NORMAL</span>
  </div>
  <div class="last-updated" id="lastUpdated" style="display: none">
    Last updated: <span id="gas-timestamp">--</span>
  </div>
</div>

<!-- Connectivity Panel -->
<div class="panel-box" id="connectivityPanel">
    <h3>📡 Connectivity & Location</h3>
    
    <!-- Connectivity Section -->
    <div class="device-status">
      <strong>Device:</strong>
      <span id="device-online-status" class="status-pill loading">Loading...</span>
    </div>
    <div class="last-comm">
      <strong>Last Communication:</strong>
      <span id="last-comm-time">--</span>
    </div>
    <div class="battery-status">
      <strong>Battery:</strong>
      <span id="battery-level">--</span>
    </div>
    <div class="signal-status">
      <strong>Signal Strength:</strong>
      <span id="signal-strength">--</span>
    </div>
    
    <!-- Spacing between sections -->
    <div style="height: 15px;"></div>
    
    <!-- Location Section -->
    <div class="location-updated">
      <strong>⏰ Last Location:</strong>
      <span id="location-timestamp">--</span>
    </div>
    <div class="location-address">
      <strong>📍 Location:</strong>
      <span id="device-location">--</span>
    </div>
    <div class="location-coords">
      <strong>📍 Latitude / Longitude:</strong>
      <span id="device-coordinates">--</span>
    </div>
    <div class="location-speed">
      <strong>🚗 Speed:</strong>
      <span id="device-speed">--</span>
    </div>
  </div>
</div>

      </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════
    // 🔧 1. UTILITY FUNCTIONS
    // ═══════════════════════════════════════════════════════════════
    
    // 🔹 Gets current H₂S gas reading for override/validation logic
    function getCurrentGasReading() {
        try {
            const h2sReading = document.getElementById('h2s-reading');
            const h2sStatusElement = document.getElementById('h2s-status');
            
            let value = 'N/A';
            let status = 'UNKNOWN';
            
            // Get value from the gas-value span within h2s-reading
            if (h2sReading) {
                const gasValueSpan = h2sReading.querySelector('.gas-value');
                if (gasValueSpan) {
                    const rawValueText = gasValueSpan.textContent || '';
                    const valueMatch = rawValueText.match(/[\d.]+/);
                    value = valueMatch ? valueMatch[0] : 'N/A';
                }
            }
            
            // Get status from h2s-status element
            if (h2sStatusElement) {
                status = h2sStatusElement.textContent.trim() || 'UNKNOWN';
            }
            
            return {
                type: 'H₂S',
                value: value,
                unit: ' ppm',
                status: status
            };
        } catch (e) {
            console.warn('Gas reading error:', e);
            return { type: 'H₂S', value: 'N/A', unit: ' ppm', status: 'UNKNOWN' };
        }
    }
    
    // 🔹 Gets action icon for protocol steps
    function getActionIcon(action) {
        const icons = {
            "Call G7c Device": "📞",
            "Send Message": "📱",
            "Call User": "📞",
            "Contact Emergency Contacts": "👥",
            "Dispatch Services": "🚑",
            "Dispatch EMS": "🚑",
            "Call Device": "📞",
            "Immediate Dispatch": "🚨",
            "Conditional Dispatch": "⚠️",
            "Send Reminder": "📨",
            "Escalate": "⬆️"
        };
        return icons[action] || "▶️";
    }
    
    // 🔹 Adds a log entry to the protocol log panel with optional gas data
    function addLogEntry(message, type = "general", source = null, customTime = null, includeGasData = false) {
    const logContainer = document.getElementById("protocolLog");
    const placeholder = logContainer.querySelector(".log-placeholder");

    if (placeholder) {
        placeholder.remove();
    }

    const entry = document.createElement("div");
    entry.className = "log-entry " + (type || "general");

    let timestamp, operator;

    if (customTime) {
        timestamp = customTime;
        operator = "";
    } else {
        // Create full date + time with both EDT and MDT
        const now = new Date();
        
        // Get EDT time (Eastern)
        const edtTime = now.toLocaleString("en-US", {
            year: "numeric",
            month: "2-digit", 
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
            timeZone: "America/New_York"
        });
        
        // Get MDT time (Mountain)
        const mdtTime = now.toLocaleTimeString("en-US", {
            hour12: false,
            timeZone: "America/Denver",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
        });
        
        // Format: [2025-07-20 01:33:43 EDT - 23:34:15 MDT]
        timestamp = `${edtTime.replace(/(\d{2})\/(\d{2})\/(\d{4}), /, '$3-$1-$2 ')} EDT - ${mdtTime} MDT`;
        operator = '<span style="float: right;">Op 417</span>';
    }

    let logMessage = message;

    // Add gas data if this is a gas alert and gas data is requested
    if (includeGasData && currentAlert && currentAlert.id === "gas-high-threshold") {
        const gasReading = getCurrentGasReading();
        logMessage += `. Gas level: ${gasReading.status} – Gas Reading: ${gasReading.type}: ${gasReading.value}${gasReading.unit}`;
    }

    if (source) {
        entry.innerHTML = "<strong>" + source + "</strong><br>2025-07-20 " + timestamp + "<br>" + logMessage;
    } else {
        entry.innerHTML = "[" + timestamp + "] " + logMessage + " " + operator;
    }

    logContainer.insertBefore(entry, logContainer.firstChild);
}
    
    // 🔹 Formats alert time with relative timestamp
    function formatAlertTime(alertDate) {
        const now = new Date();
        const diffMinutes = Math.floor((now - alertDate) / 60000);
    
        const timeStr = alertDate.toLocaleDateString("en-US", {
            month: "2-digit",
            day: "2-digit",
            year: "numeric",
        }) + " " + alertDate.toLocaleTimeString("en-US", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
        }) + " MDT";
    
        let timeAgo = "";
        if (diffMinutes === 0) timeAgo = "(just now)";
        else if (diffMinutes === 1) timeAgo = "(-1 minute ago)";
        else if (diffMinutes < 60) timeAgo = `(-${diffMinutes} minutes ago)`;
        else if (diffMinutes < 1440) timeAgo = `(-${Math.floor(diffMinutes / 60)} hours ago)`;
        else timeAgo = `(-${Math.floor(diffMinutes / 1440)} days ago)`;
    
        return `${timeStr} ${timeAgo}`;
    }

    // 🔹 Gets timer duration for any protocol step
function getStepTimer(stepId) {
    if (!currentAlert || !currentAlert.id) {
        console.warn('No current alert found, using default timer');
        return 120; // Default 2 minutes
    }
    
    const protocolConfig = ProtocolFactory.getProtocolConfig(currentAlert.id);
    if (!protocolConfig) {
        console.warn(`Protocol config not found for alert ${currentAlert.id}, using default timer`);
        return 120;
    }
    
    const stepConfig = protocolConfig.steps.find(step => step.id === stepId);
    if (!stepConfig) {
        console.warn(`Step config not found for ${stepId}, using default timer`);
        return 120;
    }
    
    return stepConfig.timer || 120; // Return configured timer or default 2 minutes
}
    
    // 🔹 Messaging utility functions
    function splitIntoTwoLines(text) {
        if (text.length <= 16) return text;
        return text.slice(0, 16) + "\n" + text.slice(16, 32);
    }
    
// 🔹 Starts tab title flashing for alerts
function startTabFlashing(alertText) {
    stopTabFlashing(); // Clear any existing flashing
    
    let isAlert = false;
    tabFlashInterval = setInterval(() => {
        document.title = isAlert ? originalTitle : alertText;
        isAlert = !isAlert;
    }, 1000);
}

// 🔹 Stops tab title flashing
function stopTabFlashing() {
    if (tabFlashInterval) {
        clearInterval(tabFlashInterval);
        tabFlashInterval = null;
        document.title = originalTitle;
    }
}

    // ═══════════════════════════════════════════════════════════════
    // 📊 2. DATA MANAGEMENT & STATE
    // ═══════════════════════════════════════════════════════════════
    
    // 🔹 Global state variables
    let currentAlert = null;
    let currentUser = null;
    let gasUpdateInterval = null;
    let dispatchMade = false;
    let globalTimerInterval = null;
    let activeTimerData = null;
    let globalTimerEndTime = null;
    let tabFlashInterval = null;
    let localTimerInterval = null;
    let beepTimeouts = [];
    let originalTitle = "Enhanced Blackline Live - Alert Management";
    
    
    // 🔹 Protocol state management
    let protocolState = {
        completedSteps: [],
        currentStep: 1,
        dispatchMade: false,
        alertResolved: false,
        deviceMessageReceived: false,
        currentProtocol: null,
    };
    
    // 🔹 Gas readings data
const gasReadingsData = {
    // New test scenarios
    "h2s-high": {
        h2s: { value: 17.90, status: "HIGH" },
        co: { value: 2.50, status: "NORMAL" },
        o2: { value: 20.90, status: "NORMAL" },
        lel: { value: 4.00, status: "NORMAL" }
    },
    "h2s-stays-high": {
        h2s: { value: 17.90, status: "HIGH" },
        co: { value: 2.50, status: "NORMAL" },
        o2: { value: 20.90, status: "NORMAL" },
        lel: { value: 4.00, status: "NORMAL" }
    },
    "h2s-normalizes": {
        h2s: { value: 17.90, status: "HIGH" },
        co: { value: 2.50, status: "NORMAL" },
        o2: { value: 20.90, status: "NORMAL" },
        lel: { value: 4.00, status: "NORMAL" }
    },
    "co-high": {
        h2s: { value: 1.20, status: "NORMAL" },
        co: { value: 250.00, status: "HIGH" },
        o2: { value: 20.90, status: "NORMAL" },
        lel: { value: 0.50, status: "NORMAL" }
    },
    "o2-low": {
        h2s: { value: 1.20, status: "NORMAL" },
        co: { value: 2.50, status: "NORMAL" },
        o2: { value: 15.50, status: "LOW" },
        lel: { value: 0.50, status: "NORMAL" }
    },
    // Keep existing for backward compatibility
    "gas-high-threshold": {
        h2s: { value: 17.9, status: "HIGH" },
        co: { value: 2.5, status: "NORMAL" },
        o2: { value: 20.9, status: "NORMAL" },
        lel: { value: 4.0, status: "NORMAL" },
    },
    default: {
        h2s: { value: 1.2, status: "NORMAL" },
        co: { value: 2.5, status: "NORMAL" },
        o2: { value: 20.9, status: "NORMAL" },
        lel: { value: 0.5, status: "NORMAL" },
    },
};
    
    // 🔹 API-Ready Data Management System
    class AlertDataManager {
        static usersData = {
            "zach-sowell": {
                id: "373595",
                name: "Zach Sowell",
                device: "G7c-3571031421",
                mobile: "+1 470-505-6195",
                company: "WM - Corporate",
                work: "+1 470-505-6195",
                home: "+1 208-995-4975",
                emergencyContacts: [
                    { name: "Daniel Reyes", phone: "+1-587-333-9271", role: "Site Supervisor" },
                    { name: "Vanessa Liu", phone: "+1-780-452-1189", role: "Control Room Operator" },
                ],
            },
            "marcus-rodriguez": {
                id: "428756",
                name: "Marcus Rodriguez",
                device: "G7c-2947182653",
                mobile: "+1 403-555-0167",
                company: "Enbridge Pipelines",
                work: "+1 403-555-0167",
                home: "+1 403-555-0168",
                emergencyContacts: [
                    { name: "Mike Chen", phone: "+1-403-555-0123", role: "Site Supervisor" },
                    { name: "Sarah Kim", phone: "+1-403-555-0124", role: "Safety Coordinator" },
                ],
            },
        };
    
        static alertTypesData = {
    // Gas Alert Test Scenarios
    "h2s-spontaneous": {
        id: "h2s-spontaneous",
        displayName: "High threshold detected (H₂S) - Spontaneous",
        user: "zach-sowell",
        protocolFile: "gas-emergency-protocol",
        gasType: "h2s-high",
        testType: "spontaneous"
    },
    "h2s-response": {
        id: "h2s-response",
        displayName: "High threshold detected (H₂S) - Response",
        user: "zach-sowell",
        protocolFile: "gas-emergency-protocol",
        gasType: "h2s-high",
        testType: "response"
    },
    "h2s-no-response": {
        id: "h2s-no-response",
        displayName: "High threshold detected (H₂S) - No Response",
        user: "zach-sowell",
        protocolFile: "gas-emergency-protocol",
        gasType: "h2s-high",
        testType: "no-response"
    },
    "h2s-stays-high": {
        id: "h2s-stays-high",
        displayName: "High threshold detected (H₂S) - Stays High",
        user: "zach-sowell",
        protocolFile: "gas-emergency-protocol",
        gasType: "h2s-stays-high",
        testType: "spontaneous"
    },
    "h2s-normalizes": {
        id: "h2s-normalizes",
        displayName: "High threshold detected (H₂S) - Normalizes",
        user: "zach-sowell",
        protocolFile: "gas-emergency-protocol",
        gasType: "h2s-normalizes",
        testType: "spontaneous"
    },
    "co-spontaneous": {
        id: "co-spontaneous",
        displayName: "High threshold detected (CO)",
        user: "marcus-rodriguez",
        protocolFile: "gas-emergency-protocol",
        gasType: "co-high",
        testType: "spontaneous"
    },
    "o2-low": {
        id: "o2-low",
        displayName: "Low threshold detected (O₂)",
        user: "zach-sowell",
        protocolFile: "gas-emergency-protocol",
        gasType: "o2-low",
        testType: "spontaneous"
    },
    
    // Non-Gas Alert Test Scenarios
    "fall-spontaneous": {
        id: "fall-spontaneous",
        displayName: "Fall detection - Spontaneous",
        user: "marcus-rodriguez",
        protocolFile: "fall-detection-protocol",
        gasType: "default",
        testType: "spontaneous"
    },
    "fall-response": {
        id: "fall-response",
        displayName: "Fall detection - Response",
        user: "marcus-rodriguez",
        protocolFile: "fall-detection-protocol",
        gasType: "default",
        testType: "response"
    },
    "fall-no-response": {
        id: "fall-no-response",
        displayName: "Fall detection - No Response",
        user: "marcus-rodriguez",
        protocolFile: "fall-detection-protocol",
        gasType: "default",
        testType: "no-response"
    },
    "no-motion-spontaneous": {
        id: "no-motion-spontaneous",
        displayName: "No motion - Spontaneous",
        user: "marcus-rodriguez",
        protocolFile: "no-motion-protocol",
        gasType: "default",
        testType: "spontaneous"
    },
    "no-motion-no-response": {
        id: "no-motion-no-response",
        displayName: "No motion - No Response",
        user: "marcus-rodriguez",
        protocolFile: "no-motion-protocol",
        gasType: "default",
        testType: "no-response"
    },
    "sos-immediate": {
        id: "sos-immediate",
        displayName: "SOS alert - Immediate Help",
        user: "zach-sowell",
        protocolFile: "sos-protocol",
        gasType: "default",
        testType: "immediate-help"
    },
    
    // Keep original alerts for backward compatibility
    "gas-high-threshold": {
        id: "gas-high-threshold",
        displayName: "High threshold detected (H₂S)",
        user: "zach-sowell",
        protocolFile: "gas-emergency-protocol",
        gasType: "h2s-high",
        testType: "legacy"
    },
    "fall-detection": {
        id: "fall-detection",
        displayName: "Fall detection detected",
        user: "marcus-rodriguez",
        protocolFile: "fall-detection-protocol",
        gasType: "default",
        testType: "legacy"
    },
    sos: {
        id: "sos",
        displayName: "SOS alert activated",
        user: "zach-sowell",
        protocolFile: "sos-protocol",
        gasType: "default",
        testType: "legacy"
    },
    "no-motion": {
        id: "no-motion",
        displayName: "No motion detected",
        user: "marcus-rodriguez",
        protocolFile: "no-motion-protocol",
        gasType: "default",
        testType: "legacy"
    },
    "missed-check-in": {
        id: "missed-check-in",
        displayName: "Missed check-in",
        user: "zach-sowell",
        protocolFile: "check-in-protocol",
        gasType: "default",
        testType: "legacy"
    }
};
    }
    
    // 🔹 Smart Protocol Factory
    class ProtocolFactory {
        static protocolsData = {
            "gas-emergency-protocol": {
                name: "Gas Emergency Protocol",
                steps: [
                    { id: "step-1", title: "STEP 1: Call the G7c device and validate the need for assistance", action: "Call G7c Device" },
                    { id: "step-2", title: "STEP 2: Send text 'Do you need help?' to device and wait 2 minutes", action: "Send Message", timer: 120 },
                    { id: "step-3", title: "STEP 3: Call the phone number assigned to the user", action: "Call User" },
                    { id: "step-4", title: "STEP 4: Contact emergency contacts in order of priority", action: "Contact Emergency Contacts" },
                    { id: "step-5", title: "STEP 5: Dispatch emergency services (EMS and Fire)", action: "Dispatch Services" },
                ],
            },
            "fall-detection-protocol": {
                name: "Fall Detection Protocol",
                steps: [
                    { id: "step-1", title: "STEP 1: Send message 'Do you need help?' and wait 2 minutes", action: "Send Message", timer: 120 },
                    { id: "step-2", title: "STEP 2: Call user assigned phone number", action: "Call User" },
                    { id: "step-3", title: "STEP 3: Contact emergency contacts in priority order", action: "Contact Emergency Contacts" },
                    { id: "step-4", title: "STEP 4: Dispatch emergency services (EMS)", action: "Dispatch EMS" },
                ],
            },
            "sos-protocol": {
                name: "SOS Emergency Protocol",
                steps: [
                    { id: "step-1", title: "STEP 1: Call the device immediately", action: "Call Device" },
                    { id: "step-2", title: "STEP 2: Call user phone number", action: "Call User" },
                    { id: "step-3", title: "STEP 3: Contact emergency contacts", action: "Contact Emergency Contacts" },
                    { id: "step-4", title: "STEP 4: Dispatch emergency services immediately", action: "Immediate Dispatch" },
                ],
            },
            "no-motion-protocol": {
                name: "No Motion Detection Protocol",
                steps: [
                    { id: "step-1", title: "STEP 1: Send message 'Do you need help?' and wait 5 minutes", action: "Send Message", timer: 300 },
                    { id: "step-2", title: "STEP 2: Call user phone number", action: "Call User" },
                    { id: "step-3", title: "STEP 3: Contact emergency contacts", action: "Contact Emergency Contacts" },
                    { id: "step-4", title: "STEP 4: Dispatch if no response", action: "Conditional Dispatch" },
                ],
            },
            "check-in-protocol": {
                name: "Missed Check-In Protocol",
                steps: [
                    { id: "step-1", title: "STEP 1: Call user phone number immediately", action: "Call User" },
                    { id: "step-2", title: "STEP 2: Send message reminder", action: "Send Reminder" },
                    { id: "step-3", title: "STEP 3: Contact emergency contacts", action: "Contact Emergency Contacts" },
                    { id: "step-4", title: "STEP 4: Escalate if no contact", action: "Escalate" },
                ],
            },
        };
    
        static getProtocolConfig(alertType) {
            const alertConfig = AlertDataManager.alertTypesData[alertType];
            return this.protocolsData[alertConfig.protocolFile];
        }
    }
    
    // 🔹 Enhanced Logging System
    class EnhancedLogger {
        static addLogEntry(message, type = "general", source = null, customTime = null, includeGasData = false) {
            addLogEntry(message, type, source, customTime, includeGasData);
        }
    
        static addGasLogEntry(message, stepId = null) {
            this.addLogEntry(message, stepId ? "step" : "gas", null, null, true);
        }
    }
    
    // 🔹 Enhanced Device Connectivity with BlackLine Logic
    class DeviceConnectivity {
        static currentStatus = {
            online: true,
            lastCommunication: new Date(),
            battery: 85,
            signal: 70,
            connectionType: "Cellular",
        };
    
        static isDeviceOnline() {
            const info = this.currentStatus;
            if (!info) return false;
    
            // BlackLine connectivity criteria:
            const lastComm = new Date(info.lastCommunication);
            const now = new Date();
            const diffMinutes = (now - lastComm) / (1000 * 60);
            if (diffMinutes > 30) return false; // Last communication ≤ 30 minutes ago
            if (info.battery <= 10) return false; // Battery > 10%
            if (info.signal <= 10) return false; // Signal strength > 10%
    
            return true;
        }
    
        static updateConnectivityDisplay() {
            const panel = document.getElementById("connectivityPanel");
            const statusElement = document.getElementById("device-online-status");
            const lastCommElement = document.getElementById("last-comm-time");
            const batteryElement = document.getElementById("battery-level");
            const signalElement = document.getElementById("signal-strength");
    
            if (!this.currentStatus) {
                if (panel) panel.style.display = "none";
                return;
            } else {
                if (panel) panel.style.display = "";
            }
    
            const isOnline = this.isDeviceOnline();
    
            // Status badge
            if (statusElement) {
                if (isOnline) {
                    statusElement.textContent = "🟢 Online";
                    statusElement.className = "status-pill online";
                } else {
                    statusElement.textContent = "🔴 Offline";
                    statusElement.className = "status-pill offline";
                }
            }
    
            // Battery with color coding
            if (batteryElement) {
                batteryElement.textContent = "85%";
                batteryElement.style.color = "#28a745"; // Green for 85%
            }
    
            // Signal strength
            if (signalElement) {
                signalElement.textContent = "20%";
            }
    
            // Last communication
            if (lastCommElement) {
                const lastComm = new Date(this.currentStatus.lastCommunication);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastComm) / 60000);
    
                const timeStr = lastComm.toLocaleTimeString("en-US", {
                    hour12: false,
                    timeZone: "America/Denver",
                    hour: "2-digit",
                    minute: "2-digit",
                }) + " MDT";
    
                let timeAgo = "";
                if (diffMinutes === 0) timeAgo = "(just now)";
                else if (diffMinutes === 1) timeAgo = "(1 minute ago)";
                else if (diffMinutes < 60) timeAgo = `(${diffMinutes} minutes ago)`;
                else {
                    const hours = Math.floor(diffMinutes / 60);
                    const mins = diffMinutes % 60;
                    timeAgo = `(${hours}h${mins > 0 ? ` ${mins}m` : ""} ago)`;
                }
    
                lastCommElement.textContent = `${timeStr} ${timeAgo}`;
                lastCommElement.style.color = diffMinutes > 5 || !isOnline ? "#dc3545" : "";
                lastCommElement.style.fontWeight = diffMinutes > 5 || !isOnline ? "bold" : "";
            }
        }
    
        // Test Scenarios for Demo/Testing
        static setDeviceOnlineScenario() {
            this.currentStatus = {
                online: true,
                lastCommunication: new Date(Date.now() - 5 * 60 * 1000), // 5 min ago
                battery: 85,
                signal: 70,
                connectionType: "Cellular",
            };
            this.updateConnectivityDisplay();
        }
    
        static setDeviceOfflineScenario(reason = "battery") {
            const scenarios = {
                battery: { lastCommunication: new Date(Date.now() - 10 * 60 * 1000), battery: 0, signal: 60 },
                signal: { lastCommunication: new Date(Date.now() - 15 * 60 * 1000), battery: 80, signal: 0 },
                communication: { lastCommunication: new Date(Date.now() - 45 * 60 * 1000), battery: 80, signal: 60 },
            };
    
            this.currentStatus = { online: false, connectionType: "Cellular", ...scenarios[reason] };
            this.updateConnectivityDisplay();
        }
    
        // Legacy methods for backward compatibility
        static forceOffline() { this.setDeviceOfflineScenario("battery"); }
        static forceOnline() { this.setDeviceOnlineScenario(); }
    }
    
    // ═══════════════════════════════════════════════════════════════
    // ⏱️ 3. TIMER MANAGEMENT
    // ═══════════════════════════════════════════════════════════════
    
    // 🔹 Enhanced startGlobalTimer with proper logging and state management
    function startGlobalTimer(stepId, label, contactName = "", durationInSeconds = 1800) {
  // DEBUG: Check what parameters we received
  console.log('startGlobalTimer called with:');
  console.log('stepId:', stepId, typeof stepId);
  console.log('label:', label, typeof label);
  console.log('contactName:', contactName, typeof contactName);
  console.log('durationInSeconds:', durationInSeconds, typeof durationInSeconds);

  // ✅ SET activeTimerData (was missing!)
  activeTimerData = { stepId, label, contactName, durationInSeconds };
  
  // Clear any existing timer first
  if (globalTimerInterval) {
    clearInterval(globalTimerInterval);
    addLogEntry("⏹️ Cancelled previous timer", "timer");
  }

  const display = document.getElementById("timerDisplay");
  const info = document.getElementById("timerInfo");
  const globalTimer = document.getElementById("globalTimer");
  const startTime = new Date();

  // Set global end time for state tracking
  globalTimerEndTime = new Date(startTime.getTime() + durationInSeconds * 1000);

  // Update timer metadata
  const timerStart = document.getElementById("timerStart");
  const timerEnd = document.getElementById("timerEnd");
  if (timerStart) timerStart.textContent = startTime.toLocaleTimeString("en-US", {
      hour12: false,
      hour: "2-digit",
      minute: "2-digit", 
      second: "2-digit"
  }) + " hrs.";
  if (timerEnd) timerEnd.textContent = globalTimerEndTime.toLocaleTimeString("en-US", {
      hour12: false,
      hour: "2-digit",
      minute: "2-digit", 
      second: "2-digit"
  }) + " hrs.";

  // Update header
  info.innerHTML = contactName
    ? `<strong>${label}</strong><br>${contactName}`
    : `<strong>${label}</strong>`;

  // ✅ Build dropdown directly (just like 2-min timer)
  const controls = document.querySelector(".timer-controls");
  controls.innerHTML = `
    <select data-cy="global-cancel-dropdown" onchange="handleGlobalTimerCancellation(this.value)" 
            class="btn btn-secondary" 
            style="padding: 8px 16px; font-size: 0.8em; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background 0.2s; width: 100%;"            
            aria-label="Cancel response timer">
      <option value="">🛑 Cancel Timer</option>
      <option value="user-callback">User called in and confirmed they are OK</option>
      <option value="ec-callback">Emergency contact called in and confirmed user is OK</option>
      <option value="ec-callback-30min">Emergency contact called in - Will contact user and call back (30 min timer)</option>
      <option value="device-offline">Device went offline</option>
      <option value="custom">Type reason</option>
    </select>
  `;

  // ✅ Start visual state
  globalTimer.classList.remove("timer-inactive");
  globalTimer.classList.add("timer-active");
  globalTimer.style.opacity = "1";
  globalTimer.style.display = "block";

  // Log proper Step 2 message (only for step-2)
  if (stepId === 'step-2') {
    addLogEntry('📤 Sent "Do you need help?" to device, waiting 2 minutes for device reply.', 'step');
  } else {
    // Keep original logging for other timers
    const durationMinutes = Math.floor(durationInSeconds / 60);
    const logMessage = contactName
      ? `⏰ Started ${durationMinutes}-minute timer: ${label} for ${contactName}`
      : `⏰ Started ${durationMinutes}-minute timer: ${label}`;
    addLogEntry(logMessage, "timer");
  }

  function updateDisplay() {
    const now = new Date();
    const remaining = Math.max(0, Math.floor((globalTimerEndTime - now) / 1000));
    const mins = String(Math.floor(remaining / 60)).padStart(2, "0");
    const secs = String(remaining % 60).padStart(2, "0");
    display.textContent = `${mins}:${secs}`;

    if (remaining <= 0) {
      clearInterval(globalTimerInterval);
      globalTimerInterval = null;
      globalTimerEndTime = null;

      display.textContent = "00:00";
      info.innerHTML = `<strong>⏰ Timer expired</strong>`;

      // 🔊 Optional audio
      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(800, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.5);
      } catch (e) {
        console.warn("🔇 Audio not supported.");
      }
// 🚨 Visual alert - Tab flashing
startTabFlashing("🚨 TIMER EXPIRED");

      // Clear dropdown after expiry
      document.querySelector(".timer-controls").innerHTML = "";

      // Log proper expiry message
      console.log('Timer expired! activeTimerData:', activeTimerData);
      console.log('stepId check:', activeTimerData?.stepId === 'step-2');

      if (activeTimerData && activeTimerData.stepId === 'step-2') {
        console.log('Adding Step 2 expiry log');
        addLogEntry('⏰ TIMER EXPIRED: No reply received from device. Proceed to Step 3', 'timer');
        
        // Mark Step 2 as completed
        markStepComplete('step-2');
        
        // Unlock Step 3
        console.log('Calling enableNextStep');
        enableNextStep('step-2');
      } else {
        console.log('Using default expiry log');
        // Keep original logging for other timers
        const expiredMessage = contactName
          ? `⏰ TIMER EXPIRED: ${label} for ${contactName}`
          : `⏰ TIMER EXPIRED: ${label}`;
        addLogEntry(expiredMessage, "timer");
      }

      // Optional: Add gas reading log
      if (currentAlert && currentAlert.id === 'gas-high-threshold') {
        const gasReading = getCurrentGasReading();
        addLogEntry(`Gas level: ${gasReading.status}\nGas Reading: ${gasReading.type}: ${gasReading.value}${gasReading.unit}`, 'timer');
      }
    }
  }

  updateDisplay();
  globalTimerInterval = setInterval(updateDisplay, 1000);
}

    
    // 🔹 Enhanced cancelGlobalTimer with matching logic to handleTimerCancellation
function cancelGlobalTimer() {
    if (!globalTimerInterval) return;
    
    // Show dropdown to get cancellation reason (similar to 2-min timer)
    const cancelBtn = document.getElementById("cancelTimerBtn");
    const info = document.getElementById("timerInfo");
    
    // Replace cancel button with dropdown temporarily
    const originalCancelHTML = cancelBtn.outerHTML;
    cancelBtn.outerHTML = `
        <select onchange="handleGlobalTimerCancellation(this.value)" 
                style="padding: 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
            <option value="">🛑 Cancel Timer</option>
            <option value="user-callback">User called back and confirmed they are OK</option>
            <option value="ec-callback">Emergency contact called in and confirmed user is OK</option>
            <option value="ec-callback-30min">Emergency contact called in - Will contact user and call back (30 min timer)</option>
            <option value="custom">Type reason</option>
        </select>
    `;
}

// 🔹 Handles global timer cancellation with reason selection (matches handleTimerCancellation)
function handleGlobalTimerCancellation(reason) {
  if (!reason) return;

  // Prevent multiple calls
  if (!globalTimerInterval) {
    console.warn("No active timer to cancel");
    return;
  }

  // Stop the timer
  clearInterval(globalTimerInterval);
  globalTimerInterval = null;
  globalTimerEndTime = null;

  // Reset UI
  const display = document.getElementById("timerDisplay");
  const info = document.getElementById("timerInfo");
  const timer = document.getElementById("globalTimer");

  display.textContent = "--:--";
  info.innerHTML = "<strong>No active timer</strong>";
  timer.classList.remove("timer-active");
  timer.classList.add("timer-inactive");

  // Restore cancel button (remove dropdown)
  const dropdown = timer.querySelector("select");
  if (dropdown) {
    dropdown.outerHTML = `<button class="cancel-btn" id="cancelTimerBtn" disabled onclick="cancelGlobalTimer()">🛑 Cancel Timer</button>`;
  }

  // Handle each reason
  let logMessage = "Step 2: Timer cancelled - ";

  if (reason === "user-callback") {
    logMessage += "User called in and confirmed they are OK. Resolving alert.";
    
    // Log immediately and complete
    addLogEntry(logMessage, "timer");
    
    // Add gas data as separate plain text for gas alerts
    if (currentAlert && (currentAlert.id === 'gas-high-threshold' || currentAlert.gasType)) {
        const gasReading = getCurrentGasReading();
        const logContainer = document.getElementById('protocolLog');
        const gasDetails = document.createElement('div');
        gasDetails.innerHTML = `
            <div style="margin-left: 20px; color: #333; font-size: 0.9em; line-height: 1.4;">
                Gas Type: ${gasReading.type}<br>
                Gas Level: ${gasReading.status}<br>
                Gas Reading: ${gasReading.value}${gasReading.unit}
            </div>
        `;
        // Insert after the latest log entry
        const logEntries = logContainer.querySelectorAll('.log-entry');
        if (logEntries.length >= 1) {
            logContainer.insertBefore(gasDetails, logEntries[0].nextSibling);
        }
    }
    
    markStepComplete("step-2");
    console.log('DEBUG: Called markStepComplete for: step-2');
    handleConfirmedOK("step-2");

  } else if (reason === "ec-callback") {
    logMessage += "Emergency contact called in and confirmed user is OK. Resolving alert.";
    
    // Log immediately and complete
    addLogEntry(logMessage, "timer");
    
    // Add gas data as separate plain text for gas alerts
    if (currentAlert && (currentAlert.id === 'gas-high-threshold' || currentAlert.gasType)) {
        const gasReading = getCurrentGasReading();
        const logContainer = document.getElementById('protocolLog');
        const gasDetails = document.createElement('div');
        gasDetails.innerHTML = `
            <div style="margin-left: 20px; color: #333; font-size: 0.9em; line-height: 1.4;">
                Gas Type: ${gasReading.type}<br>
                Gas Level: ${gasReading.status}<br>
                Gas Reading: ${gasReading.value}${gasReading.unit}
            </div>
        `;
        // Insert after the latest log entry
        const logEntries = logContainer.querySelectorAll('.log-entry');
        if (logEntries.length >= 1) {
            logContainer.insertBefore(gasDetails, logEntries[0].nextSibling);
        }
    }
    
    markStepComplete("step-2");
    console.log('DEBUG: Called markStepComplete for: step-2');
    handleConfirmedOK("step-2");

  } else if (reason === "ec-callback-30min") {
    logMessage = "Step 2: Timer cancelled - Emergency contact called SOC and was provided alert details. Emergency contact will reach out to user and call back within 30 minutes.";
    addGasReadingIfApplicable(logMessage, () => {
      addLogEntry(logMessage, "timer");
      startGlobalTimer("step-2", "Call back Emergency contact for an update", "Emergency Contact", 1800);
    });

  } else if (reason === "device-offline") {
    logMessage += "Device went offline. Proceed to Step 3.";
    addGasReadingIfApplicable(logMessage, () => {
      addLogEntry(logMessage, "timer");
      markStepComplete("step-2");
      enableNextStep("step-2");
    });

  } else if (reason === "custom") {
    const custom = prompt("Enter custom cancellation reason:");
    const finalMessage = custom
      ? `Step 2: Timer cancelled - ${custom}`
      : "Step 2: Timer cancelled";
    addLogEntry(finalMessage, "timer");
    markStepComplete("step-2");
    enableNextStep("step-2");
  }

  console.log(`✅ Global timer cancelled. Reason: ${reason}`);
}

stopTabFlashing();
            
// 🔧 Helper for gas reading injection
function addGasReadingIfApplicable(logMessage, callback) {
  if (currentAlert && currentAlert.id === "gas-high-threshold") {
    try {
      const gasReading = getCurrentGasReading();
      logMessage += `\n\nGas level: ${gasReading.status}\nGas Reading: ${gasReading.type}: ${gasReading.value}${gasReading.unit}`;
    } catch (e) {
      console.warn("Could not get gas reading:", e);
    }
  }
  callback();
}

    // ═══════════════════════════════════════════════════════════════
    // 🚨 4. PROTOCOL CONTROL FUNCTIONS
    // ═══════════════════════════════════════════════════════════════
    
    // 🔹 Initializes alert state when loading new alert
    function initializeAlert(alertConfig, userConfig) {
        protocolState = {
            completedSteps: [],
            currentStep: 1,
            dispatchMade: false,
            alertResolved: false,
            deviceMessageReceived: false,
            currentProtocol: alertConfig.protocolFile,
        };
    }

// 🔹 Checks if this step involves sending a message
function isMessagingStep(stepId) {
    if (!currentAlert || !currentAlert.id) return false;
    
    const protocolConfig = ProtocolFactory.getProtocolConfig(currentAlert.id); // Use currentAlert.id
    const stepConfig = protocolConfig.steps.find(step => step.id === stepId);
    
    return stepConfig && stepConfig.action === 'Send Message';
}

function startStep(stepId) {
    console.log('startStep called with:', stepId);

    // Show outcome section for all steps EXCEPT Step 2 (which uses global timer)
    if (stepId !== 'step-2') {
        const outcomeSection = document.getElementById(stepId + "-outcome");
        if (outcomeSection) {
            outcomeSection.style.display = "block";
        }
    }
    
    // Handle Step 2 messaging for all alert types
    if (stepId === 'step-2') {
        const protocolConfig = ProtocolFactory.getProtocolConfig(currentAlert.id);
        const stepConfig = protocolConfig.steps.find(step => step.id === stepId);
        
        if (stepConfig && stepConfig.action === 'Send Message') {
            // Log the outgoing message
            // addLogEntry('📤 Sent "Do you need help?" to device', 'step');
            
            // Start global timer if specified
// DEBUG: Check timer values
console.log('stepConfig:', stepConfig);
console.log('stepConfig.timer:', stepConfig.timer);
console.log('getStepTimer result:', getStepTimer('step-2'));
console.log('currentAlert:', currentAlert);

const timerDuration = getStepTimer('step-2');
console.log('timerDuration:', timerDuration);

if (timerDuration) {
    console.log('About to call startGlobalTimer with:', 'step-2', 'Waiting for device reply', '', timerDuration);
    startGlobalTimer('step-2', 'Waiting for device reply', '', timerDuration);
}
            
// Simulate device response after 30-60 seconds
setTimeout(() => {
    const responses = ["No", "Yes", "Send help", "False alarm", "I'm OK", "Understood"];
    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
    
    // This is a RESPONSE to our question, not spontaneous
    simulateDeviceResponse(randomResponse, true); // true = isResponse flag
}, Math.random() * 30000 + 30000); // 30-60 seconds delay
        }
    }
    
    // Handle other step-specific logic if needed
    if (stepId === 'step-1' && !isMessagingStep(stepId)) {
        // addLogEntry(`Step 1: Called G7c device to validate need for assistance`, 'step');
    }
}

    // 🔹 Validates if Post Note button should be enabled
    function validatePostButton(stepId) {
        const note = document.getElementById(stepId + "-note");
        const button = document.getElementById(stepId + "-post-btn");
    
        if (!note || !button) return;
    
        const hasText = note.value.trim().length > 0;
    
        if (hasText) {
            button.disabled = false;
            button.classList.remove("btn-secondary");
            button.classList.add("btn-success");
        } else {
            button.disabled = true;
            button.classList.remove("btn-success");
            button.classList.add("btn-secondary");
        }
    }
    
    // 🔹 Auto-populates note text based on dropdown selection
function autoPopulateFromDropdown(stepId) {
    const select = document.getElementById(stepId + "-select");
    const note = document.getElementById(stepId + "-note");

    if (!select || !note || !currentUser) return;

    const selectedValue = select.value;
    if (!selectedValue) return;

    let noteText = "";

    if (stepId === "step-1") {
        if (selectedValue === "no-answer") {
            noteText = "Step 1: Called device. No answer";
        } else if (selectedValue === "unable-to-call") {
            noteText = "Step 1: Unable to call, device offline";
        } else if (selectedValue === "confirmed-ok") {
            noteText = "Step 1: Spoke with " + currentUser.name + ". Confirmed they are OK. Resolving alert";
        }
    } else if (stepId === "step-2") {
        if (selectedValue === "unable-to-send") {
            noteText = "Step 2: Unable to send text message, device offline";
        } else if (selectedValue === "ec-callback-30min") {
            noteText = 'Step 2: Emergency contact called SOC and was provided alert details. Emergency contact will reach out to user and call back within 30 minutes.';
        } else if (selectedValue === "no-response") {
            // Special handling for timer expiry - auto-complete the step
            noteText = 'Step 2: Sent message "Do you need help?" to device. No response received';
            
            // Auto-complete this step immediately (no Post Note needed)
            setTimeout(() => {
                note.value = noteText;
                addLogEntry(noteText, 'step');
                markStepComplete(stepId);
                enableNextStep(stepId);
            }, 100);
            return; // Exit early - no need for manual Post Note
            
        } else if (selectedValue === "send-help") {
            noteText = 'Step 2: Received message "Send help" from device. Immediate assistance requested';
        } else if (selectedValue === "device-no") {
            noteText = 'Step 2: Received message "No" from device. User confirmed okay';
        } else if (selectedValue === "device-yes") {
            noteText = 'Step 2: Received message "Yes" from device. User confirmed okay';
        } else if (selectedValue === "understood") {
            noteText = 'Step 2: Received message "Understood" from device. User confirmed okay';
        } else if (selectedValue === "not-understood") {
            noteText = 'Step 2: Received message "Not understood" from device. Continue protocol';
        } else if (selectedValue === "hazard-in-area") {
            noteText = 'Step 2: Received message "Hazard in area" from device. Continue protocol';
        } else if (selectedValue === "i-dont-know") {
            noteText = 'Step 2: Received message "I don\'t know" from device. Continue protocol';
        } else if (selectedValue === "i-am-stranded") {
            noteText = 'Step 2: Received message "I am stranded" from device. Immediate assistance requested';
        } else if (selectedValue === "issue-resolved") {
            noteText = 'Step 2: Received message "Issue resolved" from device. User confirmed okay';
        } else if (selectedValue === "false-alarm") {
            noteText = 'Step 2: Received message "False alarm" from device. User confirmed okay';
        }
    } else if (stepId === "step-3") {
    if (selectedValue === "no-answer-voicemail") {
        noteText = `Step 3: Called ${currentUser.name} at ${currentUser.mobile}, no answer. Left voicemail. OP 417.`;
    } else if (selectedValue === "no-answer-already-left") {
        noteText = `Step 3: Called ${currentUser.name} at ${currentUser.mobile}, no answer. Voicemail had already been left. OP 417.`;
    } else if (selectedValue === "no-answer-mailbox-full") {
        noteText = `Step 3: Called ${currentUser.name} at ${currentUser.mobile}, no answer. Unable to leave voicemail, mailbox full. OP 417.`;
    } else if (selectedValue === "no-answer-unable-voicemail") {
        noteText = `Step 3: Called ${currentUser.name} at ${currentUser.mobile}, no answer. Unable to leave voicemail. OP 417.`;
    } else if (selectedValue === "unable-to-connect") {
        noteText = `Step 3: Called ${currentUser.name} at ${currentUser.mobile}, unable to connect. OP 417.`;
    } else if (selectedValue === "no-answer-not-setup") {
        noteText = `Step 3: Called ${currentUser.name} at ${currentUser.mobile}, no answer. Unable to leave voicemail, mailbox not set up yet. OP 417.`;
    } else if (selectedValue === "no-phone-assigned") {
        noteText = `Step 3: Unable to call, user has no phone number assigned. OP 417.`;
    } else if (selectedValue === "confirmed-ok") {
        noteText = `Step 3: Spoke with ${currentUser.name} at ${currentUser.mobile}. Confirmed they are OK`;
    }
    else if (selectedValue === "ec-confirmed-ok") {
    noteText = `Step 3: Emergency contact called in and confirmed ${currentUser.name} is OK`;
}
}
    if (stepId === 'step-2' && selectedValue && selectedValue !== 'unable-to-send' && selectedValue !== 'no-response') {
    let deviceMessage = '';
    
    if (selectedValue.includes('false-alarm')) deviceMessage = 'False alarm';
    else if (selectedValue.includes('issue-resolved')) deviceMessage = 'Issue resolved';
    else if (selectedValue.includes('no')) deviceMessage = 'No';
    else if (selectedValue.includes('yes')) deviceMessage = 'Yes';
    else if (selectedValue.includes('im-okay')) deviceMessage = 'I\'m Okay';
    else if (selectedValue === 'send-help') deviceMessage = 'Send help';
    else if (selectedValue === 'understood') deviceMessage = 'Understood';
    else if (selectedValue === 'not-understood') deviceMessage = 'Not understood';
    else if (selectedValue === 'hazard-in-area') deviceMessage = 'Hazard in area';
    else if (selectedValue === 'i-dont-know') deviceMessage = 'I don\'t know';
    else if (selectedValue === 'i-am-stranded') deviceMessage = 'I am stranded';
    
    if (deviceMessage) {
        receiveMessageFromDevice(deviceMessage);
    }
}
    if (noteText) {
        note.value = noteText;
        validatePostButton(stepId); // This enables Post Note button for manual responses
    }
}
    
// ✅ Helper function for callback detection
function isWaitingCallbackNote(text) {
    const callbackPhrases = [
        "call back within 30 minutes",
        "Waiting 30 minutes",
        "will call back in 30 minutes",  // Future-proofing
        "30-minute callback"             // Alternative phrasing
    ];
    
    return callbackPhrases.some(phrase => text.includes(phrase));
}

// ✅ Helper function for timer label
function getCallbackTimerLabel(stepId) {
    return stepId === "step-2" ? 
        "Call back Emergency contact for an update" : 
        "Follow-up with Emergency Contact";
}

function postNote(stepId) {
            const note = document.getElementById(stepId + '-note');
            const select = document.getElementById(stepId + '-select');
            
            if (!note || !note.value.trim()) {
                alert('Please enter text before posting note');
                return;
            }
            
            const selectedOutcome = select ? select.value : "";
            const logMessage = note.value.trim();

            console.log('DEBUG: logMessage =', logMessage);
            console.log('DEBUG: isWaitingCallbackNote result =', isWaitingCallbackNote(logMessage));
            
            // Always log with gas reading info for gas alerts
            if (currentAlert && currentAlert.id === "gas-high-threshold") {
                try {
                    const gasReading = getCurrentGasReading();
                    const enhancedMessage = logMessage + '. Gas level: ' + gasReading.status + ' – Gas Reading: ' + gasReading.type + ': ' + gasReading.value + gasReading.unit;
                    addLogEntry(enhancedMessage, 'step');
                } catch (e) {
                    console.warn('Could not get gas reading:', e);
                    addLogEntry(logMessage, 'step');
                }
            } else {
                addLogEntry(logMessage, 'step');
            }
            
            markStepComplete(stepId);
            
            // DRY: Unified 30-minute timer trigger
            if (isWaitingCallbackNote(logMessage)) {
                startGlobalTimer(stepId, getCallbackTimerLabel(stepId), "Emergency Contact", 1800);
                ensureDispatchAvailable();
            }
            
            // Reset input
            note.value = "";
            if (select) select.value = "";
            validatePostButton(stepId);
            
            // Enhanced "Confirmed OK" detection
            const isConfirmedOK = selectedOutcome === "confirmed-ok" ||
                                 selectedOutcome === "ec-confirmed-ok" ||
                                 logMessage.toLowerCase().includes("confirmed they are ok") ||
                                 logMessage.toLowerCase().includes("confirmed ok");
            
            if (isConfirmedOK) {
                lockRemainingSteps(stepId);
                handleConfirmedOK(stepId);
                
                setTimeout(() => {
                    const resolutionSection = document.querySelector('.resolution-section');
                    if (resolutionSection) {
                        resolutionSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 500);
                return;
            }
            
            // Legacy phrasing compatibility
            if (logMessage.includes("Resolving alert.")) {
                resolveAlert();
                return;
            }
            
            // Handle EC step progression
            if (typeof stepId === 'string' && stepId.startsWith('step-4-')) {
                handleECStepCompletion(stepId);
            } else if (!isWaitingCallbackNote(logMessage)) {
                // Normal flow - enable next step (only if not waiting for callback)
                enableNextStep(stepId);
            }
        }

        // ✅ Dedicated EC handler for clean progression logic
        function handleECStepCompletion(stepId) {
            // Extract EC index (step-4-1 -> 1, step-4-2 -> 2)
            const ecIndex = parseInt(stepId.split('-')[2]);
            const nextECIndex = ecIndex + 1;
            const nextECStepId = 'step-4-' + nextECIndex;
            
            // Enable next EC step
            const nextECStep = document.getElementById(nextECStepId);
            if (nextECStep) {
                const nextButton = nextECStep.querySelector('button:not([onclick*="postNote"])');
                if (nextButton) {
                    nextButton.disabled = false;
                    nextButton.classList.remove('btn-secondary');
                    nextButton.classList.add('btn-primary');
                }
                console.log('🔄 Enabled next EC step:', nextECStepId);
            } else {
                // No more ECs - enable Step 5
                const step5 = document.getElementById('step-5');
                if (step5) {
                    const step5Button = step5.querySelector('button:not([onclick*="postNote"])');
                    if (step5Button) {
                        step5Button.disabled = false;
                        step5Button.classList.remove('btn-secondary');
                        step5Button.classList.add('btn-primary');
                    }
                    console.log('🔄 All ECs completed - enabled Step 5');
                }
            }
        }

        // Helper functions for DRY code
        function isWaitingCallbackNote(logMessage) {
        const lowerMessage = logMessage.toLowerCase();
            return lowerMessage.includes("waiting") && 
           (lowerMessage.includes("callback") || lowerMessage.includes("call back"));
}

        function getCallbackTimerLabel(stepId) {
            return stepId.startsWith('step-4-') ? 'EC Callback' : 'Callback Timer';
        }

        function lockRemainingSteps(fromStepId) {
            blockRemainingSteps(fromStepId, 'Waiting for callback');
        }

        function markStepComplete(stepId) {
            const step = document.getElementById(stepId);
            const statusBadge = document.getElementById(stepId + '-status');
            
            if (step) {
                step.classList.remove('active');
                step.classList.add('completed');
            }
            
            if (statusBadge) {
                statusBadge.textContent = 'Completed';
                statusBadge.classList.add('completed');
            }
        }
    
// 🔹 Locks remaining steps when waiting for EC callback
function lockRemainingSteps(currentStepId) {
    const stepOrder = ['step-1', 'step-2', 'step-3', 'step-4', 'step-5'];
    const currentIndex = stepOrder.indexOf(currentStepId);

    if (currentIndex === -1) {
        console.warn(`Unknown stepId: ${currentStepId}`);
        return;
    }

    // Lock all steps after current one
    for (let i = currentIndex + 1; i < stepOrder.length; i++) {
        const nextStepId = stepOrder[i];
        const nextStep = document.getElementById(nextStepId);
        const nextButton = nextStep ? nextStep.querySelector('button:not([onclick*="postNote"])') : null;
        const nextStatus = document.getElementById(nextStepId + '-status');

        if (nextStep) {
    nextStep.classList.add('skipped');  // Use CSS class instead of inline styles
    
    nextStep.querySelectorAll('textarea, select, button').forEach(el => {
        el.disabled = true;
    });
}

if (nextButton && !nextButton.onclick.toString().includes('callDispatch')) {
    nextButton.disabled = true;
    nextButton.classList.remove('btn-primary');
    nextButton.classList.add('btn-secondary');
    nextButton.innerHTML = '⏳ Skipped - User confirmed OK';  // Better text
}

if (nextStatus) {
    nextStatus.textContent = 'Skipped';
}
    }

    const lockedSteps = stepOrder.slice(currentIndex + 1);
    const rangeText = lockedSteps.length === 1 
        ? `Step ${currentIndex + 2}` 
        : `Steps ${currentIndex + 2}-${stepOrder.length}`;
    
}
    
    // 🔹 Marks a step as completed
function markStepComplete(stepId) {
    const step = document.getElementById(stepId);
    const statusBadge = document.getElementById(stepId + "-status");

    if (step) {
        step.classList.add("completed");
        step.classList.remove("active");
        
        // ✅ Disable the step action button when completed
        const actionButton = step.querySelector('button:not([onclick*="postNote"])');
        if (actionButton) {
            actionButton.disabled = true;
            actionButton.classList.remove('btn-primary');
            actionButton.classList.add('btn-secondary');
        }
    }

    if (statusBadge) {
        statusBadge.textContent = "Completed";
        statusBadge.classList.add("completed");
    }

    // Stop tab flashing when any step is completed
    stopTabFlashing();

    protocolState.completedSteps.push(stepId);
}

// 🔹 Handles confirmed OK outcomes
function handleConfirmedOK(stepId) {
    console.log('handleConfirmedOK called with stepId:', stepId);
    // Lock remaining steps
    lockRemainingSteps(stepId);
    
    // Auto-select resolution reason     
const resolutionSelect = document.getElementById("resolution-reason");     
if (resolutionSelect && !resolutionSelect.value) {         
    if (dispatchMade) {             
        resolutionSelect.value = currentAlert && (currentAlert.id === "gas-high-threshold" || currentAlert.gasType) ? "incident-with-dispatch" : "false-alert-with-dispatch";         
    } else {             
        resolutionSelect.value = currentAlert && (currentAlert.id === "gas-high-threshold" || currentAlert.gasType) ? "incident-without-dispatch" : "false-alert-without-dispatch";         
    }     
}
    
    // Scroll to resolution section
    setTimeout(() => {
        const resolutionSection = document.querySelector('.resolution-section');
        if (resolutionSection) {
            resolutionSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 500);
}

// 🔹 Enables the next step in protocol
function enableNextStep(stepId) {
    console.log('enableNextStep called with:', stepId);
    
    const stepNumber = parseInt(stepId.replace("step-", ""));
    const nextStepId = "step-" + (stepNumber + 1);
    
    console.log('Looking for next step:', nextStepId);
    
    const nextStep = document.getElementById(nextStepId);
    console.log('Found nextStep element:', nextStep);

    if (nextStep) {
        nextStep.classList.add("active");
        console.log('Added active class to:', nextStepId);
        
        const nextButton = nextStep.querySelector('button:not([onclick*="postNote"])');
        console.log('Found nextButton:', nextButton);
        
        if (nextButton) {
            nextButton.disabled = false;
            nextButton.classList.remove("btn-secondary");
            nextButton.classList.add("btn-primary");
            console.log('Enabled button for:', nextStepId);
        } else {
            console.warn('No button found in step:', nextStepId);
        }
    } else {
        console.error('Step element not found:', nextStepId);
    }
}

// 🔹 Calls dispatch services
function callDispatch() {
dispatchMade = true;
document.getElementById("dispatch-status").style.display = "inline";
addLogEntry("🚑 Called dispatch - Emergency services notified", "step");

const resolutionSelect = document.getElementById("resolution-reason");
if (resolutionSelect && !resolutionSelect.value) {
    if (currentAlert && currentAlert.id === "gas-high-threshold") {
        resolutionSelect.value = "incident-with-dispatch";
    } else {
        resolutionSelect.value = "false-alert-with-dispatch";
    }
}
}

// 🔹 Checks if gas levels are high
function isGasLevelHigh() {
const h2sStatus = document.getElementById("h2s-status");
return h2sStatus && h2sStatus.textContent === "HIGH";
}

function getAllGasReadingsWithFlags() {
  const thresholds = {
    h2s: { high: 10.0 },
    lel: { high: 20.0 },
    co: { high: 200.0 },
    o2: { low: 18.0, high: 25.0 },
  };

  const parse = (selector) => {
    const element = document.querySelector(selector);
    if (!element) return 0;
    const text = element.textContent || "0";
    const match = text.match(/[\d.]+/);
    return match ? parseFloat(match[0]) : 0;
  };

  const readings = {
    h2s: parse("#h2s-reading .gas-value"),
    lel: parse("#lel-reading .gas-value"),
    co: parse("#co-reading .gas-value"),
    o2: parse("#o2-reading .gas-value"),
  };

  const exceeded = [];
  const formattedWithHighlight = {};

  // Check H₂S
  if (readings.h2s >= thresholds.h2s.high) {
    exceeded.push("H₂S");
    formattedWithHighlight.h2s = `🔴 H₂S: ${readings.h2s.toFixed(2)} ppm (HIGH)`;
  } else {
    formattedWithHighlight.h2s = `H₂S: ${readings.h2s.toFixed(2)} ppm`;
  }

  // Check LEL
  if (readings.lel >= thresholds.lel.high) {
    exceeded.push("LEL");
    formattedWithHighlight.lel = `🔴 LEL: ${readings.lel.toFixed(2)} %LEL (HIGH)`;
  } else {
    formattedWithHighlight.lel = `LEL: ${readings.lel.toFixed(2)} %LEL`;
  }

  // Check CO
  if (readings.co >= thresholds.co.high) {
    exceeded.push("CO");
    formattedWithHighlight.co = `🔴 CO: ${readings.co.toFixed(2)} ppm (HIGH)`;
  } else {
    formattedWithHighlight.co = `CO: ${readings.co.toFixed(2)} ppm`;
  }

  // ✅ Enhanced O₂ handling - distinguishes depletion vs enrichment
  if (readings.o2 <= thresholds.o2.low) {
    exceeded.push("O₂");
    formattedWithHighlight.o2 = `🔴 O₂: ${readings.o2.toFixed(2)} %vol (LOW - Depletion)`;
  } else if (readings.o2 >= thresholds.o2.high) {
    exceeded.push("O₂");
    formattedWithHighlight.o2 = `🔴 O₂: ${readings.o2.toFixed(2)} %vol (HIGH - Enrichment)`;
  } else {
    formattedWithHighlight.o2 = `O₂: ${readings.o2.toFixed(2)} %vol`;
  }

  // ✅ Create exceeded text with proper grammar
  let exceededText = "";
  if (exceeded.length === 1) {
    exceededText = `${exceeded[0]} exceeds safe limits!`;
  } else if (exceeded.length > 1) {
    const lastGas = exceeded.pop();
    exceededText = `${exceeded.join(", ")} and ${lastGas} exceed safe limits!`;
  }

  return { 
    formatted: formattedWithHighlight, 
    exceeded, 
    exceededText 
  };
}

// 🔹 Resolves alert with validation
function resolveAlert() {
    const reasonSelect = document.querySelector(".resolution-section select");
    let reason = reasonSelect ? reasonSelect.value : "";
    
    // Auto-prefill if needed
    if (!reason && currentAlert) {
        const isGasHigh = currentAlert.id === "gas-high-threshold" && isGasLevelHigh();
        reason = isGasHigh
            ? dispatchMade ? "incident-with-dispatch" : "incident-without-dispatch"
            : dispatchMade ? "false-alert-with-dispatch" : "false-alert-without-dispatch";
        if (reasonSelect) reasonSelect.value = reason;
    }
    
    if (!reason) {
        alert("Please select a resolution reason first");
        return;
    }
    
    // High gas level confirmation with enhanced details
    if (currentAlert && currentAlert.id === "gas-high-threshold" && isGasLevelHigh()) {
        const { formatted, exceeded, exceededText } = getAllGasReadingsWithFlags();
        const summary = `${formatted.h2s} | ${formatted.lel} | ${formatted.co} | ${formatted.o2}`;

        const confirmOverride = confirm(
            `⚠️ Gas level is HIGH.\n\nCurrent readings:\n${summary}\n\n🚨 ${exceededText}\n\nAre you sure you want to resolve the alert anyway?`
        );

        if (!confirmOverride) {
            addLogEntry("⚠️ Resolution cancelled due to high gas level.", "system");
            return;
        }

        // ✅ Gas alert resolution with gas readings
        const gasReading = getCurrentGasReading();
        addLogEntry(`✅ Specialist confirmed device user is OK. Alert resolved. Gas level: ${gasReading.status} – Gas Reading: ${gasReading.type}: ${gasReading.value}${gasReading.unit}`, "system");
    } else {
        // ✅ Non-gas alert resolution
        addLogEntry("✅ Specialist confirmed device user is OK. Alert resolved.", "system");
    }
    
    completeResolution(reason);
}

// 🔹 Completes alert resolution
function completeResolution(reason) {
const reasonSelect = document.querySelector(".resolution-section select");
const reasonText = reasonSelect
    ? reasonSelect.options[reasonSelect.selectedIndex].text
    : "Alert resolved";

// Update resolution badge and button
const resolutionBadge = document.querySelector(".resolution-section .status-badge");
if (resolutionBadge) {
    resolutionBadge.textContent = "Completed";
    resolutionBadge.classList.add("completed");
}

const resolveButton = document.querySelector(".resolution-section .btn-danger");
if (resolveButton) {
    resolveButton.disabled = true;
    resolveButton.classList.remove("btn-danger");
    resolveButton.classList.add("btn-secondary");
    resolveButton.textContent = "✅ Alert Resolved";
}

// Disable all protocol steps
document.querySelectorAll(".step").forEach(step => {
    step.classList.add("disabled");
    const inputs = step.querySelectorAll("button, textarea, select");
    inputs.forEach(el => el.disabled = true);
});

// Keep certain sections active (if elements exist)
const addNoteInput = document.getElementById("addNoteInput");
const addNoteBtn = document.getElementById("addNoteBtn");
const messageInput = document.getElementById("manual-message-input");
const sendMessageBtn = document.getElementById("sendMessageBtn");
const cancelBtn = document.getElementById("cancelResolutionBtn");

if (addNoteInput) addNoteInput.disabled = false;
if (addNoteBtn) addNoteBtn.disabled = false;
if (messageInput) messageInput.disabled = false;
if (sendMessageBtn) sendMessageBtn.disabled = false;
if (cancelBtn) cancelBtn.disabled = false;
}

// 🔹 Cancels alert resolution
function cancelResolution() {
    addLogEntry("❌ Resolution cancelled", "general");

    const resolutionSelect = document.getElementById("resolution-reason");
    if (resolutionSelect) resolutionSelect.value = "";

    const badge = document.querySelector(".resolution-section .status-badge");
    if (badge) {
        badge.textContent = "Pending";
        badge.classList.remove("completed");
        // ✅ Restore yellow badge styling
        badge.style.backgroundColor = '#ffc107';
        badge.style.color = '#000';
    }

    const resolveButton = document.querySelector(".resolution-section .btn-secondary");
    if (resolveButton) {
        resolveButton.disabled = false;
        resolveButton.classList.add("btn-danger");
        resolveButton.classList.remove("btn-secondary");
        resolveButton.textContent = "Resolve Alert";
    }

    // Properly unlock all locked steps
    const stepOrder = ['step-1', 'step-2', 'step-3', 'step-4', 'step-5'];
    stepOrder.forEach(stepId => {
        const step = document.getElementById(stepId);
        const status = document.getElementById(stepId + '-status');
        const button = step ? step.querySelector('.btn-primary') : null; // ✅ Improved selector
        
        if (step) {
            step.style.opacity = '1';
            step.style.pointerEvents = 'auto';
            step.classList.remove('locked', 'disabled-step');
            
            step.querySelectorAll('textarea, select, button').forEach(el => {
                el.disabled = false;
            });
        }
        
        if (status && status.textContent === 'Skipped') {
            status.textContent = 'Pending';
            status.style.background = '';
            status.style.color = '';
            status.classList.remove('completed');
        }
        
        if (button && !step.classList.contains('completed')) {
            button.disabled = false;
            button.classList.remove('btn-secondary');
            button.classList.add('btn-primary');
        }
    });
    
    // ✅ Clear any highlight classes from UI reset
    document.querySelectorAll(".step.highlight").forEach(step => step.classList.remove("highlight"));
    
    enableNextLogicalStep();
}

// Enhanced helper function
function enableNextLogicalStep() {
    const stepOrder = ['step-1', 'step-2', 'step-3', 'step-4', 'step-5'];
    let lastCompletedIndex = -1;
    
    stepOrder.forEach((stepId, index) => {
        const step = document.getElementById(stepId);
        if (step && step.classList.contains('completed')) {
            lastCompletedIndex = index;
        }
    });
    
    // ✅ Handle case where no steps are completed
    if (lastCompletedIndex === -1) {
        const firstStep = document.getElementById(stepOrder[0]);
        const firstBtn = firstStep ? firstStep.querySelector('.btn-primary') : null;
        if (firstStep) firstStep.classList.add("active");
        if (firstBtn) {
            firstBtn.disabled = false;
            firstBtn.classList.add("btn-primary");
            firstBtn.classList.remove("btn-secondary");
        }
        return;
    }
    
    const nextStepIndex = lastCompletedIndex + 1;
    if (nextStepIndex < stepOrder.length) {
        const nextStepId = stepOrder[nextStepIndex];
        const nextStep = document.getElementById(nextStepId);
        const nextButton = nextStep ? nextStep.querySelector('.btn-primary') : null;
        
        if (nextStep) {
            nextStep.classList.add('active');
        }
        
        if (nextButton) {
            nextButton.disabled = false;
            nextButton.classList.remove('btn-secondary');
            nextButton.classList.add('btn-primary');
        }
    }
}

// ✅ Helper function to enable the correct next step
function enableNextLogicalStep() {
    const stepOrder = ['step-1', 'step-2', 'step-3', 'step-4', 'step-5'];
    let lastCompletedIndex = -1;
    
    // Find the last completed step
    stepOrder.forEach((stepId, index) => {
        const step = document.getElementById(stepId);
        if (step && step.classList.contains('completed')) {
            lastCompletedIndex = index;
        }
    });
    
    // Enable the next step after the last completed one
    const nextStepIndex = lastCompletedIndex + 1;
    if (nextStepIndex < stepOrder.length) {
        const nextStepId = stepOrder[nextStepIndex];
        const nextStep = document.getElementById(nextStepId);
        const nextButton = nextStep ? nextStep.querySelector('button:not([onclick*="postNote"])') : null;
        
        if (nextStep) {
            nextStep.classList.add('active');
        }
        
        if (nextButton) {
            nextButton.disabled = false;
            nextButton.classList.remove('btn-secondary');
            nextButton.classList.add('btn-primary');
        }
    }
}


// ═══════════════════════════════════════════════════════════════
// 🎨 5. UI RENDERING & UPDATE FUNCTIONS
// ═══════════════════════════════════════════════════════════════

// 🔹 Updates alert header information
function updateAlertHeader(alertConfig, userConfig) {
const alertId = Math.floor(Math.random() * 9000000) + 1000000;
const alertTime = formatAlertTime(new Date());

document.getElementById("alert-title").textContent =
    "🚨 Alert Management - " + userConfig.name + " (" + alertConfig.displayName + ")";
document.getElementById("alert-id").textContent = alertId;
document.getElementById("employee-details").textContent =
    userConfig.name + " (ID: " + userConfig.id + ")";
document.getElementById("device-details").textContent = userConfig.device;
document.getElementById("mobile-number").textContent = userConfig.mobile;
document.getElementById("alert-time").textContent = alertTime;
document.getElementById("alert-trigger").textContent = alertConfig.displayName;
}

// 🔹 Adds initial alert sequence logs
function addAlertSequenceLogs(userConfig) {
const now = new Date();
const ackTime = new Date(now.getTime() - 9000);
const serverTime = new Date(now.getTime() - 18000);
const deviceTime = new Date(now.getTime() - 18000);

const formatEDT = function (date) {
    return (
        date.toLocaleTimeString("en-US", {
            hour12: false,
            timeZone: "America/New_York",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
        }) + " EDT"
    );
};

addLogEntry("Alert triggered by device.", "system", "*" + userConfig.company + "*", formatEDT(deviceTime));
addLogEntry("Alert received by server.", "system", "*" + userConfig.company + "*", formatEDT(serverTime));
addLogEntry("Alert acknowledged.", "system", "*Blackline Safety Operations Centre*", formatEDT(ackTime));
}

// 🔹 Loads and renders protocol steps HTML
function loadProtocolSteps(protocolConfig, userConfig) {
    console.log('🚀 loadProtocolSteps CALLED!', protocolConfig);
    console.log('DEBUG: loadProtocolSteps called');
    console.log('protocolConfig:', protocolConfig);
    console.log('userConfig:', userConfig);
    
    let protocolHTML =
        '<div style="margin-bottom: 20px;"><h4 style="color: #1565c0; margin: 0 0 10px 0;">📋 ' +
        protocolConfig.name +
        '</h4><p style="color: #666; font-size: 0.9em; margin: 0;">Showing only relevant steps for this alert type</p></div>';

    protocolConfig.steps.forEach(function (step, index) {
        console.log('🔍 Processing step:', step.id, step);
        const isFirst = index === 0;

        protocolHTML +=
            '<div class="step ' + (isFirst ? "active" : "") + '" id="' + step.id + '">' +
            '<div class="step-header">' +
            '<h4 class="step-title">✅ ' + step.title + "</h4>" +
            '<span class="status-badge" id="' + step.id + '-status">Pending</span>' +
            "</div>";

        // Add contact info for relevant steps
        if (step.id === "step-3" || step.id === "step-2") {
            protocolHTML +=
                '<div class="contact-info">' +
                "<strong>👤 " + userConfig.name + "</strong> 📞 " + userConfig.mobile +
                "</div>";
        }

        // STEP 4 COMPLETE OVERRIDE - Handle first to prevent conflicts
        if (step.id === 'step-4') {
            console.log('🔥 STEP 4 OVERRIDE EXECUTING!');
            
            const userKey = currentAlert.user;
            const emergencyContacts = AlertDataManager.usersData[userKey] ? AlertDataManager.usersData[userKey].emergencyContacts : [];
            
            console.log('🔥 Emergency Contacts from fixture:', emergencyContacts);
            console.log('🔥 Contact count:', emergencyContacts.length);

            protocolHTML += '<div class="step-content" style="margin: 15px 0;">' +
                'If there is no answer, but dispatch conditions are met, proceed to STEP 5.<br>' +
                'If dispatch conditions are not met, repeat STEPS 1, 2, 3 & 4 until someone is reached.' +
                '</div>';
            
            protocolHTML += '</div>'; // Close the main step-4 div
            
            // Add individual EC sections
            emergencyContacts.forEach(function(contact, index) {
                const contactStepId = 'step-4-' + (index + 1);
                const isFirstEC = index === 0;
                
                protocolHTML += 
                    '<div class="step" id="' + contactStepId + '" style="margin: 10px 0;">' +
                    '<div class="step-header">' +
                    '<h5 class="step-title">📞 Call ' + contact.name + ' at ' + contact.phone + '</h5>' +
                    '<span class="status-badge" id="' + contactStepId + '-status">Pending</span>' +
                    '</div>' +
                    '<div class="contact-info">' +
                    '<strong>👤 ' + contact.name + '</strong> 📞 ' + contact.phone + ' 🏷️ ' + contact.role +
                    '</div>' +
                    '<button class="btn btn-primary" onclick="startStep(\'' + contactStepId + '\')" ' + (!isFirstEC ? 'disabled' : '') + '>' +
                    '📞 Call Emergency Contact' +
                    '</button>' +
                    '<div class="step-outcome" id="' + contactStepId + '-outcome" style="display: none; margin-top: 15px;">' +
                    '<select id="' + contactStepId + '-select" onchange="autoPopulateNote(\'' + contactStepId + '\')" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">' +
                    '<option value="">Select outcome</option>' +
                    '<option value="waiting-30-minutes">Spoke with EC, who will check on user and call back. Waiting 30 minutes</option>' +
                    '<option value="confirmed-ok">Confirmed user is okay and advised to resolve alert</option>' +
                    '<option value="no-answer-voicemail">No answer, left voicemail</option>' +
                    '<option value="no-answer-already-left">No answer, voicemail already left</option>' +
                    '<option value="no-answer-unable">No answer, unable to leave voicemail</option>' +
                    '<option value="no-answer-box-full">No answer, voicemail box full</option>' +
                    '<option value="no-answer-not-set">No answer, voicemail not set up</option>' +
                    '<option value="wrong-number">Wrong number</option>' +
                    '<option value="unable-to-connect">Unable to connect</option>' +
                    '<option value="number-invalid">Number invalid, changed, or out of service</option>' +
                    '</select>' +
                    '<textarea id="' + contactStepId + '-note" placeholder="Document the result..." style="width: 100%; height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-top: 8px; box-sizing: border-box;" oninput="validatePostButton(\'' + contactStepId + '\')"></textarea>' +
                    '<button class="btn btn-secondary" onclick="postNote(\'' + contactStepId + '\')" style="margin-top: 8px;" disabled id="' + contactStepId + '-post-btn">✅ Post Note</button>' +
                    '</div>' +
                    '</div>';
            });

            return; // Skip all standard processing for Step 4
        }

        // Standard processing for all other steps (Steps 1, 2, 3, 5)
        if (step.id !== 'step-4') {
            // Step action button
            protocolHTML +=
                '<button class="btn btn-primary" onclick="startStep(\'' + step.id + '\')" ' +
                (!isFirst ? "disabled" : "") + ">" +
                getActionIcon(step.action) + " " + step.action + "</button>";

            // Step outcome section
            protocolHTML +=
                '<div class="step-outcome" id="' + step.id + '-outcome" style="display: none; margin-top: 15px;">';

            // Timer info
            if (step.timer) {
                protocolHTML +=
                    '<div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin: 10px 0; font-size: 0.85em;">' +
                    "⏱️ Timer: " + Math.floor(step.timer / 60) + " minutes" + "</div>";
            }

            // Outcome dropdown
            protocolHTML +=
                '<select id="' + step.id + '-select" onchange="autoPopulateFromDropdown(\'' + step.id +
                '\'); validatePostButton(\'' + step.id + '\')" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">' +
                '<option value="">Select outcome</option>';

            // Step-specific dropdown options
            if (step.id === "step-1") {
                protocolHTML +=
                    '<option value="no-answer">No answer.</option>' +
                    '<option value="unable-to-call">Unable to call, device offline.</option>' +
                    '<option value="confirmed-ok">Spoke with ' + userConfig.name + ". Confirmed they are OK. Resolving alert.</option>";
            } else if (step.id === "step-2") {
                protocolHTML +=
                    '<option value="no-response">No response</option>' +
                    '<option value="unable-to-send">Unable to send text message, device offline</option>' +
                    '<option value="ec-callback-30min">Emergency contact called in - Will contact user and call back (30 min timer)</option>' +
                    '<option value="device-no">Received "No" - User confirmed okay</option>' +
                    '<option value="issue-resolved">Received "Issue resolved" - User confirmed okay</option>' +
                    '<option value="false-alarm">Received "False alarm" - User confirmed okay</option>' +
                    '<option value="understood">Received "Understood" - User confirmed okay</option>' +
                    '<option value="device-yes">Received "Yes" - User confirmed okay</option>' +
                    '<option value="not-understood">Received "Not understood" - Continue protocol</option>' +
                    '<option value="hazard-in-area">Received "Hazard in area" - Continue protocol</option>' +
                    '<option value="i-dont-know">Received "I don\'t know" - Continue protocol</option>' +
                    '<option value="send-help">Received "Send help" - Immediate assistance requested</option>' +
                    '<option value="i-am-stranded">Received "I am stranded" - Immediate assistance requested</option>';
            } else if (step.id === "step-3") {
                protocolHTML +=
                    '<option value="no-answer-voicemail">No answer. Left voicemail</option>' +
                    '<option value="no-answer-already-left">No answer. Voicemail had already been left</option>' +
                    '<option value="no-answer-mailbox-full">No answer. Unable to leave voicemail, mailbox full</option>' +
                    '<option value="no-answer-unable-voicemail">No answer. Unable to leave voicemail</option>' +
                    '<option value="unable-to-connect">Unable to connect</option>' +
                    '<option value="no-answer-not-setup">No answer. Unable to leave voicemail, mailbox not set up yet</option>' +
                    '<option value="no-phone-assigned">Unable to call, user has no phone number assigned</option>' +
                    '<option value="confirmed-ok">Spoke with ' + userConfig.name + ', confirmed they are OK</option>' +
                    '<option value="ec-confirmed-ok">Emergency contact called in and confirmed user is OK</option>';
            } else {
                protocolHTML +=
                    '<option value="completed">Action completed</option>' +
                    '<option value="no-answer">No answer</option>';
            }

            protocolHTML += "</select>";

            // Note textarea
            protocolHTML +=
                '<textarea id="' + step.id + '-note" placeholder="Document the result..." ' +
                'style="width: 100%; height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-top: 8px; box-sizing: border-box;" ' +
                'oninput="validatePostButton(\'' + step.id + '\')"></textarea>';

            // Enhanced Step 5 with full dispatch decision logic
        if (step.id === "step-5" && step.action === "Dispatch Services") {
        protocolHTML += 
        // Entry Criteria Display
        '<div class="step-criteria" style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 0.85em;">' +
            '<strong>🔹 Entry Criteria Check:</strong><br>' +
            '<span id="criteria-age">🕓 Alert age: <span id="alert-age-status">--</span></span><br>' +
            '<span id="criteria-location">📍 GPS location: <span id="location-status">--</span></span><br>' +
            '<span id="criteria-movement">🚶 Device movement: <span id="movement-status">--</span></span>' +
        '</div>' +

        // Dispatch Decision Dropdown
        '<label for="dispatch-decision"><strong>Dispatch conditions met?</strong></label>' +
        '<select id="dispatch-decision" onchange="handleDispatchDecision()" data-cy="dispatch-decision" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">' +
            '<option value="">-- Select --</option>' +
            '<option value="yes">Yes</option>' +
            '<option value="no">No</option>' +
        '</select>' +

        // Dispatch Services Flow (shown when "Yes" selected)
        '<div id="dispatch-flow" style="display: none; margin-top: 10px;">' +
            '<label for="dispatch-type"><strong>Select dispatch service(s):</strong></label>' +
            '<select id="dispatch-type" onchange="generateDispatchNote()" data-cy="dispatch-type" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">' +
                '<option value="">-- Select dispatch type --</option>' +
                '<option value="EMS">EMS</option>' +
                '<option value="Police">Police</option>' +
                '<option value="Fire">Fire</option>' +
                '<option value="EMS and Police">EMS and Police</option>' +
                '<option value="EMS and Fire">EMS and Fire</option>' +
                '<option value="Police and Fire">Police and Fire</option>' +
                '<option value="EMS, Police, and Fire">EMS, Police, and Fire</option>' +
            '</select>' +
            // Note: The textarea is already added below in the standard flow
        '</div>' +

        // Skip Dispatch Flow (shown when "No" selected)
        '<div id="dispatch-skip" style="display: none; margin-top: 10px;">' +
            '<label for="dispatch-skip-reason"><strong>Why was dispatch skipped?</strong></label>' +
            '<select id="dispatch-skip-reason" onchange="handleDispatchSkipReason()" data-cy="dispatch-skip-reason" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">' +
                '<option value="">-- Select reason --</option>' +
                '<option value="no-location">Location unavailable or too old</option>' +
                '<option value="device-moving">Device moving too fast</option>' +
                '<option value="pre-alert">Alert is over 24 hours old</option>' +
                '<option value="device-offline">Device offline</option>' +
            '</select>' +
            '<button class="btn btn-secondary" onclick="logDispatchSkipped()" id="dispatch-skip-log-btn" disabled data-cy="dispatch-skip-log-btn" style="margin-top: 8px;">📄 Log Reason</button>' +
        '</div>' +

        // Manual Override Button (shown when conditions not met)
        '<div id="dispatch-override" style="display: none; margin-top: 15px;">' +
            '<button class="btn btn-danger" onclick="showDispatchOverride()" data-cy="dispatch-override-btn">⚠️ Manual Override - Force Dispatch</button>' +
        '</div>';
}

// Post Note button
protocolHTML +=
    '<button class="btn btn-secondary" onclick="postNote(\'' + step.id + '\')" style="margin-top: 8px;" disabled id="' +
    step.id + '-post-btn">✅ Post Note</button>' + "</div>" + "</div>";
        }
    });

    // Resolution Section
    protocolHTML +=
        '<div class="resolution-section">' +
        '<div class="step-header">' +
        "<h3>✅ RESOLUTION</h3>" +
        '<span class="status-badge" id="resolution-status">Pending</span>' +
        "</div>" +
        '<select id="resolution-reason" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">' +
        '<option value="">-- Select reason --</option>' +
        '<option value="false-alert-without-dispatch">False alert without dispatch</option>' +
        '<option value="false-alert-with-dispatch">False alert with dispatch</option>' +
        '<option value="incident-without-dispatch">Incident without dispatch</option>' +
        '<option value="incident-with-dispatch">Incident with dispatch</option>' +
        "</select>" +
        '<div class="resolution-buttons">' +
        '<button class="btn btn-danger" onclick="resolveAlert()">✅ Resolve Alert</button>' +
        '<button class="btn btn-secondary" onclick="cancelResolution()">❌ Cancel Resolution</button>' +
        "</div>" + "</div>";

    document.getElementById("protocol-content").innerHTML = protocolHTML;
    
    // Always enable Step 5 (Dispatch) - emergency dispatch should always be available
    setTimeout(() => {
        const step5 = document.getElementById('step-5');
        const step5Button = step5 ? step5.querySelector('button:not([onclick*="postNote"])') : null;
        
        if (step5Button) {
            step5Button.disabled = false;
            step5Button.classList.remove('btn-secondary');
            step5Button.classList.add('btn-primary');
            console.log('✅ Step 5 (Dispatch) enabled - always available for emergencies');
        }
    }, 100);
    }

// 🔹 Updates gas monitoring display
function updateGasDisplay() {
const timestamp = new Date().toLocaleTimeString("en-US", {
    hour12: false,
    timeZone: "America/Denver",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
});

const timestampElement = document.getElementById("gas-timestamp");
if (timestampElement) {
    timestampElement.textContent = timestamp + " MDT";
}
}

// 🔹 Updates gas status based on thresholds
function updateGasStatus() {
const gasThresholds = {
    h2s: { lowThreshold: 5.0, highThreshold: 10.0 },
    co: { lowThreshold: 100.0, highThreshold: 200.0 },
    o2: { enrichmentHigh: 25.0, depletionHigh: 18.0 },
    lel: { lowThreshold: 10.0, highThreshold: 20.0 },
};

const h2sElement = document.getElementById("h2s-value");
const h2sStatus = document.getElementById("h2s-status");
if (h2sElement && h2sStatus) {
    const h2sValue = parseFloat(h2sElement.textContent);
    const status = h2sValue >= gasThresholds.h2s.highThreshold ? "HIGH" : "NORMAL";
    h2sStatus.textContent = status;
    h2sStatus.className = "gas-status " + status.toLowerCase();
}
}

// ═══════════════════════════════════════════════════════════════
// 🔄 6. EVENT HANDLERS & DEMO FUNCTIONS
// ═══════════════════════════════════════════════════════════════

// 🔹 Demo panel toggle
function toggleDemoPanel() {
document.getElementById("demo-panel").classList.toggle("show");
}

// 🔹 Production view toggle
function toggleProductionView() {
const body = document.body;
const toggle = document.getElementById("production-toggle");

if (body.classList.contains("production-mode")) {
    body.classList.remove("production-mode");
    toggle.textContent = "👁️ Production View";
} else {
    body.classList.add("production-mode");
    toggle.textContent = "🔧 Demo View";
    document.getElementById("demo-panel").classList.remove("show");
}
}

// 🔹 Loads alert and initializes protocol
function loadAlert(alertType) {
    
    const alertConfig = AlertDataManager.alertTypesData[alertType];
    if (!alertConfig) {
        console.error(`Alert type ${alertType} not found`);
        return;
    }
    
    const userConfig = AlertDataManager.usersData[alertConfig.user];
    const protocolConfig = ProtocolFactory.getProtocolConfig(alertType);

    currentAlert = alertConfig;
    currentUser = userConfig;

    // Clear existing logs
    const logContainer = document.getElementById("protocolLog");
    logContainer.innerHTML = "";

    // Initialize UI
    addAlertSequenceLogs(userConfig);
    updateAlertHeader(alertConfig, userConfig);
    updateGasReadings(alertConfig.gasType || alertType);
    loadProtocolSteps(protocolConfig, userConfig);
    initializeAlert(alertConfig, userConfig);

    document.getElementById("alert-header").classList.add("active");
    document.getElementById("demo-panel").classList.remove("show");
    
    // Handle different test scenarios
    handleTestScenario(alertConfig);

    // Load JSON alert data and check dispatch conditions
    setTimeout(() => {
        getAlertData(alertType).then(jsonAlert => {
            if (jsonAlert) {
                console.log('📄 Loaded JSON alert data:', jsonAlert);
                const processedAlert = processAlertTimestamps(jsonAlert);
                console.log('🔄 Processed timestamps:', processedAlert);
                autoCheckDispatchConditions(processedAlert);
            } else {
                console.warn('⚠️ Failed to load JSON alert data for:', alertType);
            }
        }).catch(error => {
            console.error('❌ Error loading alert data:', error);
        });
    }, 500); // Small delay to ensure Step 5 UI is loaded
}

// Function to handle test scenarios
function handleTestScenario(alertConfig) {
    // Complete message pools including ambiguous messages
    const gasMessages = ["False alarm", "Issue resolved", "I'm OK", "No", "Yes", "Understood"];
    const nonGasMessages = ["Issue resolved", "False alarm", "I'm OK", "No", "Yes", "Send help"];
    const helpMessages = ["Send help", "I am stranded", "Hazard in area"];
    
    if (alertConfig.testType === 'spontaneous') {
        // Flow 1: Spontaneous message after 3 seconds
        setTimeout(() => {
            let messagePool = alertConfig.protocolFile === 'gas-emergency-protocol' ? gasMessages : nonGasMessages;
            const randomMessage = messagePool[Math.floor(Math.random() * messagePool.length)];
            simulateDeviceResponse(randomMessage, false); // false = spontaneous
        }, 3000);
        
    } else if (alertConfig.testType === 'immediate-help') {
        // SOS scenarios - immediate help needed
        setTimeout(() => {
            const helpMessage = helpMessages[Math.floor(Math.random() * helpMessages.length)];
            simulateDeviceResponse(helpMessage, false);
        }, 2000);
        
    } else if (alertConfig.testType === 'response') {
        // Flow 2: Wait for specialist to send message (handled in startStep)
        console.log('Response test - waiting for specialist to send message');
        
    } else if (alertConfig.testType === 'no-response') {
        // Flow 3: No device response ever (test full protocol)
        console.log('No response test - device will not respond');
        
    } else if (alertConfig.testType === 'legacy') {
        // Keep old behavior for backward compatibility
        if (alertConfig.id === 'gas-high-threshold') {
            setTimeout(() => {
                const randomMessage = gasMessages[Math.floor(Math.random() * gasMessages.length)];
                simulateDeviceResponse(randomMessage, false);
            }, 3000);
        } else if (alertConfig.id === 'fall-detection') {
            setTimeout(() => {
                const randomMessage = nonGasMessages[Math.floor(Math.random() * nonGasMessages.length)];
                simulateDeviceResponse(randomMessage, false);
            }, 3000);
        }
    }
    
    // Handle special gas level behaviors
    if (alertConfig.gasType === 'h2s-normalizes') {
        // Gas normalizes after 8 seconds
        setTimeout(() => {
            setGasLevel('h2s', 1.20);
            addLogEntry('📊 Gas levels have normalized', 'gas');
        }, 8000);
    }
    // 'h2s-stays-high' keeps gas HIGH throughout (no action needed)
}

// 🔹 Clears current alert
function clearAlert() {
currentAlert = null;
currentUser = null;
dispatchMade = false;

document.getElementById("alert-header").classList.remove("active");
updateGasReadings("default");
document.getElementById("triggeredBy").style.display = "none";
document.getElementById("lastUpdated").style.display = "none";
document.getElementById("protocolLog").innerHTML =
    '<div class="log-placeholder">No alert loaded. Use demo controls to load an alert type and begin protocol.</div>';
document.getElementById("protocol-content").innerHTML =
    '<div class="protocol-placeholder"><div class="protocol-frame"><div class="placeholder-text">No protocol loaded</div><div class="placeholder-subtitle">Alert type will load the relevant emergency response protocol</div></div></div>';
document.getElementById("demo-panel").classList.remove("show");
}

// 🔹 Adds manual note
function addManualNote() {
const noteText = document.getElementById("manual-notes").value.trim();
if (!noteText) {
    alert("Please enter a note first");
    return;
}

if (currentAlert && currentAlert.id === "gas-high-threshold") {
    EnhancedLogger.addGasLogEntry(noteText);
} else {
    addLogEntry(noteText, "general");
}

document.getElementById("manual-notes").value = "";
}

// 🔹 Starts gas monitoring
function startGasMonitoring() {
updateGasDisplay();
gasUpdateInterval = setInterval(() => {
    simulateGasFluctuations();
    updateGasDisplay();
}, 5000);
}

// 🔹 Simulates gas fluctuations
function simulateGasFluctuations() {
updateGasStatus();
}

// 🔹 Messaging functions
function sendManualMessage() {
const messageInput = document.getElementById("manual-message-input");
const charCounter = document.getElementById("charCounter");
const sendBtn = document.getElementById("sendMessageBtn");

const msg = messageInput.value.trim();
if (msg.length === 0 || msg.length > 32) return;

console.log("Manual message sent:", msg);

messageInput.value = "";
charCounter.textContent = "32 characters remaining";
sendBtn.disabled = true;
}

function receiveMessageFromDevice(text) {
const messageList = document.getElementById("receivedMessages");
if (!messageList) return;

const li = document.createElement("li");
li.classList.add("unread");
li.textContent = splitIntoTwoLines(text);
messageList.prepend(li);

// Mark as read after 5 seconds
setTimeout(() => li.classList.remove("unread"), 5000);
}

// 🔹 Enhanced device connectivity check with 30-minute window
function isDeviceOnline(deviceId) {
    const connectivity = DeviceConnectivity.currentStatus;
    if (!connectivity) return false;
    
    const checks = {
        lastComm: (Date.now() - new Date(connectivity.lastCommunication)) < 1800000, // 30 min
        battery: connectivity.battery > 10, // Above 10%
        signal: connectivity.signal > 20, // Above 20%
        online: connectivity.online === true
    };
    
    const passedChecks = Object.values(checks).filter(Boolean).length;
    const isReliable = passedChecks >= 3; // At least 3 of 4 criteria
    
    console.log(`Device ${deviceId} connectivity:`, checks, `Reliable: ${isReliable}`);
    return isReliable;
}

// 🔹 Gets device status summary for specialist display  
function getDeviceStatusSummary() {
    const connectivity = DeviceConnectivity.currentStatus;
    if (!connectivity) return "Status unknown";
    
    const lastContact = new Date(connectivity.lastCommunication);
    const minutesAgo = Math.floor((Date.now() - lastContact) / 60000);
    
    const signalDisplay = connectivity.signal !== null && connectivity.signal !== undefined 
        ? `${connectivity.signal}%` 
        : "Unknown";
    
    return `Last contact: ${minutesAgo} minutes ago\nBattery: ${connectivity.battery}%\nSignal: ${signalDisplay}`;
}

// ═══════════════════════════════════════════════════════════════
// 🧪 7. DEMO & DEBUG FUNCTIONS
// ═══════════════════════════════════════════════════════════════

// 🔹 Demo functions for testing
window.simulateDeviceResponse = function(responseText, isResponse = false) {
    // ADD DEBUG LINES AT THE TOP
    console.log('simulateDeviceResponse called with:', responseText, isResponse);
    console.log('currentAlert:', currentAlert);
    console.log('currentAlert.gasType:', currentAlert?.gasType);
    console.log('Gas alert detected:', currentAlert && (currentAlert.id === 'gas-high-threshold' || currentAlert.gasType));
    
    if (protocolState.deviceMessageReceived) return; // Only one message per demo
    
    protocolState.deviceMessageReceived = true;
    
    // Show message in messaging UI
    receiveMessageFromDevice(responseText);
    
    // Define clear resolution messages vs ambiguous messages
    const clearResolutionMessages = ['Issue resolved', 'False alarm', 'I\'m OK'];
    const ambiguousMessages = ['No', 'Yes', 'Understood'];
    
    // Log with proper format for gas alerts - FIXED: Check gasType too
    if (currentAlert && (currentAlert.id === 'gas-high-threshold' || currentAlert.gasType)) {
        const gasReading = getCurrentGasReading();
        console.log('gasReading:', gasReading);
        console.log('isAmbiguous will be:', ambiguousMessages.includes(responseText));
        
        let messageType = isResponse ? "reply message" : "message";
        
        // Check if this should resolve (clear message + gas normal)
        let shouldResolve = !isGasLevelHigh() && clearResolutionMessages.includes(responseText);
        let isAmbiguous = ambiguousMessages.includes(responseText);
        
        if (shouldResolve) {
            // Clear resolution message + gas normal
            addLogEntry(`📱 Received ${messageType} '${responseText}', confirming the user is okay. Gas readings back to normal levels. Resolving alert.`, 'step');
            addLogEntry(`📤 Sent "Noted. Resolving alert." to device`, 'step');
            
            // Gas details as plain text (no timestamps) - added AFTER the log entries
            const logContainer = document.getElementById('protocolLog');
            const gasDetails = document.createElement('div');
            gasDetails.innerHTML = `
                <div style="margin-left: 20px; color: #333; font-size: 0.9em; line-height: 1.4;">
                    Gas Type: ${gasReading.type}<br>
                    Gas Level: ${gasReading.status}<br>
                    Gas Reading: ${gasReading.value}${gasReading.unit}
                </div>
            `;
            // Insert after the latest log entry (second position)
            const logEntries = logContainer.querySelectorAll('.log-entry');
            if (logEntries.length >= 2) {
                logContainer.insertBefore(gasDetails, logEntries[1]);
            } else {
                logContainer.insertBefore(gasDetails, logContainer.firstChild);
            }
            
        } else if (isAmbiguous) {
            // Ambiguous message - no auto-reply, continue protocol
            console.log('Processing ambiguous message - should log gas details');
            addLogEntry(`📱 Received ${messageType} '${responseText}'. Ambiguous response. Proceed with protocol escalation.`, 'step');
            
            // Gas details as plain text (no timestamps) - added AFTER the log entry
            const logContainer = document.getElementById('protocolLog');
            const gasDetails = document.createElement('div');
            gasDetails.innerHTML = `
                <div style="margin-left: 20px; color: #333; font-size: 0.9em; line-height: 1.4;">
                    Gas Type: ${gasReading.type}<br>
                    Gas Level: ${gasReading.status}<br>
                    Gas Reading: ${gasReading.value}${gasReading.unit}
                </div>
            `;
            // Insert after the latest log entry
            const logEntries = logContainer.querySelectorAll('.log-entry');
            if (logEntries.length >= 1) {
                logContainer.insertBefore(gasDetails, logEntries[0].nextSibling);
            } else {
                logContainer.appendChild(gasDetails);
            }
            
        } else {
            // Clear message but gas still high, or other message
            if (clearResolutionMessages.includes(responseText)) {
                addLogEntry(`📱 Received ${messageType} '${responseText}', confirming the user is okay. Gas levels remain elevated.`, 'step');
            } else {
                addLogEntry(`📱 Received ${messageType} '${responseText}'.`, 'step');
            }
            
            // Gas details as plain text (no timestamps) - added AFTER the log entry
            const logContainer = document.getElementById('protocolLog');
            const gasDetails = document.createElement('div');
            gasDetails.innerHTML = `
                <div style="margin-left: 20px; color: #333; font-size: 0.9em; line-height: 1.4;">
                    Gas Type: ${gasReading.type}<br>
                    Gas Level: ${gasReading.status}<br>
                    Gas Reading: ${gasReading.value}${gasReading.unit}
                </div>
            `;
            // Insert after the latest log entry
            const logEntries = logContainer.querySelectorAll('.log-entry');
            if (logEntries.length >= 1) {
                logContainer.insertBefore(gasDetails, logEntries[0].nextSibling);
            } else {
                logContainer.appendChild(gasDetails);
            }
        }
    } else {
        console.log('Not a gas alert - processing as non-gas');
        // Non-gas alerts
        let messageType = isResponse ? "reply message" : "message";
        let shouldResolve = clearResolutionMessages.includes(responseText);
        let isAmbiguous = ambiguousMessages.includes(responseText);
        
        if (shouldResolve) {
            addLogEntry(`📱 Received ${messageType} '${responseText}', confirming the user is okay. Resolving alert.`, 'step');
            addLogEntry(`📤 Sent "Noted. Resolving alert." to device`, 'step');
        } else if (isAmbiguous) {
            addLogEntry(`📱 Received ${messageType} '${responseText}'. Ambiguous response. Proceed with protocol escalation.`, 'step');
        } else {
            addLogEntry(`📱 Received ${messageType} '${responseText}'.`, 'step');
        }
    }
    
    // Determine action based on response and gas level - FIXED: Check gasType too
    if (clearResolutionMessages.includes(responseText)) {
        if (currentAlert && (currentAlert.id === 'gas-high-threshold' || currentAlert.gasType)) {
            if (!isGasLevelHigh()) {
                // Gas levels normal - can resolve
                const resolutionSelect = document.getElementById('resolution-reason');
                if (resolutionSelect && !resolutionSelect.value) {
                    resolutionSelect.value = dispatchMade ? 'incident-with-dispatch' : 'incident-without-dispatch';
                }
                
                // Skip remaining steps
                blockRemainingSteps('step-2', 'User confirmed OK, gas levels normal');
                
            } else {
                // Gas levels still high - continue protocol (no action)
            }
        } else {
            // Non-gas alert - can resolve normally
            const resolutionSelect = document.getElementById('resolution-reason');
            if (resolutionSelect && !resolutionSelect.value) {
                resolutionSelect.value = dispatchMade ? 'false-alert-with-dispatch' : 'false-alert-without-dispatch';
            }
            blockRemainingSteps('step-2', 'User confirmed OK');
        }
    } else if (ambiguousMessages.includes(responseText)) {
        // Ambiguous messages - no action, continue protocol
        
    } else if (responseText === 'Send help') {
        addLogEntry(`📱 Device user requests immediate assistance. Escalating to dispatch.`, 'general');
        triggerImmediateDispatch();
    }
};

window.setGasLevel = function (gas, value) {
    const gasData = gasReadingsData[currentAlert ? (currentAlert.gasType || currentAlert.id) : "default"] || gasReadingsData.default;
    if (gasData[gas]) {
        gasData[gas].value = value;
        gasData[gas].status = determineGasStatus(gas, value);
        updateGasStatus();
        updateGasReadings(currentAlert ? (currentAlert.gasType || currentAlert.id) : "default");
        console.log("Set " + gas.toUpperCase() + " to " + value);
    }
};

// Add this new function for proper gas status determination
function determineGasStatus(gas, value) {
    const thresholds = {
        h2s: { high: 10.00 },
        co: { high: 200.00 },
        o2: { low: 19.00, high: 23.00 },
        lel: { high: 10.00 }
    };
    
    if (gas === 'h2s' || gas === 'co' || gas === 'lel') {
        return value >= thresholds[gas].high ? "HIGH" : "NORMAL";
    } else if (gas === 'o2') {
        return (value < thresholds.o2.low || value > thresholds.o2.high) ? "HIGH" : "NORMAL";
    }
    return "NORMAL";
}

// 🔹 Device connectivity demo controls
window.setDeviceOffline = function (reason = "battery") {
DeviceConnectivity.setDeviceOfflineScenario(reason);
console.log(`Device set to OFFLINE (reason: ${reason})`);
console.log("Current status:", DeviceConnectivity.currentStatus);
};

window.setDeviceOnline = function () {
DeviceConnectivity.setDeviceOnlineScenario();
console.log("Device set to ONLINE");
console.log("Current status:", DeviceConnectivity.currentStatus);
};

// 🔹 Test specific offline scenarios
window.testBatteryDead = function () { setDeviceOffline("battery"); };
window.testSignalLost = function () { setDeviceOffline("signal"); };
window.testCommunicationTimeout = function () { setDeviceOffline("communication"); };

// 🔹 Check connectivity status
window.checkDeviceStatus = function () {
const status = DeviceConnectivity.currentStatus;
const isOnline = DeviceConnectivity.isDeviceOnline();
console.log("=== DEVICE STATUS CHECK ===");
console.log("Last Communication:", status.lastCommunication);
console.log("Battery:", status.battery + "%");
console.log("Signal:", status.signal + "%");
console.log("BlackLine Online Status:", isOnline ? "🟢 ONLINE" : "🔴 OFFLINE");
return isOnline;
};

// ═══════════════════════════════════════════════════════════════
// 🚀 8. INITIALIZATION & STARTUP
// ═══════════════════════════════════════════════════════════════

// 🔹 Initialize the system when DOM is ready
document.addEventListener("DOMContentLoaded", function () {
// Initialize gas readings
updateGasReadings("default");
startGasMonitoring();

// Initialize device connectivity
DeviceConnectivity.updateConnectivityDisplay();

// Update connectivity every 30 seconds
setInterval(() => {
    DeviceConnectivity.updateConnectivityDisplay();
}, 30000);

// Initialize messaging if elements exist
const messageInput = document.getElementById("manual-message-input");
const charCounter = document.getElementById("charCounter");
const sendBtn = document.getElementById("sendMessageBtn");

if (messageInput && charCounter && sendBtn) {
    messageInput.addEventListener("input", () => {
        const remaining = 32 - messageInput.value.length;
        charCounter.textContent = `${remaining} characters remaining`;
        sendBtn.disabled = remaining < 0 || messageInput.value.trim() === "";
    });

    // Demo messages (can be removed in production)
    // setTimeout(() => receiveMessageFromDevice("Issue resolved"), 3000);
    // setTimeout(() => receiveMessageFromDevice("False alarm"), 7000);
}
});

// 🔹 Close demo panel when clicking outside
document.addEventListener("click", function (event) {
const demoPanel = document.getElementById("demo-panel");
const demoGear = document.getElementById("demo-gear");

if (demoPanel && demoGear && !demoPanel.contains(event.target) && !demoGear.contains(event.target)) {
    demoPanel.classList.remove("show");
}
});

// 🔹 Debug helper function (remove in production)
window.testPostButton = function(stepId) {
validatePostButton(stepId);
console.log(`Step ${stepId} button state:`, 
    document.getElementById(stepId + '-post-btn')?.disabled);
};

function blockRemainingSteps(currentStepId, reason) {
    console.log('blockRemainingSteps called with:', currentStepId, reason);
    // Get all steps after current one, including EC sub-steps
    const allSteps = ['step-1', 'step-2', 'step-3', 'step-4-1', 'step-4-2', 'step-5'];
    const currentIndex = allSteps.indexOf(currentStepId);

    console.log('Current index found:', currentIndex);
    console.log('Will skip steps:', allSteps.slice(currentIndex + 1));
    
    // Determine skip message based on reason
    const skipMessage = reason === 'User confirmed OK' ? 'Skipped - User confirmed OK' : 'Skipped - ' + reason;
    
    for (let i = currentIndex + 1; i < allSteps.length; i++) {
        const nextStepId = allSteps[i];
        
        // Skip Step 5 from being blocked - dispatch should always be available
        if (nextStepId === 'step-5') continue;
        
        const nextStep = document.getElementById(nextStepId);
        const nextButton = nextStep ? nextStep.querySelector('button:not([onclick*="postNote"])') : null;
        const nextStatus = document.getElementById(nextStepId + '-status');
        
        if (nextStep) {
            nextStep.style.opacity = '0.5';
            nextStep.style.pointerEvents = 'none';
        }
        if (nextButton && !nextButton.onclick.toString().includes('callDispatch')) {
            nextButton.disabled = true;
            nextButton.classList.remove('btn-primary');
            nextButton.classList.add('btn-secondary');
        }
        if (nextStatus) {
            nextStatus.textContent = skipMessage;
            nextStatus.style.background = '#6c757d';
            nextStatus.style.color = 'white';
        }
    }
    
    // Log the reason for skipping
    addLogEntry(`Remaining steps skipped: ${reason}`, 'general');
}

function determineGasStatus(gas, value) {
    const thresholds = {
        h2s: { high: 10.00 },
        co: { high: 200.00 },
        o2: { low: 19.00, high: 23.00 },
        lel: { high: 10.00 }
    };
    
    if (gas === 'h2s' || gas === 'co' || gas === 'lel') {
        return value >= thresholds[gas].high ? "HIGH" : "NORMAL";
    } else if (gas === 'o2') {
        return (value < thresholds.o2.low || value > thresholds.o2.high) ? "HIGH" : "NORMAL";
    }
    return "NORMAL";
}

function toggleDemoSection(sectionId) {
    const section = document.getElementById(sectionId);
    section.classList.toggle('collapsed');
}

document.addEventListener('DOMContentLoaded', function() {
    // Sections start expanded - no action needed
});

// 🔹 Updates gas readings display
function updateGasReadings(alertType) {
    const gasData = gasReadingsData[alertType] || gasReadingsData.default;

    Object.keys(gasData).forEach(function (gas) {
        const reading = gasData[gas];
        const valueElement = document.getElementById(gas + "-value");
        const statusElement = document.getElementById(gas + "-status");
        const readingElement = document.getElementById(gas + "-reading");

        const unit = gas === "o2" ? " %vol" : gas === "lel" ? " %LEL" : " ppm";

        if (valueElement) {
            valueElement.textContent = reading.value.toFixed(2) + unit;
        }

        if (statusElement) {
            statusElement.textContent = reading.status;
            statusElement.className = "gas-status " + reading.status.toLowerCase();
        }

        if (readingElement) {
            const icon = reading.status === "HIGH" ? "🔴" : "🟢";
            const gasLabel = gas === "h2s" ? "H₂S" : gas === "o2" ? "O₂" : gas.toUpperCase();
            readingElement.querySelector("span").innerHTML =
                icon + " " + gasLabel + ': <span class="gas-value">' + reading.value.toFixed(2) + unit + "</span>";
        }
    });

    if (alertType !== "default") {
        document.getElementById("triggeredBy").style.display = "block";
        document.getElementById("lastUpdated").style.display = "block";
        document.getElementById("gas-timestamp").textContent = new Date().toLocaleTimeString() + " MDT";
    }
}

function autoPopulateNote(contactStepId) {
    const select = document.getElementById(contactStepId + '-select');
    const note = document.getElementById(contactStepId + '-note');
    
    if (!select || !note) return;
    
    const selectedValue = select.value;
    if (!selectedValue) return;
    
    // Extract EC index from contactStepId (step-4-1 -> 1, step-4-2 -> 2)
    const ecIndex = parseInt(contactStepId.split('-')[2]) - 1;
    const userKey = currentAlert.user;
    const contact = AlertDataManager.usersData[userKey].emergencyContacts[ecIndex];
    
    let noteText = '';
    if (selectedValue === 'waiting-30-minutes') {
        noteText = 'Step 4.' + (ecIndex + 1) + ': Spoke with ' + contact.name + ', who will check on user and call back. Waiting 30 minutes';
    } else if (selectedValue === 'confirmed-ok') {
        noteText = 'Step 4.' + (ecIndex + 1) + ': Confirmed user is okay and advised to resolve alert';
    } else if (selectedValue === 'no-answer-voicemail') {
        noteText = 'Step 4.' + (ecIndex + 1) + ': Called ' + contact.name + ' at ' + contact.phone + '. No answer, left voicemail';
    } else if (selectedValue === 'no-answer-already-left') {
        noteText = 'Step 4.' + (ecIndex + 1) + ': Called ' + contact.name + ' at ' + contact.phone + '. No answer, voicemail already left';
    } else if (selectedValue === 'no-answer-unable') {
        noteText = 'Step 4.' + (ecIndex + 1) + ': Called ' + contact.name + ' at ' + contact.phone + '. No answer, unable to leave voicemail';
    } else if (selectedValue === 'no-answer-box-full') {
        noteText = 'Step 4.' + (ecIndex + 1) + ': Called ' + contact.name + ' at ' + contact.phone + '. No answer, voicemail box full';
    } else if (selectedValue === 'no-answer-not-set') {
        noteText = 'Step 4.' + (ecIndex + 1) + ': Called ' + contact.name + ' at ' + contact.phone + '. No answer, voicemail not set up';
    } else if (selectedValue === 'wrong-number') {
        noteText = 'Step 4.' + (ecIndex + 1) + ': Called ' + contact.name + ' at ' + contact.phone + '. Wrong number';
    } else if (selectedValue === 'unable-to-connect') {
        noteText = 'Step 4.' + (ecIndex + 1) + ': Called ' + contact.name + ' at ' + contact.phone + '. Unable to connect';
    } else if (selectedValue === 'number-invalid') {
        noteText = 'Step 4.' + (ecIndex + 1) + ': Called ' + contact.name + ' at ' + contact.phone + '. Number invalid, changed, or out of service';
    }
    
    if (noteText) {
        note.value = noteText;
        validatePostButton(contactStepId);
    }
}

function handleECStepCompletion(stepId) {
    // Extract EC index (step-4-1 -> 1, step-4-2 -> 2)
    const ecIndex = parseInt(stepId.split('-')[2]);
    const nextECIndex = ecIndex + 1;
    const nextECStepId = 'step-4-' + nextECIndex;
    
    // Enable next EC step
    const nextECStep = document.getElementById(nextECStepId);
    if (nextECStep) {
        const nextButton = nextECStep.querySelector('button:not([onclick*="postNote"])');
        if (nextButton) {
            nextButton.disabled = false;
            nextButton.classList.remove('btn-secondary');  
            nextButton.classList.add('btn-primary');
        }
        console.log('🔄 Enabled next EC step:', nextECStepId);
    } else {
        // No more ECs - enable Step 5
        const step5 = document.getElementById('step-5');
        if (step5) {
            const step5Button = step5.querySelector('button:not([onclick*="postNote"])');
            if (step5Button) {
                step5Button.disabled = false;
                step5Button.classList.remove('btn-secondary');
                step5Button.classList.add('btn-primary');
            }
            console.log('🔄 All ECs completed - enabled Step 5');
        }
    }
}

function lockRemainingSteps(stepId) {
    blockRemainingSteps(stepId, 'User confirmed OK');
}

function ensureDispatchAvailable() {
    const step5 = document.getElementById('step-5');
    const step5Button = step5 ? step5.querySelector('button:not([onclick*="postNote"])') : null;
    const step5Status = document.getElementById('step-5-status');
    
    if (step5) {
        step5.style.opacity = '1';
        step5.style.pointerEvents = 'auto';
    }
    if (step5Button) {
        step5Button.disabled = false;
        step5Button.classList.remove('btn-secondary');
        step5Button.classList.add('btn-primary');
    }
    if (step5Status && step5Status.textContent.includes('Skipped')) {
        step5Status.textContent = 'Pending';
        step5Status.style.background = '#ffc107';
        step5Status.style.color = '#000';
    }
}

// Simple data to test the connectivity panel display
function updateConnectivityPanel() {
    // Update existing connectivity fields (clean data, no icons)
    document.getElementById('last-comm-time').textContent = "Aug 02, 2025 at 17:11 MDT";
    document.getElementById('battery-level').textContent = "40%";
    document.getElementById('signal-strength').textContent = "20%";
    
    // Update location fields  
    document.getElementById('device-location').textContent = "144252 434 Ave E, Aldersyde, AB T0L 0A0, Canada";
    document.getElementById('device-coordinates').textContent = "50.66004, -113.7685769";
    document.getElementById('device-speed').textContent = "2.3 km/h";
    document.getElementById('location-timestamp').textContent = "Aug 02, 2025 at 15:28 MDT";
}

// Call it when alert loads
updateConnectivityPanel();

// Generate dynamic timestamps for dispatch condition testing
function generateTimestamp(type) {
    const now = new Date();
    
    switch(type) {
        case 'DYNAMIC_RECENT':
            // Alert: 5 minutes to 23 hours ago (always under 24 hours)
            const alertMinutesAgo = Math.floor(Math.random() * (23 * 60 - 5)) + 5;
            return new Date(now.getTime() - (alertMinutesAgo * 60 * 1000)).toISOString();
            
        case 'DYNAMIC_LOCATION_FRESH':
            // Location: 30 seconds to 4 minutes ago (always under 5 minutes)
            const locationSecondsAgo = Math.floor(Math.random() * (4 * 60 - 30)) + 30;
            return new Date(now.getTime() - (locationSecondsAgo * 1000)).toISOString();
            
        case 'DYNAMIC_DEVICE_RECENT':
            // Device: 30 seconds to 10 minutes ago (good connectivity)
            const deviceSecondsAgo = Math.floor(Math.random() * (10 * 60 - 30)) + 30;
            return new Date(now.getTime() - (deviceSecondsAgo * 1000)).toISOString();
            
        case 'STATIC_OLD_45MIN':
            // 45 minutes ago (device offline - dispatch blocked)
            return new Date(now.getTime() - (45 * 60 * 1000)).toISOString();
            
        case 'STATIC_OLD_12MIN':
            // 12 minutes ago (location stale - dispatch blocked)
            return new Date(now.getTime() - (12 * 60 * 1000)).toISOString();
            
        default:
            return now.toISOString();
    }
}

// Process alert data and replace timestamp placeholders
function processAlertTimestamps(alertData) {
    const processed = {...alertData};
    
    // Replace timestamp placeholders with actual timestamps
    if (processed.alert_date && (processed.alert_date.startsWith('DYNAMIC_') || processed.alert_date.startsWith('STATIC_'))) {
        processed.alert_date = generateTimestamp(processed.alert_date);
    }
    
    if (processed.last_device_communication && (processed.last_device_communication.startsWith('DYNAMIC_') || processed.last_device_communication.startsWith('STATIC_'))) {
        processed.last_device_communication = generateTimestamp(processed.last_device_communication);
    }
    
    if (processed.location_last_updated && (processed.location_last_updated.startsWith('DYNAMIC_') || processed.location_last_updated.startsWith('STATIC_'))) {
        processed.location_last_updated = generateTimestamp(processed.location_last_updated);
    }
    
    return processed;
}

// Auto-check dispatch conditions when Step 5 loads
function autoCheckDispatchConditions(alertData) {
    const result = checkDispatchConditions(alertData);
    
    const decisionSelect = document.getElementById('dispatch-decision');
    const skipReasonSelect = document.getElementById('skip-reason');
    
    if (result.canDispatch) {
        // Pre-select "Yes"
        decisionSelect.value = 'yes';
        handleDispatchDecision(); // Trigger existing logic
    } else {
        // Pre-select "No" + first failed reason
        decisionSelect.value = 'no';
        handleDispatchDecision(); // Show skip reason container
        
        // Auto-select the first failed reason
        if (result.failedReasons.length > 0) {
            const reason = result.failedReasons[0];
            if (reason.includes("24 hours")) skipReasonSelect.value = 'alert-old';
            else if (reason.includes("offline")) skipReasonSelect.value = 'device-offline';
            else if (reason.includes("moving")) skipReasonSelect.value = 'device-moving';
            else if (reason.includes("location")) skipReasonSelect.value = 'location-invalid';
        }
    }
}

// Check all dispatch conditions for automatic Step 5 population
function checkDispatchConditions(alertData) {
    const now = new Date();
    const conditions = {
        alertAge: true,
        deviceOnline: true, 
        locationFresh: true,
        deviceStationary: true
    };
    const failedReasons = [];
    
    // Check alert age (< 24 hours)
    if (alertData.alert_date) {
        const alertTime = new Date(alertData.alert_date);
        const ageHours = (now - alertTime) / (1000 * 60 * 60);
        if (ageHours >= 24) {
            conditions.alertAge = false;
            failedReasons.push("Alert older than 24 hours");
        }
    }
    
    // Check device status
    if (alertData.device_status !== "Online") {
        conditions.deviceOnline = false;
        failedReasons.push("Device is offline");
    }
    
    // Check device speed (< 5 km/h)
    if (alertData.device_speed >= 5) {
        conditions.deviceStationary = false;
        failedReasons.push("Device is moving faster than 5 km/h");
    }
    
    // Check location freshness (< 5 minutes)
    if (alertData.location_last_updated) {
        const locationTime = new Date(alertData.location_last_updated);
        const ageMinutes = (now - locationTime) / (1000 * 60);
        if (ageMinutes >= 5) {
            conditions.locationFresh = false;
            failedReasons.push("Location invalid or outdated");
        }
    }
    
    const canDispatch = Object.values(conditions).every(condition => condition);
    
    return {
        canDispatch,
        failedReasons,
        conditions
    };
}

// Auto-populate Step 5 based on dispatch conditions
function autoCheckDispatchConditions(alertData) {
    const result = checkDispatchConditions(alertData);
    
    console.log('🔍 Dispatch condition check:', result);
    
    const decisionSelect = document.getElementById('dispatch-decision');
    const skipReasonSelect = document.getElementById('skip-reason');
    
    if (!decisionSelect) {
        console.warn('dispatch-decision element not found');
        return;
    }
    
    if (result.canDispatch) {
        // Pre-select "Yes" - all conditions met
        console.log('✅ All dispatch conditions met - pre-selecting YES');
        decisionSelect.value = 'yes';
        handleDispatchDecision(); // Trigger existing UI logic
    } else {
        // Pre-select "No" - conditions failed
        console.log('❌ Dispatch conditions failed:', result.failedReasons);
        decisionSelect.value = 'no';
        handleDispatchDecision(); // Show skip reason container
        
        // Auto-select the first failed reason
        if (skipReasonSelect && result.failedReasons.length > 0) {
            const reason = result.failedReasons[0];
            if (reason.includes("24 hours")) skipReasonSelect.value = 'alert-old';
            else if (reason.includes("offline")) skipReasonSelect.value = 'device-offline';
            else if (reason.includes("moving")) skipReasonSelect.value = 'device-moving';
            else if (reason.includes("location")) skipReasonSelect.value = 'location-invalid';
            
            console.log('🎯 Auto-selected skip reason:', skipReasonSelect.value);
        }
    }
}
function handleDispatchDecision() {
    const decision = document.getElementById('dispatch-decision').value;
    const serviceContainer = document.getElementById('dispatch-service-container');
    const reasonContainer = document.getElementById('skip-reason-container');
    const note = document.getElementById('step-5-note');
    const resolutionSelect = document.getElementById('resolution-reason');
    
    if (decision === 'yes') {
        if (serviceContainer) serviceContainer.style.display = 'block';
        if (reasonContainer) reasonContainer.style.display = 'none';
        if (note) note.value = '';
        
        if (resolutionSelect) {
            resolutionSelect.value = 'false-alert-with-dispatch';
        }
    } else if (decision === 'no') {
        if (serviceContainer) serviceContainer.style.display = 'none';
        if (reasonContainer) reasonContainer.style.display = 'block';
        if (note) note.value = '';
        
        if (resolutionSelect) {
            resolutionSelect.value = 'false-alert-without-dispatch';
        }
    } else {
        if (serviceContainer) serviceContainer.style.display = 'none';
        if (reasonContainer) reasonContainer.style.display = 'none';
        if (note) note.value = '';
        
        if (resolutionSelect) {
            resolutionSelect.value = '';
        }
    }
}

// Load alert data from existing JSON file
async function getAlertData(alertType) {
    try {
        const response = await fetch('./cypress/fixtures/gas_alerts.json');
        const jsonAlerts = await response.json();
        
        // Simple mapping - first alert = good dispatch, second = bad dispatch
        const alertDataMap = {
            'h2s-spontaneous': jsonAlerts[0], // 7174694 - Dispatch OK
            'gas-high-threshold': jsonAlerts[0], // Good conditions
            'gas-multiple-issues': jsonAlerts[1], // 7174695 - Multiple Issues
            'fall-detection': jsonAlerts[0], // Default to good conditions
            'sos': jsonAlerts[0],
            'no-motion': jsonAlerts[0],
            'missed-check-in': jsonAlerts[0]
        };
        
        return alertDataMap[alertType] || jsonAlerts[0];
    } catch (error) {
        console.error('Failed to load alert data:', error);
        return null;
    }
}
</script>
  </body>
</html>
