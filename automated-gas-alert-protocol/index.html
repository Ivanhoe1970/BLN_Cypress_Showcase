<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Response Protocol - Unified Alert Management</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #90caf9;
        }
        
        .alert-title {
            margin: 0;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .alert-details {
            background: white;
            border: 1px solid #90caf9;
            border-radius: 6px;
            padding: 15px;
            color: #333;
        }
        
        .alert-info {
            display: block;
            font-size: 0.9em;
        }
        
        .info-item {
            padding: 3px 0;
        }
        
        .info-item strong {
            color: #1565c0;
            font-weight: 600;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 200px 1fr 300px;
            gap: 15px;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .protocol-log {
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
        }
        
        .protocol-log h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.1em;
        }
        
        .log-container {
            height: calc(100vh - 350px);
            min-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        .log-entry {
            margin: 8px 0;
            padding: 8px 12px;
            background: white;
            border-left: 4px solid #28a745;
            border-radius: 4px;
            font-size: 0.9em;
            line-height: 1.3;
        }
        
        .log-entry.step {
            border-left-color: #007bff;
        }
        
        .log-entry.timer {
            border-left-color: #ffc107;
        }
        
        .log-entry.resolution {
            border-left-color: #dc3545;
        }
        
        .log-entry.gas {
            border-left-color: #fd7e14;
        }
        
        .log-placeholder {
            color: #6c757d;
            text-align: center;
            margin-top: 120px;
            font-style: normal;
            font-size: 0.9em;
            font-family: inherit;
        }
        
        .global-timer {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
            height: fit-content;
            font-size: 0.9em;
        }
        
        .timer-display {
            font-size: 1.8em;
            font-weight: bold;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
        }
        
        .timer-info {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            font-size: 0.8em;
            line-height: 1.3;
        }
        
        .timer-controls {
            margin-top: 12px;
        }
        
        .cancel-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8em;
            transition: background 0.2s;
        }
        
        .cancel-btn:hover:not(:disabled) {
            background: #c82333;
        }
        
        .cancel-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .steps-section {
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
        }
        
        .steps-section h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.1em;
        }
        
        .gas-readings-card {
            background: white;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        
        .gas-readings-card h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .gas-reading {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }
        
        .gas-reading:last-child {
            border-bottom: none;
        }
        
        .gas-value {
            font-weight: bold;
        }
        
        .gas-status {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .gas-status.high {
            background: #f8d7da;
            color: #721c24;
        }
        
        .gas-status.normal {
            background: #d4edda;
            color: #155724;
        }
        
        .triggered-by {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 15px;
            font-size: 0.85em;
            font-weight: bold;
            color: #856404;
        }
        
        .last-updated {
            font-size: 0.8em;
            color: #6c757d;
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }
        
        .step {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
        }
        
        .step.completed {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .step.active {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .step-title {
            font-weight: bold;
            color: #333;
            margin: 0;
            font-size: 0.95em;
        }
        
        .status-badge {
            background: #ffc107;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }
        
        .status-badge.completed {
            background: #28a745;
            color: white;
        }
        
        .step-content {
            color: #666;
            font-size: 0.9em;
            margin: 8px 0;
        }
        
        .contact-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            font-size: 0.85em;
        }
        
        .device-response-section {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
        }
        
        .response-header {
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 8px;
        }
        
        .received-message {
            background: white;
            border: 1px solid #007bff;
            border-radius: 4px;
            padding: 10px;
            margin: 8px 0;
        }
        
        .device-message-text {
            font-weight: bold;
            color: #0056b3;
        }
        
        .timestamp {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .soc-acknowledgment {
            margin-top: 10px;
        }
        
        .soc-acknowledgment button {
            margin-right: 10px;
            margin-bottom: 5px;
        }
        
        .btn {
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #1e7e34;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            cursor: not-allowed;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .timer-inactive {
            opacity: 0.6;
            background: linear-gradient(135deg, #6c757d, #495057);
        }
        
        .timer-active {
            animation: pulse 2s infinite;
        }
        
        .timer-alert {
            animation: flashRed 1s infinite;
            border: 3px solid #dc3545 !important;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        @keyframes flashRed {
            0%, 50% { background: linear-gradient(135deg, #dc3545, #c82333); }
            51%, 100% { background: linear-gradient(135deg, #007bff, #0056b3); }
        }
        
        .manual-notes {
            width: 100%;
            height: 100px;
            border-radius: 5px;
            border: 1px solid #ddd;
            padding: 10px;
            box-sizing: border-box;
            resize: vertical;
            font-family: inherit;
            font-size: 0.9em;
        }
        
        .timer-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #dc3545;
            color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            font-size: 1.2em;
            display: none;
        }
        
        .override-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #dc3545;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1001;
            max-width: 500px;
            display: none;
        }
        
        .override-modal h3 {
            color: #dc3545;
            margin-top: 0;
        }
        
        .override-modal .gas-reading-display {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 10px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
        }
        
        .override-modal select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .override-modal .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        
        .step-outcome {
            margin: 10px 0;
        }
        
        .step-outcome select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .step-outcome textarea {
            width: 100%;
            height: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            margin-top: 8px;
            box-sizing: border-box;
            resize: vertical;
        }
        
        .local-timer {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px;
            margin: 10px 0;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .resolution-section {
            background: #fff;
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .resolution-section h3 {
            margin-top: 0;
            color: #dc3545;
        }
        
        .resolution-section select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .resolution-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }
        
        .alert-resolved .step:not(.resolution-section) {
            pointer-events: none;
            background: #f8f9fa;
            opacity: 0.6;
        }
        
        .alert-resolved .step:not(.resolution-section) button {
            cursor: not-allowed;
        }
        
        .alert-resolved .protocol-log {
            pointer-events: auto;
            opacity: 1;
        }
        
        .alert-resolved .resolution-section {
            pointer-events: auto;
            opacity: 1;
        }
        
        .message-preview {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Alert Information Header -->
    <div class="header">
        <h1 class="alert-title">🚨 Alert Management - <span id="employee-name" data-cy="employee-name">Zach Sowell</span> (<span id="alert-type" data-cy="alert-type">High threshold detected (H₂S)</span>)</h1>
        
        <div class="alert-details">
            <div class="alert-info">
                <div class="info-item">
                    <strong>Alert ID:</strong> <span id="alert-id" data-cy="alert-id">7174694</span>
                </div>
                <div class="info-item">
                    <strong>Employee:</strong> <span id="employee-details" data-cy="employee-details">Zach Sowell (ID: 373595)</span>
                </div>
                <div class="info-item">
                    <strong>Device:</strong> <span id="device-details" data-cy="device-details">G7c-3571031421</span>
                </div>
                <div class="info-item">
                    <strong>Mobile:</strong> <span id="mobile-number" data-cy="mobile-number">+1 470-505-6195</span>
                </div>
                <div class="info-item">
                    <strong>Alert Time:</strong> <span id="alert-time">07/14/2025 08:46:00 CDT (-28 minutes ago)</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Protocol Log Section -->
        <div class="protocol-log">
            <h3>📋 Protocol Log</h3>
            <div class="log-container" id="protocolLog" data-cy="protocol-log">
                <div class="log-placeholder">
                    Ready to begin protocol. Actions will appear here as you progress through the steps.
                </div>
            </div>
            
            <h3>📝 Add Note</h3>
            <label for="manual-notes" style="position: absolute; left: -9999px;" data-cy="manual-notes-label">Add Note</label>
            <textarea id="manual-notes" class="manual-notes" placeholder="Add notes here..." data-cy="manual-notes"></textarea>
            <button class="btn btn-success" style="margin-top: 10px;" onclick="addManualNote()" data-cy="add-manual-note">
                Post Note
            </button>
        </div>

        <!-- Global Timer Section -->
        <div class="global-timer timer-inactive" id="globalTimer" data-cy="global-timer">
            <h3>⏰ Timer</h3>
            
            <div class="timer-display" id="timerDisplay" aria-live="polite" data-cy="timer-display">
                --:--
            </div>
            
            <div class="timer-info" id="timerInfo" data-cy="timer-info">
                <strong>No active timer</strong>
            </div>
            
            <div class="timer-controls">
                <button class="cancel-btn" id="cancelTimerBtn" disabled onclick="cancelGlobalTimer()" data-cy="cancel-global-timer">
                    🛑 Cancel Timer
                </button>
            </div>
            
            <div style="margin-top: 8px; font-size: 0.7em; opacity: 0.8; line-height: 1.2; display: flex; justify-content: space-between;" id="timerMeta">
                <span id="timerStart">--:--</span>
                <span id="timerEnd">--:--</span>
            </div>
        </div>

        <!-- Emergency Response Steps -->
        <div class="steps-section">
            <h3>🚨 Emergency Response Protocol</h3>
            
            <!-- Step 1: Call G7c Device -->
            <div class="step active" id="step-1" data-cy="step-1">
                <div class="step-header">
                    <h4 class="step-title">✅ STEP 1: Call the G7c device and validate the need for assistance.</h4>
                    <span class="status-badge" id="step-1-status" data-cy="step-1-status">Pending</span>
                </div>

                <button class="btn btn-primary" onclick="startStep(1)" data-cy="call-g7c-device">
                    📞 Call G7c Device
                </button>
                
                <div class="step-outcome" id="step-1-outcome" style="display: none;">
                    <select id="step-1-select" data-cy="step-1-outcome" onchange="autoPopulateNote(1)">
                        <option value="">Select outcome</option>
                        <option value="no-answer">No answer.</option>
                        <option value="unable-to-call">Unable to call, device offline.</option>
                        <option value="confirmed-ok">Spoke with Zach Sowell. Confirmed they are OK. Resolving alert.</option>
                    </select>
                    <textarea id="step-1-note" placeholder="Document the result..." data-cy="step-1-note" oninput="validatePostButton(1)"></textarea>
                    <button class="btn btn-secondary" onclick="postNote(1)" data-cy="step-1-post" style="margin-top: 8px;" disabled>
                        ✅ Post Note
                    </button>
                </div>
            </div>

            <!-- Step 2: Send Message -->
            <div class="step" id="step-2" data-cy="step-2">
                <div class="step-header">
                    <h4 class="step-title">✅ STEP 2: Send text 'Do you need help?' to device and wait 2 minutes</h4>
                    <span class="status-badge" id="step-2-status" data-cy="step-2-status">Pending</span>
                </div>

                <button class="btn btn-primary" onclick="startStep(2)" data-cy="send-message" disabled>
                    📤 Send Message
                </button>
                
                <div class="step-outcome" id="step-2-outcome" style="display: none;">
                    <div class="local-timer" id="step-2-timer" style="display: none;" data-cy="step-2-timer">
                        <span>⏱️ Message timer: <span id="step-2-countdown" data-cy="step-2-countdown">02:00</span></span>
                        <button class="btn btn-secondary" onclick="cancelLocalTimer(2)">Cancel Timer</button>
                    </div>
                    
                    <!-- Device Response Area -->
                    <div class="device-response-section" id="device-response-2" style="display: none;" data-cy="device-response-2">
                        <div class="response-header">📩 Device response.</div>
                        <div class="received-message" id="received-message" style="display: none;">
                            <div class="device-message-text" id="device-message-text" data-cy="device-message-text"></div>
                            <div class="timestamp" id="device-timestamp"></div>
                            
                            <div class="soc-acknowledgment" id="soc-acknowledgment" style="display: none;" data-cy="soc-acknowledgment">
                                <button class="btn btn-success btn-sm" onclick="sendAcknowledgment('Noted. Resolving alert.')">
                                    Send: "Noted. Resolving alert."
                                </button>
                                <button class="btn btn-success btn-sm" onclick="sendAcknowledgment('Understood. Resolving alert.')">
                                    Send: "Understood. Resolving alert."
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <textarea id="step-2-note" placeholder="Document the result..." data-cy="step-2-note" oninput="validatePostButton(2)">Sent message "Do you need help?" to device. Waiting 2 minutes for device user reply.</textarea>
                    <button class="btn btn-secondary" onclick="postNote(2)" data-cy="step-2-post" style="margin-top: 8px;" disabled>
                        ✅ Post Note
                    </button>
                </div>
            </div>

            <!-- Step 3: Call User -->
            <div class="step" id="step-3" data-cy="step-3">
                <div class="step-header">
                    <h4 class="step-title">✅ STEP 3: Call the phone number assigned to the user (if available).</h4>
                    <span class="status-badge" id="step-3-status" data-cy="step-3-status">Pending</span>
                </div>
                <div class="contact-info">
                    <strong>👤 <span id="user-name">Zach Sowell</span></strong> 📞 <span id="user-phone">+1-470-505-6195</span>
                </div>
                <button class="btn btn-primary" onclick="startStep(3)" data-cy="call-user" disabled>
                    📞 Call User
                </button>
                
                <div class="step-outcome" id="step-3-outcome" style="display: none;">
                    <select id="step-3-select" data-cy="step-3-outcome" onchange="autoPopulateNote(3)">
                        <option value="">Select outcome</option>
                        <option value="no-answer-voicemail">No answer, left voicemail</option>
                        <option value="no-answer-already-left">No answer, voicemail already left</option>
                        <option value="no-answer-unable">No answer, unable to leave voicemail</option>
                        <option value="no-answer-box-full">No answer, voicemail box full</option>
                        <option value="no-answer-not-set">No answer, voicemail not set up</option>
                        <option value="wrong-number">Wrong number</option>
                        <option value="unable-to-connect">Unable to connect</option>
                        <option value="number-invalid">Number invalid, changed, or out of service</option>
                        <option value="confirmed-ok">Spoke with Zach Sowell, confirmed they are OK</option>
                    </select>
                    <textarea id="step-3-note" placeholder="Document the result..." data-cy="step-3-note" oninput="validatePostButton(3)"></textarea>
                    <button class="btn btn-secondary" onclick="postNote(3)" data-cy="step-3-post" style="margin-top: 8px;" disabled>
                        ✅ Post Note
                    </button>
                </div>
            </div>

            <!-- Step 4: Contact Emergency Contacts -->
            <div class="step" id="step-4">
                <div class="step-header">
                    <h4 class="step-title">✅ STEP 4: Contact emergency contacts in order of priority.</h4>
                    <span class="status-badge" id="step-4-status">Pending</span>
                </div>
                <div class="step-content">
                    If there is no answer, but dispatch conditions are met, proceed to STEP 5.<br>
                    If dispatch conditions are not met, repeat STEPS 1, 2, 3 & 4 until someone is reached.
                </div>
                
                <!-- Step 4-1: Daniel Reyes -->
                <div class="step" id="step-4-1" style="margin: 10px 0;">
                    <div class="step-header">
                        <h5 class="step-title">📞 Call Daniel Reyes at +1-587-333-9271</h5>
                        <span class="status-badge" id="step-4-1-status">Pending</span>
                    </div>
                    <div class="contact-info">
                        <strong>👤 Daniel Reyes</strong> 📞 +1-587-333-9271 🏷️ Site Supervisor
                    </div>
                    <button class="btn btn-primary" onclick="startStep('4-1')" data-cy="call-emergency-contact-4-1" disabled>
                        📞 Call Emergency Contact
                    </button>
                    
                    <div class="step-outcome" id="step-4-1-outcome" style="display: none;">
                        <select id="step-4-1-select" data-cy="step-4-1-outcome" onchange="autoPopulateNote('4-1')">
                            <option value="">Select outcome</option>
                            <option value="waiting-30-minutes">Spoke with EC, who will check on user and call back. Waiting 30 minutes</option>
                            <option value="confirmed-ok">Confirmed user is okay and advised to resolve alert</option>
                            <option value="no-answer-voicemail">No answer, left voicemail</option>
                            <option value="no-answer-already-left">No answer, voicemail already left</option>
                            <option value="no-answer-unable">No answer, unable to leave voicemail</option>
                            <option value="no-answer-box-full">No answer, voicemail box full</option>
                            <option value="no-answer-not-set">No answer, voicemail not set up</option>
                            <option value="wrong-number">Wrong number</option>
                            <option value="unable-to-connect">Unable to connect</option>
                            <option value="number-invalid">Number invalid, changed, or out of service</option>
                        </select>
                        <textarea id="step-4-1-note" placeholder="Document the result..." data-cy="step-4-1-note" oninput="validatePostButton('4-1')"></textarea>
                        <button class="btn btn-secondary" onclick="postNote('4-1')" data-cy="step-4-1-post" style="margin-top: 8px;" disabled>
                            ✅ Post Note
                        </button>
                    </div>
                </div>
                
                <!-- Step 4-2: Vanessa Liu -->
                <div class="step" id="step-4-2" style="margin: 10px 0;">
                    <div class="step-header">
                        <h5 class="step-title">📞 Call Vanessa Liu at +1-780-452-1189</h5>
                        <span class="status-badge" id="step-4-2-status">Pending</span>
                    </div>
                    <div class="contact-info">
                        <strong>👤 Vanessa Liu</strong> 📞 +1-780-452-1189 🏷️ Control Room Operator
                    </div>
                    <button class="btn btn-primary" onclick="startStep('4-2')" data-cy="call-emergency-contact-4-2" disabled>
                        📞 Call Emergency Contact
                    </button>
                    
                    <div class="step-outcome" id="step-4-2-outcome" style="display: none;">
                        <select id="step-4-2-select" data-cy="step-4-2-outcome" onchange="autoPopulateNote('4-2')">
                            <option value="">Select outcome</option>
                            <option value="waiting-30-minutes">Spoke with EC, who will check on user and call back. Waiting 30 minutes</option>
                            <option value="confirmed-ok">Confirmed user is okay and advised to resolve alert</option>
                            <option value="no-answer-voicemail">No answer, left voicemail</option>
                            <option value="no-answer-already-left">No answer, voicemail already left</option>
                            <option value="no-answer-unable">No answer, unable to leave voicemail</option>
                            <option value="no-answer-box-full">No answer, voicemail box full</option>
                            <option value="no-answer-not-set">No answer, voicemail not set up</option>
                            <option value="wrong-number">Wrong number</option>
                            <option value="unable-to-connect">Unable to connect</option>
                            <option value="number-invalid">Number invalid, changed, or out of service</option>
                        </select>
                        <textarea id="step-4-2-note" placeholder="Document the result..." data-cy="step-4-2-note" oninput="validatePostButton('4-2')"></textarea>
                        <button class="btn btn-secondary" onclick="postNote('4-2')" data-cy="step-4-2-post" style="margin-top: 8px;" disabled>
                            ✅ Post Note
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 5: Dispatch Decision -->
            <div class="step active" id="step-5">
                <div class="step-header">
                    <h4 class="step-title">✅ STEP 5: If a valid and up to date location is available, dispatch emergency services (EMS).</h4>
                    <span class="status-badge" id="step-5-status">Pending</span>
                </div>

                <div class="step-outcome" id="step-5-outcome">
                    <label for="dispatch-decision">Dispatch conditions met?</label>
                    <select id="dispatch-decision" data-cy="dispatch-decision" onchange="handleDispatchDecision()">
                        <option value="">-- Select --</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                    
                    <div id="dispatch-service-container" style="display: none;">
                        <label for="dispatch-service">Dispatch Service Type</label>
                        <select id="dispatch-service" data-cy="dispatch-service">
                            <option value="">-- Select Service --</option>
                            <option value="EMS">EMS</option>
                            <option value="Police">Police</option>
                            <option value="Fire">Fire</option>
                            <option value="EMS and Fire">EMS and Fire</option>
                            <option value="EMS and Police">EMS and Police</option>
                            <option value="Fire and Police">Fire and Police</option>
                            <option value="EMS, Fire and Police">EMS, Fire and Police</option>
                        </select>
                        <button class="btn btn-danger" onclick="callDispatch()" data-cy="call-dispatch" style="margin: 10px 0;">
                            📞 Call Dispatch
                        </button>
                    </div>
                    
                    <div id="skip-reason-container" style="display: none;">
                        <label for="skip-reason">Reason for skipping dispatch:</label>
                        <select id="skip-reason" data-cy="skip-reason" onchange="autoPopulateSkipReason()">
                            <option value="">-- Select reason --</option>
                            <option value="location-invalid">Location invalid or outdated</option>
                            <option value="alert-old">Alert older than 24 hours</option>
                            <option value="device-moving">Device is moving faster than 5 km/h</option>
                            <option value="device-offline">Device is offline</option>
                        </select>
                    </div>
                    
                    <textarea id="step-5-note" placeholder="Document the dispatch decision..." data-cy="step-5-note" oninput="validatePostButton(5)"></textarea>
                    <button class="btn btn-secondary" onclick="postNote(5)" data-cy="step-5-post" style="margin-top: 8px;" disabled>
                        ✅ Post Note
                    </button>
                </div>
            </div>

            <!-- Resolution Section -->
            <div class="resolution-section" id="resolution-section">
                <div class="step-header">
                    <h3>✅ RESOLUTION</h3>
                    <span class="status-badge" id="resolution-status" data-cy="resolution-status">Pending</span>
                </div>

                <label for="resolution-reason">Reason for resolving alert:</label>
                <select id="resolution-reason" data-cy="resolution-reason">
                    <option value="">-- Select reason --</option>
                    <option value="false-alert-without-dispatch">False alert without dispatch</option>
                    <option value="false-alert-with-dispatch">False alert with dispatch</option>
                    <option value="incident-without-dispatch">Incident without dispatch</option>
                    <option value="incident-with-dispatch">Incident with dispatch</option>
                    <option value="pre-alert">Pre-Alert</option>
                    <option value="demo-training">Demo/Training</option>
                    <option value="multiple-alert">Multiple alert</option>
                </select>
                
                <div class="resolution-buttons">
                    <button class="btn btn-danger" onclick="resolveAlert()" data-cy="resolve-alert">
                        ✅ Resolve Alert
                    </button>
                    <button class="btn btn-secondary" onclick="cancelResolution()" data-cy="cancel-resolution">
                        ❌ Cancel Resolution
                    </button>
                </div>
            </div>
        </div>

        <!-- Gas Readings Card -->
        <div class="gas-readings-card" id="gasReadingsCard" data-cy="gas-readings-card">
            <h3>🔎 Gas Readings (Live)</h3>
            
            <div class="triggered-by" id="triggeredBy">
                Alert Type: <span id="alert-trigger" data-cy="alert-trigger">H₂S High Threshold</span>
            </div>
            
            <div class="gas-reading" id="h2s-reading" data-cy="h2s-reading">
                <span>🔴 H₂S: <span class="gas-value" id="h2s-value">17.90 ppm</span></span>
                <span class="gas-status high" id="h2s-status" data-cy="h2s-status">HIGH</span>
            </div>
            
            <div class="gas-reading" id="co-reading" data-cy="co-reading">
                <span>🟢 CO: <span class="gas-value" id="co-value">0.00 ppm</span></span>
                <span class="gas-status normal" id="co-status" data-cy="co-status">NORMAL</span>
            </div>
            
            <div class="gas-reading" id="o2-reading">
                <span>🟢 O₂: <span class="gas-value" id="o2-value">20.90 %vol</span></span>
                <span class="gas-status normal" id="o2-status">NORMAL</span>
            </div>
            
            <div class="gas-reading" id="lel-reading">
                <span>🟢 LEL: <span class="gas-value" id="lel-value">4.00 %LEL</span></span>
                <span class="gas-status normal" id="lel-status">NORMAL</span>
            </div>
            
            <div class="last-updated" id="lastUpdated">
                Last updated: <span id="gas-timestamp" data-cy="gas-timestamp">08:46:05 CDT</span>
            </div>
        </div>
    </div>

    <!-- Timer Complete Notification -->
    <div class="timer-notification" id="timerNotification">
        <h3>⏰ Timer Complete!</h3>
        <p id="timerNotificationText">30-minute callback wait has expired.</p>
        <button class="btn btn-primary" onclick="dismissNotification()" data-cy="dismiss-timer-notification">
            Acknowledge
        </button>
    </div>

    <!-- Gas Override Modal -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="override-modal" id="overrideModal" data-cy="override-modal">
        <h3>⚠️ Gas levels are still elevated</h3>
        <p>Are you sure you want to resolve this alert?</p>
        
        <div class="gas-reading-display" id="overrideGasReading" data-cy="override-gas-reading">
            Current Gas Reading: H₂S: 17.90 ppm (HIGH)
        </div>
        
        <label for="override-reason">Please confirm the reason for override:</label>
        <select id="override-reason" data-cy="override-reason">
            <option value="">-- Select override reason --</option>
            <option value="sensor-error">Sensor error</option>
            <option value="user-confirmed-safety">User confirmed safety</option>
            <option value="equipment-malfunction">Equipment malfunction</option>
            <option value="other">Other</option>
        </select>
        
        <div class="modal-buttons">
            <button class="btn btn-danger" onclick="confirmOverride()" id="confirmOverrideBtn" disabled data-cy="confirm-override-btn">
                Resolve Alert
            </button>
            <button class="btn btn-secondary" onclick="cancelOverride()">
                Cancel
            </button>
        </div>
    </div>

    <script>
        // Global timer management
        let globalTimerInterval = null;
        let activeTimerData = null;
        let tabFlashInterval = null;
        let localTimerInterval = null;
        let beepTimeouts = [];
        let originalTitle = "Emergency Response Protocol - Unified Alert Management";
        let gasUpdateInterval = null;
        
        // Alert data - can be injected or use demo data
        const alertData = window.testAlertFixture || {
            "id": "7174694",
            "alert_id": "7174694",
            "status": "Acknowledged",
            "type": "Gas Alert",
            "gas_type": "H2S",
            "alert_subtype": "High threshold detected (H₂S)",
            "user": "Zach Sowell",
            "employee_id": "373595",
            "organization": "WM - Corporate",
            "trade_role": "Gas Technician",
            "device_id": "3571031421",
            "device_name": "Unit 3571031421",
            "device_status": "Online",
            "device_type": "G7c",
            "device_mode": "Normal operation",
            "mobile": "+1 470-505-6195",
            "work": "+1 470-505-6195",
            "home": "+1 208-995-4975",
            "last_location": "144252 434 Ave E, Aldersyde, AB T0L 0A0, Canada",
            "latitude": 50.66004,
            "longitude": -113.7685769,
            "alert_date": "2025-07-14T08:18:00-06:00",
            "is_gas_alert": true,
            "gas_protocol_type": "standard",
            "requires_2min_monitoring": false
        };

        // Gas thresholds (G7c Standard Configuration)
        const gasThresholds = {
            h2s: { lowThreshold: 5.00, highThreshold: 10.00, unit: " ppm" },
            co: { lowThreshold: 100.00, highThreshold: 200.00, unit: " ppm" },
            o2: { enrichmentLow: 23.50, enrichmentHigh: 25.00, depletionHigh: 18.00, depletionLow: 19.50, unit: " %vol" },
            lel: { lowThreshold: 10.00, highThreshold: 20.00, unit: " %LEL" }
        };

        // Current gas readings (simulated real-time data)
        let currentGasReadings = {
            h2s: { value: 17.90, unit: " ppm", status: "HIGH" },
            co: { value: 0.00, unit: " ppm", status: "NORMAL" },
            o2: { value: 20.90, unit: " %vol", status: "NORMAL" },
            lel: { value: 4.00, unit: " %LEL", status: "NORMAL" }
        };

        // Device response options
        const deviceResponseOptions = ["Send help", "No", "Yes", "Understood", "Not understood", "Hazard in area", "I don't know", "I am stranded", "Issue resolved", "False alarm"];

        // Protocol state management
        let protocolState = {
            completedSteps: [],
            currentStep: 1,
            dispatchMade: false,
            dispatchTimerStarted: false,
            alertResolved: false,
            deviceMessageReceived: false
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeAlert();
            startGasMonitoring();
            validatePostButton(2); // Step 2 starts with pre-filled text
        });

        function initializeAlert() {
            // Update UI with alert data
            document.getElementById('employee-name').textContent = alertData.user;
            document.getElementById('alert-type').textContent = alertData.alert_subtype || alertData.type;
            document.getElementById('alert-id').textContent = alertData.alert_id || alertData.id;
            document.getElementById('employee-details').textContent = `${alertData.user} (ID: ${alertData.employee_id})`;
            document.getElementById('device-details').textContent = `${alertData.device_type}-${alertData.device_id}`;
            document.getElementById('mobile-number').textContent = alertData.mobile;
            document.getElementById('alert-time').textContent = formatAlertTime(alertData.alert_date);
            document.getElementById('user-name').textContent = alertData.user;
            document.getElementById('user-phone').textContent = alertData.mobile;
            
            // Update alert trigger info
            document.getElementById('alert-trigger').textContent = alertData.alert_subtype || 'Alert Detection';
            
            // Update step text with user name
            updateStepUserReferences();
            
            // Check if 2-minute monitoring is required
            if (alertData.requires_2min_monitoring) {
                start2MinuteMonitoring();
            }
        }

        function updateStepUserReferences() {
            // Update Step 1 options
            const step1Select = document.getElementById('step-1-select');
            if (step1Select) {
                const confirmOption = step1Select.querySelector('option[value="confirmed-ok"]');
                if (confirmOption) {
                    confirmOption.textContent = `Spoke with ${alertData.user}. Confirmed they are OK. Resolving alert.`;
                }
            }
            
            // Update Step 3 options
            const step3Select = document.getElementById('step-3-select');
            if (step3Select) {
                const confirmOption = step3Select.querySelector('option[value="confirmed-ok"]');
                if (confirmOption) {
                    confirmOption.textContent = `Spoke with ${alertData.user}, confirmed they are OK`;
                }
            }
        }

        function startGasMonitoring() {
            updateGasDisplay();
            
            // Update gas readings every 5 seconds
            gasUpdateInterval = setInterval(() => {
                // Simulate minor fluctuations for demo
                simulateGasFluctuations();
                updateGasDisplay();
            }, 5000);
        }

        function simulateGasFluctuations() {
            // Keep readings stable for clean demo state
            // Gas levels will only change through user interaction or manual testing
            updateGasStatus();
        }

        function updateGasStatus() {
            // H2S status
            currentGasReadings.h2s.status = currentGasReadings.h2s.value >= gasThresholds.h2s.highThreshold ? "HIGH" : "NORMAL";
            
            // CO status
            currentGasReadings.co.status = currentGasReadings.co.value >= gasThresholds.co.highThreshold ? "HIGH" : "NORMAL";
            
            // O2 status (depletion or enrichment)
            const o2Value = currentGasReadings.o2.value;
            currentGasReadings.o2.status = (o2Value <= gasThresholds.o2.depletionHigh || o2Value >= gasThresholds.o2.enrichmentHigh) ? "HIGH" : "NORMAL";
            
            // LEL status
            currentGasReadings.lel.status = currentGasReadings.lel.value >= gasThresholds.lel.highThreshold ? "HIGH" : "NORMAL";
        }

        function updateGasDisplay() {
            const timestamp = new Date().toLocaleTimeString('en-US', {
                hour12: false,
                timeZone: 'America/Chicago',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // Update gas readings
            Object.keys(currentGasReadings).forEach(gas => {
                const reading = currentGasReadings[gas];
                const valueElement = document.getElementById(`${gas}-value`);
                const statusElement = document.getElementById(`${gas}-status`);
                const readingElement = document.getElementById(`${gas}-reading`);
                
                if (valueElement) {
                    valueElement.textContent = `${reading.value.toFixed(2)}${reading.unit}`;
                }
                
                if (statusElement) {
                    statusElement.textContent = reading.status;
                    statusElement.className = `gas-status ${reading.status.toLowerCase()}`;
                }
                
                if (readingElement) {
                    const icon = reading.status === "HIGH" ? "🔴" : "🟢";
                    const gasLabel = gas === 'h2s' ? 'H₂S' : gas === 'o2' ? 'O₂' : gas.toUpperCase();
                    readingElement.querySelector('span').innerHTML = `${icon} ${gasLabel}: <span class="gas-value">${reading.value.toFixed(2)}${reading.unit}</span>`;
                }
            });
            
            // Update timestamp
            document.getElementById('gas-timestamp').textContent = `${timestamp} CDT`;
        }

        function getCurrentGasReading() {
            // Return the primary gas that triggered the alert, or first HIGH gas, or H2S as default
            const triggerGas = alertData.gas_type?.toLowerCase() || 'h2s';
            const gasReading = currentGasReadings[triggerGas];
            
            if (gasReading) {
                return {
                    type: triggerGas === 'h2s' ? 'H₂S' : triggerGas === 'o2' ? 'O₂' : triggerGas.toUpperCase(),
                    value: gasReading.value.toFixed(2),
                    unit: gasReading.unit,
                    status: gasReading.status
                };
            }
            
            // Fallback
            return {
                type: 'H₂S',
                value: '17.90',
                unit: ' ppm',
                status: 'HIGH'
            };
        }

        function isGasLevelHigh() {
            return Object.values(currentGasReadings).some(reading => reading.status === "HIGH");
        }

        function start2MinuteMonitoring() {
            addLogEntry(`Monitoring gas levels for 2 minutes.`, 'timer');
            
            // Start 2-minute countdown
            startGlobalTimer('monitoring', '2-Minute Gas Monitoring', 'Auto-resolution check', 120);
            
            // Check gas levels when timer expires
            setTimeout(() => {
                if (!isGasLevelHigh()) {
                    autoResolveAlert();
                } else {
                    addLogEntry(`Gas levels remain high after 2 minutes. Escalation required.`, 'timer');
                    addLogEntry(`Entering guided escalation protocol.`, 'general');
                }
            }, 120000);
        }

        function autoResolveAlert() {
            const gasReading = getCurrentGasReading();
            addLogEntry(`Gas levels have returned to acceptable levels. Resolving alert. Gas Reading: ${gasReading.type}: ${gasReading.value}${gasReading.unit}`, 'resolution');
            
            // Auto-select resolution reason
            const resolutionSelect = document.getElementById('resolution-reason');
            if (resolutionSelect) {
                resolutionSelect.value = 'incident-without-dispatch';
            }
            
            // Resolve the alert
            protocolState.alertResolved = true;
            markResolutionComplete();
        }

        // Logging functions
        function addLogEntry(message, type = 'general') {
            const logContainer = document.getElementById('protocolLog');
            const placeholder = logContainer.querySelector('.log-placeholder');
            
            if (placeholder) {
                placeholder.remove();
            }
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString('en-US', {
                hour12: false,
                timeZone: 'America/Chicago',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            entry.innerHTML = `<strong>[${timestamp} CDT]</strong> ${message} <span style="float: right;">Op 417</span>`;
            
            logContainer.insertBefore(entry, logContainer.firstChild);
        }

        function addGasLogEntry(message, stepId = null) {
            const gasReading = getCurrentGasReading();
            const gasInfo = `Gas level: ${gasReading.status} – Gas Reading: ${gasReading.type}: ${gasReading.value}${gasReading.unit}`;
            
            addLogEntry(`${message}. ${gasInfo}`, stepId ? 'step' : 'gas');
        }

        function addManualNote() {
            const noteText = document.getElementById('manual-notes').value.trim();
            if (!noteText) {
                alert('Please enter a note first');
                return;
            }
            
            if (alertData.is_gas_alert) {
                addGasLogEntry(noteText);
            } else {
                addLogEntry(noteText, 'general');
            }
            
            document.getElementById('manual-notes').value = '';
        }

        // Step management functions
        function startStep(stepId) {
            const outcomeSection = document.getElementById(`step-${stepId}-outcome`);
            if (outcomeSection) {
                outcomeSection.style.display = 'block';
            }
            
            if (stepId === 2) {
                startLocalTimer();
                // Show device response area
                document.getElementById('device-response-2').style.display = 'block';
            }
        }

        function validatePostButton(stepId) {
            const note = document.getElementById(`step-${stepId}-note`);
            const button = document.querySelector(`[data-cy="step-${stepId}-post"]`);
            
            if (!note || !button) return;
            
            const hasText = note.value.trim().length > 0;
            
            if (hasText) {
                button.disabled = false;
                button.classList.remove('btn-secondary');
                button.classList.add('btn-success');
            } else {
                button.disabled = true;
                button.classList.remove('btn-success');
                button.classList.add('btn-secondary');
            }
        }

        function autoPopulateNote(stepId) {
            const select = document.getElementById(`step-${stepId}-select`);
            const note = document.getElementById(`step-${stepId}-note`);
            
            if (!select || !note) return;
            
            const outcome = select.value;
            if (!outcome) return;
            
            const autoNotes = {
                1: {
                    'no-answer': 'Called device. No answer.',
                    'unable-to-call': 'Unable to call, device offline.',
                    'confirmed-ok': `Called device. Spoke with ${alertData.user}. Confirmed they are OK. Resolving alert.`
                },
                3: {
                    'no-answer-voicemail': `Called ${alertData.user} at ${alertData.mobile}. No answer, left voicemail.`,
                    'no-answer-already-left': `Called ${alertData.user} at ${alertData.mobile}. No answer, voicemail already left.`,
                    'no-answer-unable': `Called ${alertData.user} at ${alertData.mobile}. No answer, unable to leave voicemail.`,
                    'no-answer-box-full': `Called ${alertData.user} at ${alertData.mobile}. No answer, voicemail box full.`,
                    'no-answer-not-set': `Called ${alertData.user} at ${alertData.mobile}. No answer. Unable to leave voicemail, voicemail box not set up.`,
                    'wrong-number': `Called ${alertData.user} at ${alertData.mobile}. Wrong number.`,
                    'unable-to-connect': `Called ${alertData.user} at ${alertData.mobile}. Unable to connect.`,
                    'number-invalid': `Called ${alertData.user} at ${alertData.mobile}. Number invalid, changed, or out of service.`,
                    'confirmed-ok': `Called ${alertData.user} at ${alertData.mobile}. Spoke with ${alertData.user}, confirmed they are OK. Resolving alert.`
                },
                '4-1': {
                    'waiting-30-minutes': 'Called Daniel Reyes at +1-587-333-9271. Spoke with EC, who will check on user and call back. Waiting 30 minutes.',
                    'confirmed-ok': 'Called Daniel Reyes at +1-587-333-9271. Confirmed user is okay and advised to resolve alert.',
                    'no-answer-voicemail': 'Called Daniel Reyes at +1-587-333-9271. No answer, left voicemail.',
                    'no-answer-already-left': 'Called Daniel Reyes at +1-587-333-9271. No answer, voicemail already left.',
                    'no-answer-unable': 'Called Daniel Reyes at +1-587-333-9271. No answer, unable to leave voicemail.',
                    'no-answer-box-full': 'Called Daniel Reyes at +1-587-333-9271. No answer, voicemail box full.',
                    'no-answer-not-set': 'Called Daniel Reyes at +1-587-333-9271. No answer, voicemail not set up.',
                    'wrong-number': 'Called Daniel Reyes at +1-587-333-9271. Wrong number.',
                    'unable-to-connect': 'Called Daniel Reyes at +1-587-333-9271. Unable to connect.',
                    'number-invalid': 'Called Daniel Reyes at +1-587-333-9271. Number invalid, changed, or out of service.'
                },
                '4-2': {
                    'waiting-30-minutes': 'Called Vanessa Liu at +1-780-452-1189. Spoke with EC, who will check on user and call back. Waiting 30 minutes.',
                    'confirmed-ok': 'Called Vanessa Liu at +1-780-452-1189. Confirmed user is okay and advised to resolve alert.',
                    'no-answer-voicemail': 'Called Vanessa Liu at +1-780-452-1189. No answer, left voicemail.',
                    'no-answer-already-left': 'Called Vanessa Liu at +1-780-452-1189. No answer, voicemail already left.',
                    'no-answer-unable': 'Called Vanessa Liu at +1-780-452-1189. No answer, unable to leave voicemail.',
                    'no-answer-box-full': 'Called Vanessa Liu at +1-780-452-1189. No answer, voicemail box full.',
                    'no-answer-not-set': 'Called Vanessa Liu at +1-780-452-1189. No answer, voicemail not set up.',
                    'wrong-number': 'Called Vanessa Liu at +1-780-452-1189. Wrong number.',
                    'unable-to-connect': 'Called Vanessa Liu at +1-780-452-1189. Unable to connect.',
                    'number-invalid': 'Called Vanessa Liu at +1-780-452-1189. Number invalid, changed, or out of service.'
                }
            };
            
            const autoNote = autoNotes[stepId]?.[outcome];
            if (autoNote) {
                note.value = autoNote;
                validatePostButton(stepId);
            }
        }
        
        function postNote(stepId) {
            const select = document.getElementById(`step-${stepId}-select`);
            const note = document.getElementById(`step-${stepId}-note`);
            
            if (!note) {
                console.error(`Note element not found for step ${stepId}`);
                return;
            }
            
            // Check if textarea has content
            const noteText = note.value.trim();
            if (!noteText) {
                alert('Please enter text before posting note');
                return;
            }
            
            // For steps with dropdowns, validate outcome selection
            let outcome = '';
            if (select) {
                outcome = select.value;
                if (!outcome) {
                    alert('Please select an outcome first');
                    return;
                }
            }
            
            // FIXED: Log with gas data if this is a gas alert (remove double period)
            if (alertData.is_gas_alert) {
                addGasLogEntry(`Step ${stepId}: ${noteText}`, stepId);
            } else {
                addLogEntry(`Step ${stepId}: ${noteText}`, 'step');
            }
            
            // Clear the textarea for fresh input
            note.value = '';
            
            // Re-validate the button after clearing (should disable it)
            validatePostButton(stepId);
            
            // Mark step complete
            markStepComplete(stepId);
            
            // Handle special outcomes
            handleSpecialOutcomes(stepId, outcome);
        }
        
        function markStepComplete(stepId) {
            const step = document.getElementById(`step-${stepId}`);
            const statusBadge = document.getElementById(`step-${stepId}-status`);
            
            if (step) {
                step.classList.add('completed');
                step.classList.remove('active');
            }
            
            if (statusBadge) {
                statusBadge.textContent = 'Completed';
                statusBadge.classList.add('completed');
            }
            
            enableNextStep(stepId);
        }
        
        function enableNextStep(stepId) {
            const nextSteps = {
                1: '2',
                2: '3', 
                3: '4-1',
                '4-1': '4-2',
                '4-2': null,
                5: 'resolution'
            };
            
            const nextStepId = nextSteps[stepId];
            if (nextStepId && nextStepId !== 'resolution') {
                const nextStep = document.getElementById(`step-${nextStepId}`);
                const nextButton = nextStep?.querySelector('button:not([onclick*="postNote"])');
                
                if (nextStep) {
                    nextStep.classList.add('active');
                }
                if (nextButton) {
                    nextButton.disabled = false;
                    nextButton.classList.remove('btn-secondary');
                    nextButton.classList.add('btn-primary');
                }
            }
        }
        
        function handleSpecialOutcomes(stepId, outcome) {
            if (outcome === 'confirmed-ok') {
                setTimeout(() => {
                    const resolutionSelect = document.getElementById('resolution-reason');
                    if (resolutionSelect) {
                        resolutionSelect.value = 'false-alert-without-dispatch';
                    }
                    blockRemainingSteps(stepId, 'User confirmed OK');
                }, 500);
            }
            
            if ((stepId === '4-1' || stepId === '4-2') && outcome === 'waiting-30-minutes') {
                const contactNames = { '4-1': 'Daniel Reyes', '4-2': 'Vanessa Liu' };
                startGlobalTimer(stepId, 'EC Callback', contactNames[stepId], 1800);
            }
            
            if (stepId === 5 && protocolState.dispatchMade && !protocolState.dispatchTimerStarted) {
                protocolState.dispatchTimerStarted = true;
                startGlobalTimer(5, 'Dispatch Follow-up', 'Check status with Emergency Services', 1800);
            }
            
            if (stepId === 5 && !protocolState.dispatchMade) {
                setTimeout(() => {
                    resetProtocolStepsOnly();
                }, 500);
            }
        }

        function blockRemainingSteps(currentStepId, reason) {
            const stepOrder = ['1', '2', '3', '4', '4-1', '4-2', '5'];
            const currentIndex = stepOrder.indexOf(currentStepId.toString());
            
            for (let i = currentIndex + 1; i < stepOrder.length; i++) {
                const nextStepId = stepOrder[i];
                const nextStep = document.getElementById(`step-${nextStepId}`);
                const nextButton = nextStep?.querySelector('button:not([onclick*="postNote"])');
                const nextStatus = document.getElementById(`step-${nextStepId}-status`);
                
                if (nextStep) {
                    nextStep.style.opacity = '0.5';
                    nextStep.style.pointerEvents = 'none';
                }
                if (nextButton) {
                    nextButton.disabled = true;
                    nextButton.textContent = `Skipped - ${reason}`;
                    nextButton.classList.remove('btn-primary');
                    nextButton.classList.add('btn-secondary');
                }
                if (nextStatus) {
                    nextStatus.textContent = 'Skipped';
                    nextStatus.style.background = '#6c757d';
                }
            }
        }

        function resetProtocolStepsOnly() {
            const stepsToReset = ['1', '2', '3', '4-1', '4-2'];
            
            stepsToReset.forEach(stepId => {
                const step = document.getElementById(`step-${stepId}`);
                const button = step?.querySelector('button:not([onclick*="postNote"])');
                const status = document.getElementById(`step-${stepId}-status`);
                
                if (step) {
                    step.classList.remove('completed');
                    step.classList.add('active');
                    step.style.opacity = '';
                    step.style.pointerEvents = '';
                }
                
                if (button) {
                    button.disabled = false;
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-primary');
                    
                    if (stepId === '1') button.textContent = '📞 Call G7c Device';
                    else if (stepId === '2') button.textContent = '📤 Send Message';
                    else if (stepId === '3') button.textContent = '📞 Call User';
                    else if (stepId === '4-1' || stepId === '4-2') button.textContent = '📞 Call Emergency Contact';
                }
                
                if (status) {
                    status.textContent = 'Pending';
                    status.classList.remove('completed');
                    status.style.background = '';
                }
            });
        }

        // Device messaging functions
        function simulateDeviceResponse(responseText) {
            if (protocolState.deviceMessageReceived) return; // Only one message per demo
            
            protocolState.deviceMessageReceived = true;
            const timestamp = new Date().toLocaleTimeString('en-US', {
                hour12: false,
                timeZone: 'America/Chicago',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // Display the response
            document.getElementById('device-message-text').textContent = `"${responseText}"`;
            document.getElementById('device-timestamp').textContent = `Received at ${timestamp} CDT`;
            document.getElementById('received-message').style.display = 'block';
            
            // Log the response with gas data
            addGasLogEntry(`Received "${responseText}" from device`);
            
            // Determine action based on response and gas level
            if (['Issue resolved', 'False alarm', 'No'].includes(responseText)) {
                if (!isGasLevelHigh()) {
                    document.getElementById('soc-acknowledgment').style.display = 'block';
                } else {
                    // Gas still HIGH - continue protocol
                    addLogEntry(`Device indicates resolution, but gas levels remain elevated. Continuing protocol escalation.`, 'general');
                }
            } else if (responseText === 'Send help') {
                addLogEntry(`Device user requests immediate assistance. Escalating to dispatch.`, 'general');
                triggerImmediateDispatch();
            }
        }

        function sendAcknowledgment(acknowledmentText) {
            const timestamp = new Date().toLocaleTimeString('en-US', {
                hour12: false,
                timeZone: 'America/Chicago',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            addLogEntry(`Sent "${acknowledmentText}" to device`, 'general');
            
            // Hide acknowledgment buttons after sending
            document.getElementById('soc-acknowledgment').style.display = 'none';
            
            // If gas is normal, suggest resolution
            if (!isGasLevelHigh()) {
                const resolutionSelect = document.getElementById('resolution-reason');
                if (resolutionSelect && !resolutionSelect.value) {
                    resolutionSelect.value = 'false-alert-without-dispatch';
                    addLogEntry(`Suggested resolution: ${resolutionSelect.options[resolutionSelect.selectedIndex].text}`, 'general');
                }
            }
        }

        function triggerImmediateDispatch() {
            // Auto-select dispatch decision
            const dispatchDecision = document.getElementById('dispatch-decision');
            if (dispatchDecision) {
                dispatchDecision.value = 'yes';
                handleDispatchDecision();
            }
            
            // Auto-select EMS
            const dispatchService = document.getElementById('dispatch-service');
            if (dispatchService) {
                dispatchService.value = 'EMS';
            }
            
            // Auto-populate Step 5 note
            const step5Note = document.getElementById('step-5-note');
            if (step5Note) {
                step5Note.value = 'Device user requested immediate assistance. Dispatching emergency services.';
                validatePostButton(5);
            }
        }

        // Timer functions
        function startLocalTimer() {
            const timerElement = document.getElementById('step-2-timer');
            const countdownElement = document.getElementById('step-2-countdown');
            
            if (!timerElement || !countdownElement) return;
            
            if (localTimerInterval) {
                clearInterval(localTimerInterval);
            }
            
            timerElement.style.display = 'flex';
            
            let timeLeft = 120;
            
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            localTimerInterval = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(localTimerInterval);
                    localTimerInterval = null;
                    
                    flashTimerArea(timerElement, countdownElement, "⏰ TIMER EXPIRED - 2 minutes elapsed");
                    playTimerSound();
                    startTabFlashing("🚨 TIMER EXPIRED");
                    
                    addLogEntry(`⏰ 2-minute message wait completed`, 'timer');
                }
            }, 1000);
        }

        function cancelLocalTimer(stepId) {
            const timerElement = document.getElementById(`step-${stepId}-timer`);
            if (timerElement) {
                timerElement.style.display = 'none';
                timerElement.style.animation = '';
            }
            
            if (localTimerInterval) {
                clearInterval(localTimerInterval);
                localTimerInterval = null;
            }
            
            clearBeepTimeouts();
            stopTabFlashing();
            
            addLogEntry(`⏹️ Cancelled local timer for step ${stepId}`, 'timer');
        }

        // FIXED: Dispatch functions with proper default resolution reasons
        function handleDispatchDecision() {
            const decision = document.getElementById('dispatch-decision').value;
            const serviceContainer = document.getElementById('dispatch-service-container');
            const reasonContainer = document.getElementById('skip-reason-container');
            const note = document.getElementById('step-5-note');
            const resolutionSelect = document.getElementById('resolution-reason');
            
            if (decision === 'yes') {
                serviceContainer.style.display = 'block';
                reasonContainer.style.display = 'none';
                if (note) note.value = '';
                
                // FIXED: Auto-select default resolution for dispatch
                if (resolutionSelect) {
                    resolutionSelect.value = 'incident-with-dispatch';
                }
            } else if (decision === 'no') {
                serviceContainer.style.display = 'none';
                reasonContainer.style.display = 'block';
                if (note) note.value = '';
                
                // FIXED: Auto-select default resolution for no dispatch
                if (resolutionSelect) {
                    resolutionSelect.value = 'incident-without-dispatch';
                }
            } else {
                serviceContainer.style.display = 'none';
                reasonContainer.style.display = 'none';
                if (note) note.value = '';
                
                if (resolutionSelect) {
                    resolutionSelect.value = '';
                }
            }
            
            validatePostButton(5);
        }

        function callDispatch() {
            const service = document.getElementById('dispatch-service').value;
            if (!service) {
                alert('Please select a dispatch service first');
                return;
            }
            
            protocolState.dispatchMade = true;
            addLogEntry(`🚑 Initiating dispatch.`, 'general');
            
            const now = new Date();
            const locationTime = now.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                timeZone: 'America/Chicago'
            }) + ' at ' + now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
                timeZone: 'America/Chicago'
            }) + ' CDT';
            
            const note = document.getElementById('step-5-note');
            if (note) {
                note.value = `Called dispatch, spoke with ___. Requested ${service} dispatch to the following location:

Last Location: ${locationTime}
Approximate Address: ${alertData.last_location}
Latitude / Longitude: ${alertData.latitude}, ${alertData.longitude}
Speed: 0 km/h

Waiting 30 minutes.`;
                
                validatePostButton(5);
            }
        }

        function autoPopulateSkipReason() {
            const reasonSelect = document.getElementById('skip-reason');
            const note = document.getElementById('step-5-note');
            
            if (!reasonSelect || !note) return;
            
            const reason = reasonSelect.value;
            if (!reason) return;
            
            const skipReasons = {
                'location-invalid': 'Unable to dispatch. Location invalid or outdated. Cannot provide accurate address/coordinates for emergency services. Repeating protocol steps until someone is reached.',
                'alert-old': 'Unable to dispatch. Alert older than 24 hours. Repeating protocol steps until someone is reached.',
                'device-moving': 'Unable to dispatch. Device is moving faster than 5 km/h. Repeating protocol steps until someone is reached.',
                'device-offline': 'Unable to dispatch. Device is offline. Cannot confirm current location accuracy. Repeating protocol steps until someone is reached.'
            };
            
            const autoNote = skipReasons[reason];
            if (autoNote) {
                note.value = autoNote;
                validatePostButton(5);
            }
        }

        // Resolution functions
        function resolveAlert() {
            const reason = document.getElementById('resolution-reason').value;
            if (!reason) {
                alert('Please select a resolution reason first');
                return;
            }
            
            // Check if gas levels are high and require override
            if (alertData.is_gas_alert && isGasLevelHigh()) {
                showOverrideModal();
                return;
            }
            
            completeResolution(reason);
        }

        function showOverrideModal() {
            const gasReading = getCurrentGasReading();
            document.getElementById('overrideGasReading').textContent = `Current Gas Reading: ${gasReading.type}: ${gasReading.value}${gasReading.unit} (${gasReading.status})`;
            
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('overrideModal').style.display = 'block';
            
            // Enable/disable confirm button based on override reason selection
            const overrideReasonSelect = document.getElementById('override-reason');
            const confirmBtn = document.getElementById('confirmOverrideBtn');
            
            overrideReasonSelect.addEventListener('change', function() {
                confirmBtn.disabled = !this.value;
            });
        }

        function confirmOverride() {
            const overrideReason = document.getElementById('override-reason').value;
            if (!overrideReason) {
                alert('Please select an override reason');
                return;
            }
            
            const reason = document.getElementById('resolution-reason').value;
            const gasReading = getCurrentGasReading();
            
            // Log the override
            addLogEntry(`Resolved alert despite high gas levels – Gas Reading: ${gasReading.type}: ${gasReading.value}${gasReading.unit}. Override reason: ${overrideReason}.`, 'resolution');
            
            cancelOverride();
            completeResolution(reason);
        }

        function cancelOverride() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('overrideModal').style.display = 'none';
            
            // Reset override reason
            document.getElementById('override-reason').value = '';
            document.getElementById('confirmOverrideBtn').disabled = true;
        }

        function completeResolution(reason) {
            protocolState.alertResolved = true;
            const reasonText = document.getElementById('resolution-reason').options[document.getElementById('resolution-reason').selectedIndex].text;
            
            if (alertData.is_gas_alert) {
                addGasLogEntry(`Alert resolved: ${reasonText}`);
            } else {
                addLogEntry(`✅ Alert resolved: ${reasonText}`, 'resolution');
            }
            
            markResolutionComplete();
            
            if (globalTimerInterval) {
                cancelGlobalTimer();
            }
            
            // Stop gas monitoring
            if (gasUpdateInterval) {
                clearInterval(gasUpdateInterval);
            }
        }

        function markResolutionComplete() {
            const resolutionBadge = document.getElementById('resolution-status');
            if (resolutionBadge) {
                resolutionBadge.textContent = 'Completed';
                resolutionBadge.classList.add('completed');
            }
            
            const resolveButton = document.querySelector('[data-cy="resolve-alert"]');
            if (resolveButton) {
                resolveButton.disabled = true;
                resolveButton.classList.remove('btn-danger');
                resolveButton.classList.add('btn-secondary');
            }
            
            const container = document.querySelector('.container');
            if (container) {
                container.classList.add('alert-resolved');
            }
        }

        function cancelResolution() {
            addLogEntry(`❌ Resolution cancelled`, 'general');
            
            const resolutionSelect = document.getElementById('resolution-reason');
            if (resolutionSelect) {
                resolutionSelect.value = '';
            }
            
            const resolveButton = document.querySelector('[data-cy="resolve-alert"]');
            if (resolveButton) {
                resolveButton.disabled = false;
                resolveButton.classList.remove('btn-secondary');
                resolveButton.classList.add('btn-danger');
            }
            
            const container = document.querySelector('.container');
            if (container) {
                container.classList.remove('alert-resolved');
            }
            
            const resolutionBadge = document.getElementById('resolution-status');
            if (resolutionBadge) {
                resolutionBadge.textContent = 'Pending';
                resolutionBadge.classList.remove('completed');
            }
            
            protocolState.alertResolved = false;
        }

        // Global timer functions
        function startGlobalTimer(stepId, description, contactName, duration = 1800) {
            if (globalTimerInterval) {
                console.warn('⚠️ Another timer was active - cancelling it first');
                clearInterval(globalTimerInterval);
                addLogEntry(`⏹️ Cancelled previous timer`, 'timer');
            }
            
            activeTimerData = {
                stepId: stepId,
                description: description,
                contactName: contactName,
                duration: duration,
                startTime: Date.now()
            };
            
            updateTimerDisplay(duration);
            updateTimerInfo(description, contactName);
            activateTimer();
            
            addLogEntry(`⏰ Started ${duration/60}-minute timer: ${description} for ${contactName}`, 'timer');
            
            globalTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - activeTimerData.startTime) / 1000);
                const remaining = Math.max(0, duration - elapsed);
                
                updateTimerDisplay(remaining);
                
                if (remaining <= 0) {
                    timerComplete();
                } else if (remaining <= 300) {
                    document.getElementById('globalTimer').classList.add('timer-alert');
                }
            }, 1000);
        }

        function cancelGlobalTimer() {
            if (globalTimerInterval) {
                clearInterval(globalTimerInterval);
                globalTimerInterval = null;
                
                if (activeTimerData) {
                    addLogEntry(`⏹️ Cancelled timer: ${activeTimerData.description}`, 'timer');
                    activeTimerData = null;
                }
                
                deactivateTimer();
            }
        }

        function updateTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            document.getElementById('timerDisplay').textContent = display;
            
            const timerStart = document.getElementById('timerStart');
            const timerEnd = document.getElementById('timerEnd');
            
            if (activeTimerData) {
                const startTime = new Date(activeTimerData.startTime).toLocaleTimeString('en-US', {
                    hour12: false, 
                    timeZone: 'America/Chicago',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const endTime = new Date(activeTimerData.startTime + activeTimerData.duration * 1000).toLocaleTimeString('en-US', {
                    hour12: false, 
                    timeZone: 'America/Chicago',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                timerStart.textContent = startTime;
                timerEnd.textContent = endTime;
            }
        }

        function updateTimerInfo(description, contactName) {
            const info = document.getElementById('timerInfo');
            info.innerHTML = `<strong>${description}</strong><br>${contactName}`;
        }

        function activateTimer() {
            const timer = document.getElementById('globalTimer');
            const cancelBtn = document.getElementById('cancelTimerBtn');
            
            timer.classList.remove('timer-inactive');
            timer.classList.add('timer-active');
            cancelBtn.disabled = false;
        }

        function deactivateTimer() {
            const timer = document.getElementById('globalTimer');
            const cancelBtn = document.getElementById('cancelTimerBtn');
            
            timer.classList.remove('timer-active', 'timer-alert');
            timer.classList.add('timer-inactive');
            cancelBtn.disabled = true;
            
            document.getElementById('timerDisplay').textContent = '--:--';
            document.getElementById('timerInfo').innerHTML = '<strong>No active timer</strong>';
            document.getElementById('timerStart').textContent = '--:--';
            document.getElementById('timerEnd').textContent = '--:--';
            
            // FIXED: Reset tab title when timer is deactivated
            stopTabFlashing();
        }

        function timerComplete() {
            clearInterval(globalTimerInterval);
            globalTimerInterval = null;
            
            if (activeTimerData) {
                const globalTimer = document.getElementById('globalTimer');
                flashTimerArea(globalTimer, null, null);
                playTimerSound();
                startTabFlashing("🚨 TIMER EXPIRED");
                
                addLogEntry(`⏰ TIMER EXPIRED: ${activeTimerData.description} for ${activeTimerData.contactName}`, 'timer');
            }
            
            const notification = document.getElementById('timerNotification');
            const notificationText = document.getElementById('timerNotificationText');
            
            if (activeTimerData) {
                notificationText.textContent = `${activeTimerData.description} timer has expired.`;
            }
            
            notification.style.display = 'block';
            deactivateTimer();
            activeTimerData = null;
        }

        // Utility functions
        function formatAlertTime(dateString) {
            const alertDate = new Date(dateString);
            const now = new Date();
            const diffMinutes = Math.floor((now - alertDate) / 60000);
            
            const timeStr = alertDate.toLocaleDateString('en-US', {
                month: '2-digit',
                day: '2-digit',
                year: 'numeric'
            }) + ' ' + alertDate.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }) + ' CDT';
            
            let timeAgo = '';
            if (diffMinutes === 1) timeAgo = '(-1 minute ago)';
            else if (diffMinutes < 60) timeAgo = `(-${diffMinutes} minutes ago)`;
            else if (diffMinutes < 1440) timeAgo = `(-${Math.floor(diffMinutes/60)} hours ago)`;
            else timeAgo = `(-${Math.floor(diffMinutes/1440)} days ago)`;
            
            return `${timeStr} ${timeAgo}`;
        }

        function dismissNotification() {
            const notification = document.getElementById('timerNotification');
            if (notification) {
                notification.style.display = 'none';
            }
            stopTabFlashing();
        }

        function flashTimerArea(element, textElement, newText) {
            if (!element) return;
            
            element.style.animation = 'flashRed 1s infinite';
            
            if (textElement && newText) {
                textElement.textContent = newText;
            }
            
            setTimeout(() => {
                element.style.animation = '';
            }, 10000);
        }

        function playTimerSound() {
            clearBeepTimeouts();
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                beepTimeouts.push(setTimeout(() => playBeep(audioContext), 0));
                beepTimeouts.push(setTimeout(() => playBeep(audioContext), 300));
                beepTimeouts.push(setTimeout(() => playBeep(audioContext), 600));
                
            } catch (e) {
                console.log('Audio not available');
            }
        }

        function clearBeepTimeouts() {
            beepTimeouts.forEach(timeout => clearTimeout(timeout));
            beepTimeouts = [];
        }

        function playBeep(audioContext) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        // FIXED: Tab title management with proper cleanup
        function startTabFlashing(alertText) {
            stopTabFlashing();
            
            let isAlert = false;
            tabFlashInterval = setInterval(() => {
                document.title = isAlert ? originalTitle : alertText;
                isAlert = !isAlert;
            }, 1000);
        }

        function stopTabFlashing() {
            if (tabFlashInterval) {
                clearInterval(tabFlashInterval);
                tabFlashInterval = null;
                document.title = originalTitle;
            }
        }
    </script>
</body>
</html>